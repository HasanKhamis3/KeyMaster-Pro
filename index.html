<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; --info: #17a2b8; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }

        /* Settings Specific */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Image Upload Box */
        .upload-container { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .upload-btn-custom { background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .image-preview-wrapper { margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        .remove-img-btn { position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Visitor & Logs */
        .visitor-section { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: white; }
        .visitor-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; background: #fff; transition: 0.2s; }
        .btn-add-visitor { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .log-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }

        /* Filters */
        .filter-controls { display: flex; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; align-items: center; }
        .filter-select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; min-width: 150px; font-family: inherit; }

        /* Dashboard & Charts */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 4px solid var(--primary); display: flex; flex-direction: column; justify-content: center; }
        .stat-card h4 { margin: 0 0 10px 0; color: #666; font-size: 0.9rem; }
        .stat-card .value { font-size: 1.8rem; font-weight: bold; color: var(--text); }
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-wrapper { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-header { font-weight: bold; margin-bottom: 15px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }

        @media (max-width: 1000px) { .charts-container { grid-template-columns: 1fr; } }
        @media print { .sidebar, .login-wrapper { display: none; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <img src="https://www.moe.gov.bh/img/logo.png" width="80" style="margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">تسجيل الدخول</h2>
            <form id="loginForm">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div style="position:relative; margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required style="padding-left:40px;">
                    <i class="fas fa-eye" onclick="togglePass('loginPass', this)" style="position:absolute; left:10px; top:12px; cursor:pointer; color:#777;"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <p id="loginError" style="color:red; font-size:0.9rem; margin-top:10px; display:none; line-height:1.6; font-weight:bold;"></p>
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px;">
                    <button type="button" class="btn" style="background:#6c757d; color:white; font-size:0.7rem; padding:5px 10px;" onclick="resetSystem()">إعادة ضبط المصنع (Reset)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">جودة التعليم</div><small style="color:#888;">وزارة التربية</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير الجودة</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">لوحة التحكم</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active">
                <h3>لوحة التحكم</h3>
                <p>مرحباً بك في نظام متابعة جودة التعليم.</p>
            </div>
            
            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportCSV()"><i class="fas fa-file-export"></i> تصدير CSV</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>

                <table class="custom-table">
                    <thead><tr id="tableHeadRow"></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>

                <div class="filter-controls">
                    <label style="font-weight:bold;"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر (عرض كامل)</option>
                        <option value="0">يناير</option>
                        <option value="1">فبراير</option>
                        <option value="2">مارس</option>
                        <option value="3">أبريل</option>
                        <option value="4">مايو</option>
                        <option value="5">يونيو</option>
                        <option value="6">يوليو</option>
                        <option value="7">أغسطس</option>
                        <option value="8">سبتمبر</option>
                        <option value="9">أكتوبر</option>
                        <option value="10">نوفمبر</option>
                        <option value="11">ديسمبر</option>
                    </select>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="15%">التاريخ</th>
                            <th width="15%">القسم</th>
                            <th width="20%">اسم المعلمة</th>
                            <th width="15%">التقييم</th>
                            <th width="20%">الزائر</th>
                            <th width="15%">وظيفة الزائر</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody"></tbody>
                </table>
            </div>

            <div id="performance" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>تقييم الأداء (لوحة المؤشرات)</h3>
                    
                    <div style="display:flex; align-items:center; gap:10px;">
                         <label style="font-weight:bold;">الشهر:</label>
                         <select id="perfMonthFilter" class="filter-select" onchange="renderPerformanceDashboard()">
                            <option value="all">الكل</option>
                            <option value="0">يناير</option>
                            <option value="1">فبراير</option>
                            <option value="2">مارس</option>
                            <option value="3">أبريل</option>
                            <option value="4">مايو</option>
                            <option value="5">يونيو</option>
                            <option value="8">سبتمبر</option>
                            <option value="9">أكتوبر</option>
                            <option value="10">نوفمبر</option>
                            <option value="11">ديسمبر</option>
                         </select>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="border-right-color:#2c5aa0;">
                        <h4>إجمالي الزيارات</h4>
                        <div class="value" id="stat_total_visits">0</div>
                    </div>
                    <div class="stat-card" style="border-right-color:#28a745;">
                        <h4>القسم الأكثر نشاطاً</h4>
                        <div class="value" id="stat_top_dept" style="font-size:1.2rem;">-</div>
                    </div>
                    <div class="stat-card" style="border-right-color:#ffc107;">
                        <h4>المعلمة الأكثر زيارة</h4>
                        <div class="value" id="stat_top_teacher" style="font-size:1.2rem;">-</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-wrapper">
                        <div class="chart-header">تحليل توزيع التقييمات</div>
                        <canvas id="evalChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-header">نسبة الزيارات حسب الأقسام</div>
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="quality-report" class="section-card"><h3>تقرير الجودة</h3><p>يمكن إضافة محتوى التقرير النصي هنا.</p></div>
            
            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>

                <div id="gen" class="setting-content-pane active">
                    <div class="form-group" style="margin-bottom:20px;"><label class="upload-label">اسم المدرسة</label><input type="text" id="confSchool" class="form-control"></div>
                     <div class="form-group" style="margin-bottom:20px;"><label class="upload-label">العام الدراسي</label><input type="text" id="confYear" class="form-control"></div>
                     <button class="btn btn-primary" onclick="saveGeneralSettings()">حفظ الإعدادات العامة</button>
                </div>
                <div id="sig" class="setting-content-pane">
                     <p>اختر من القوائم (نفس الكود السابق)</p>
                     <select id="sig_director" class="form-control"></select>
                     <select id="sig_assistant" class="form-control" style="margin-top:10px;"></select>
                     <button class="btn btn-primary" onclick="saveSignatureSettings()" style="margin-top:10px;">حفظ</button>
                </div>
                <div id="fot" class="setting-content-pane">
                     <textarea id="footer_text" class="form-control"></textarea>
                     <button class="btn btn-primary" onclick="saveFooterSettings()" style="margin-top:10px;">حفظ التذييل</button>
                </div>
                <div id="eval" class="setting-content-pane">
                    <button class="btn btn-primary" onclick="openAddEvalModal()">+ إضافة معيار</button>
                    <table class="custom-table" style="margin-top:10px;"><tbody id="evalTableBody"></tbody></table>
                </div>
                <div id="vis" class="setting-content-pane">
                     <div class="visitor-section"><h5>القيادة العليا</h5><ul id="list_visitor_senior" class="visitor-list"></ul><button class="btn-add-visitor" onclick="openVisitorPicker('senior')">+ إضافة</button></div>
                     <div class="visitor-section"><h5>القيادة الوسطى</h5><ul id="list_visitor_middle" class="visitor-list"></ul><button class="btn-add-visitor" onclick="openVisitorPicker('middle')">+ إضافة</button></div>
                     <button class="btn btn-toggle" onclick="saveVisitorOrder()">حفظ الترتيب</button>
                </div>
                <div id="log" class="setting-content-pane">
                    <button class="btn btn-primary" onclick="loadSystemLogs()">تحديث</button>
                    <div class="log-table-wrapper"><table class="custom-table"><tbody id="logTableBody"></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="addUserModalTitle">إضافة</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم / القسم</label><input type="text" id="addName" class="form-control" required>
                    <div id="deptWrapper" style="display:none;"><label>القسم</label><select id="addDept" class="form-control"></select></div>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveUserForm()">حفظ</button><button class="btn" onclick="closeModal('addUserModal')">إلغاء</button></div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة زيارة</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addVisitForm">
                    <label>القسم</label><select id="visitDept" class="form-control" onchange="onVisitDeptChange()"></select>
                    <label>المعلم/ة</label><select id="visitTeacher" class="form-control"></select>
                    <label>التاريخ</label><input type="date" id="visitDate" class="form-control">
                    <label>التقييم</label><select id="visitEval" class="form-control"></select>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveVisit()">حفظ</button><button class="btn" onclick="closeModal('addVisitModal')">إلغاء</button></div>
        </div>
    </div>
    
    <div id="addEvalModal" class="modal-overlay">
        <div class="modal-box">
             <div class="modal-header">معيار تقييم</div>
             <div class="modal-body"><input type="hidden" id="editEvalId"><label>الاسم</label><input id="evalName" class="form-control"></div>
             <div class="modal-footer"><button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button><button class="btn" onclick="closeModal('addEvalModal')">إلغاء</button></div>
        </div>
    </div>
    
    <div id="permModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">الصلاحيات</div>
            <div class="modal-body"><h4 id="permTargetName"></h4><div id="permList"></div></div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="submitPermissions()">حفظ</button><button class="btn" onclick="closeModal('permModal')">إلغاء</button></div>
        </div>
    </div>

    <div id="visitorPickerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">بحث</div>
            <div class="modal-body"><input id="visitorSearch" class="form-control" onkeyup="filterPickerList()"><div id="pickerList" class="picker-list"></div></div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('visitorPickerModal')">إغلاق</button></div>
        </div>
    </div>

    <script>
        // === System Core ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'quality-report', name: 'تقرير الجودة'},
            {id: 'settings', name: 'الإعدادات'}
        ];
        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [], teachers: [], departments: [],
            visits_senior: [], visits_middle: [],
            settings: {
                schoolName: 'مدرسة مدينة حمد الابتدائية للبنات', schoolYear: '2025 / 2026م',
                ministryLogo: '', schoolLogo: '', schoolStamp: '',
                signature_director_id: '', signature_assistant_id: '',
                visitor_order_senior: [], visitor_order_middle: [],
                footer_text: '', footer_align: 'center', footer_fontsize: '12',
                evaluation_criteria: [
                    {id: 1, name: 'ممتاز', status: 'active'},
                    {id: 2, name: 'جيد جداً', status: 'active'},
                    {id: 3, name: 'جيد', status: 'active'},
                    {id: 4, name: 'مرضِ', status: 'active'},
                    {id: 5, name: 'غير مرضِ', status: 'active'}
                ]
            },
            logs: []
        };

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior';
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;

        // --- Chart instances (global to allow destroy) ---
        let evalChartInstance = null;
        let deptChartInstance = null;

        function initSystem() {
            const storedDB = localStorage.getItem('QualitySys_DB_V2');
            if (storedDB) {
                DB = JSON.parse(storedDB);
                if(!DB.visits_senior) DB.visits_senior = [];
                if(!DB.visits_middle) DB.visits_middle = [];
                // Merge default evaluation criteria if missing
                if(!DB.settings.evaluation_criteria || DB.settings.evaluation_criteria.length === 0) {
                     DB.settings.evaluation_criteria = INITIAL_DB.settings.evaluation_criteria;
                }
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                // Set Admin Full Perms
                SECTIONS.forEach(sec => { DB.admins[0].permissions[sec.id] = {view: true, edit: true}; });
                saveDB();
            }

            const sessionID = localStorage.getItem('QualitySys_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) { const u = DB[grp].find(x => x.id == sessionID); if(u) found = u; }
                });
                if (found && found.status === 'active') { CURRENT_USER = found; showApp(); }
                else { document.getElementById('loginPage').style.display = 'flex'; }
            } else { document.getElementById('loginPage').style.display = 'flex'; }
        }

        function saveDB() { localStorage.setItem('QualitySys_DB_V2', JSON.stringify(DB)); }

        function login(e) {
            e.preventDefault();
            const uInput = document.getElementById('loginUser').value.trim();
            const pInput = document.getElementById('loginPass').value.trim();
            let userFound = null;
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                if(DB[grp]) { const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput); if(match) userFound = match; }
            });

            if (userFound && userFound.status === 'active') {
                CURRENT_USER = userFound;
                localStorage.setItem('QualitySys_Session', userFound.id);
                showApp();
            } else {
                document.getElementById('loginError').innerText = "بيانات غير صحيحة أو حساب معطل";
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() { localStorage.removeItem('QualitySys_Session'); location.reload(); }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || '';
            applySidebarPermissions();
            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
            });
        }

        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، لا تملك صلاحية."); return; }
            
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');

            if(pageId === 'user-management') renderTable();
            if(pageId === 'visits') renderVisitsTable();
            if(pageId === 'performance') renderPerformanceDashboard();
            if(pageId === 'settings') loadSettings();
        }

        // --- User Management Logic (Simplified for brevity as focus is on new features) ---
        function setTab(tab, el) { CURRENT_TAB = tab; updateTabsUI(el); renderTable(); }
        function updateTabsUI(el) { document.querySelectorAll('.custom-tab').forEach(t => { if(t.parentElement === el.parentElement) t.classList.remove('active'); }); el.classList.add('active'); }
        
        function renderTable() {
            const tbody = document.getElementById('usersTableBody'); tbody.innerHTML = '';
            const list = DB[CURRENT_TAB] || [];
            list.forEach((u, idx) => {
                const tr = document.createElement('tr');
                let actions = `<button class="action-btn btn-edit" onclick="editUser(${u.id})">تعديل</button><button class="action-btn btn-delete" onclick="deleteUser(${u.id})">حذف</button>`;
                if(CURRENT_TAB !== 'departments') actions += `<button class="action-btn btn-perm" onclick="openPerms(${u.id})">صلاحيات</button>`;
                tr.innerHTML = `<td><input type="checkbox" class="user-select-cb" value="${u.id}"></td><td>${idx+1}</td><td>${u.name}</td><td>${u.job||u.dept||'-'}</td><td>${u.status}</td><td>${actions}</td>`;
                tbody.appendChild(tr);
            });
        }
        
        // --- Add/Edit User Functions (Standard CRUD - omitted details for length) ---
        function openAddUserModal() { document.getElementById('addUserForm').reset(); document.getElementById('editUserId').value=''; document.getElementById('addUserModal').style.display='flex'; /* Populate Depts if needed */ populateDeptsDropdown(); }
        function populateDeptsDropdown() {
             const s = document.getElementById('addDept'); s.innerHTML='<option value="">اختر...</option>';
             (DB.departments||[]).forEach(d=>s.innerHTML+=`<option value="${d.name}">${d.name}</option>`);
        }
        function saveUserForm() {
            const id = document.getElementById('editUserId').value;
            const name = document.getElementById('addName').value;
            const u = {id: id?Number(id):Date.now(), name: name, status:'active', permissions:JSON.parse(JSON.stringify(DEFAULT_PERMS))};
            // Add other fields...
            if(CURRENT_TAB==='teachers') u.dept = document.getElementById('addDept').value;
            else { u.job = document.getElementById('addJob').value; u.login=document.getElementById('addLogin').value; u.pass=document.getElementById('addPass').value; }
            
            if(id) { const idx = DB[CURRENT_TAB].findIndex(x=>x.id==id); DB[CURRENT_TAB][idx]={...DB[CURRENT_TAB][idx], ...u}; }
            else DB[CURRENT_TAB].push(u);
            saveDB(); closeModal('addUserModal'); renderTable();
        }
        function deleteUser(id) { if(confirm('حذف؟')) { DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(x=>x.id!=id); saveDB(); renderTable(); } }
        function editUser(id) { 
            const u = DB[CURRENT_TAB].find(x=>x.id==id); 
            document.getElementById('editUserId').value=u.id; document.getElementById('addName').value=u.name; 
            if(u.job) document.getElementById('addJob').value=u.job;
            /* set other fields */ 
            document.getElementById('addUserModal').style.display='flex'; 
        }

        // --- Visits Logic ---
        function setVisitTab(tab, el) { CURRENT_VISIT_TAB = tab; updateTabsUI(el); renderVisitsTable(); }
        
        // Helper to get current job
        function getVisitorJob(visitorId) {
            let user = null;
            ['admins', 'senior', 'middle'].forEach(grp => {
                if(!user && DB[grp]) user = DB[grp].find(u => u.id == visitorId);
            });
            return user ? (user.job || user.dept || 'غير محدد') : 'غير معروف';
        }

        function renderVisitsTable() {
            const tbody = document.getElementById('visitsTableBody'); tbody.innerHTML = '';
            let list = (CURRENT_VISIT_TAB === 'senior') ? (DB.visits_senior || []) : (DB.visits_middle || []);
            
            // Filter Logic
            const monthFilter = document.getElementById('visitMonthFilter').value;
            if (monthFilter !== 'all') {
                list = list.filter(v => {
                    const d = new Date(v.date);
                    return d.getMonth() == monthFilter;
                });
            }

            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; color:#888;">لا توجد زيارات</td></tr>'; return; }
            
            list.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort by date desc

            list.forEach(v => {
                // Fetch dynamic job
                const currentJob = getVisitorJob(v.visitorId);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${v.date}</td><td>${v.dept}</td><td style="font-weight:bold;">${v.teacher}</td>
                                <td><span class="status-badge status-active" style="background:#eef; color:var(--primary);">${v.eval}</span></td>
                                <td>${v.visitorName}</td><td>${currentJob}</td>`;
                tbody.appendChild(tr);
            });
        }

        function openAddVisitModal() {
            document.getElementById('addVisitForm').reset();
            const dSel = document.getElementById('visitDept'); dSel.innerHTML='<option value="">اختر القسم...</option>';
            (DB.departments||[]).forEach(d=>dSel.innerHTML+=`<option value="${d.name}">${d.name}</option>`);
            const eSel = document.getElementById('visitEval'); eSel.innerHTML='<option value="">اختر...</option>';
            (DB.settings.evaluation_criteria||[]).forEach(e=>{ if(e.status==='active') eSel.innerHTML+=`<option value="${e.name}">${e.name}</option>`; });
            document.getElementById('addVisitModal').style.display='flex';
        }

        function onVisitDeptChange() {
             const d = document.getElementById('visitDept').value;
             const tSel = document.getElementById('visitTeacher'); tSel.innerHTML='<option value="">اختر...</option>';
             if(d && DB.teachers) DB.teachers.filter(t=>t.dept===d).forEach(t=>tSel.innerHTML+=`<option value="${t.name}">${t.name}</option>`);
        }

        function saveVisit() {
            const v = {
                id: Date.now(),
                dept: document.getElementById('visitDept').value,
                teacher: document.getElementById('visitTeacher').value,
                date: document.getElementById('visitDate').value,
                eval: document.getElementById('visitEval').value,
                visitorName: CURRENT_USER.name,
                visitorId: CURRENT_USER.id
            };
            if(!v.dept || !v.teacher || !v.date || !v.eval) { alert('أكمل البيانات'); return; }
            
            // Determine storage based on user group (simple check)
            let isMiddle = false;
            if(DB.middle && DB.middle.some(u=>u.id===CURRENT_USER.id)) isMiddle=true;
            
            if(isMiddle) { if(!DB.visits_middle) DB.visits_middle=[]; DB.visits_middle.push(v); }
            else { if(!DB.visits_senior) DB.visits_senior=[]; DB.visits_senior.push(v); }
            
            saveDB(); closeModal('addVisitModal'); renderVisitsTable();
        }

        // --- Performance Dashboard Logic ---
        function renderPerformanceDashboard() {
            const monthFilter = document.getElementById('perfMonthFilter').value;
            
            // Combine all visits for stats
            let allVisits = [...(DB.visits_senior||[]), ...(DB.visits_middle||[])];
            
            // Apply Filter
            if (monthFilter !== 'all') {
                allVisits = allVisits.filter(v => new Date(v.date).getMonth() == monthFilter);
            }

            // 1. Stats Cards
            document.getElementById('stat_total_visits').innerText = allVisits.length;
            
            // Top Dept
            const deptCounts = {};
            allVisits.forEach(v => { deptCounts[v.dept] = (deptCounts[v.dept] || 0) + 1; });
            let topDept = '-'; let maxD = 0;
            for(let d in deptCounts) { if(deptCounts[d] > maxD) { maxD = deptCounts[d]; topDept = d; } }
            document.getElementById('stat_top_dept').innerText = topDept;

            // Top Teacher
            const teachCounts = {};
            allVisits.forEach(v => { teachCounts[v.teacher] = (teachCounts[v.teacher] || 0) + 1; });
            let topTeach = '-'; let maxT = 0;
            for(let t in teachCounts) { if(teachCounts[t] > maxT) { maxT = teachCounts[t]; topTeach = t; } }
            document.getElementById('stat_top_teacher').innerText = topTeach;

            // 2. Evaluation Chart (Bar)
            const evalCounts = {};
            allVisits.forEach(v => { evalCounts[v.eval] = (evalCounts[v.eval] || 0) + 1; });
            const evalLabels = Object.keys(evalCounts);
            const evalData = Object.values(evalCounts);

            const ctxEval = document.getElementById('evalChart').getContext('2d');
            if(evalChartInstance) evalChartInstance.destroy();
            
            evalChartInstance = new Chart(ctxEval, {
                type: 'bar',
                data: {
                    labels: evalLabels,
                    datasets: [{
                        label: 'عدد الزيارات',
                        data: evalData,
                        backgroundColor: '#1e4078',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: {display: false} },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });

            // 3. Dept Chart (Doughnut)
            const deptLabels = Object.keys(deptCounts);
            const deptData = Object.values(deptCounts);
            const bgColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#e83e8c'];
            
            const ctxDept = document.getElementById('deptChart').getContext('2d');
            if(deptChartInstance) deptChartInstance.destroy();

            deptChartInstance = new Chart(ctxDept, {
                type: 'doughnut',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        data: deptData,
                        backgroundColor: bgColors.slice(0, deptLabels.length)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- Utils ---
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function togglePass(id, icon) {
            const x = document.getElementById(id);
            if(x.type==='password'){x.type='text';icon.classList.remove('fa-eye');icon.classList.add('fa-eye-slash');}
            else{x.type='password';icon.classList.remove('fa-eye-slash');icon.classList.add('fa-eye');}
        }
        function resetSystem() { if(confirm('حذف الكل؟')) { localStorage.removeItem('QualitySys_DB_V2'); localStorage.removeItem('QualitySys_Session'); location.reload(); } }

        // Start
        document.getElementById('loginForm').addEventListener('submit', login);
        initSystem();

    </script>
</body>
</html>
