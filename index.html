<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; --info: #17a2b8; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; border: 1px solid #1e4078; }
        .custom-table td { padding: 8px; border: 1px solid #ddd; background: white; text-align: center; vertical-align: middle; }
        
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }

        /* --- Settings Specific Styles --- */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Image Upload Box Style */
        .upload-container {
            border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; transition: 0.3s;
        }
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .upload-btn-wrapper { margin-top: 10px; }
        .upload-btn-custom {
            background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px;
        }
        .upload-hint { display: block; margin-top: 5px; color: #888; font-size: 0.8rem; }
        .image-preview-wrapper {
            margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        .remove-img-btn {
            position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Signature Settings Styles --- */
        .signature-grid { display: flex; flex-direction: column; gap: 20px; }
        .signature-card { border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #fcfcfc; text-align: center; width: 100%; }
        .signature-title { color: var(--primary); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        
        /* --- Visitor Order Styles --- */
        .visitor-section { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: white; }
        .visitor-section-title { font-weight: bold; margin-bottom: 15px; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .visitor-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .visitor-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; background: #fff;
            transition: 0.2s;
        }
        .visitor-list-item:hover { background-color: #f9fbff; border-color: #cce5ff; }
        .visitor-name { font-weight: bold; color: #333; }
        .visitor-controls { display: flex; gap: 5px; }
        .empty-list-msg { color: #888; font-style: italic; padding: 15px; text-align: center; border: 1px dashed #ddd; border-radius: 6px; background: #fdfdfd; }
        .btn-add-visitor { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add-visitor:hover { opacity: 0.9; }

        /* --- System Log Styles --- */
        .log-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .log-details { font-size: 0.85rem; color: #666; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Picker Modal List */
        .picker-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .picker-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .picker-item:hover { background-color: #f0f4f8; }
        .picker-item:last-child { border-bottom: none; }
        .picker-item-name { font-weight: bold; }
        .picker-item-job { font-size: 0.8rem; color: #777; }

        /* Password Wrapper */
        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 40px; }
        .password-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }
        
        /* Permissions List */
        .perm-list { border: 1px solid #eee; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .perm-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .perm-header { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        
        /* User View */
        .user-view-card { text-align: center; margin-bottom: 20px; }
        .user-view-avatar { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-item label { display: block; color: #777; font-size: 0.85rem; margin-bottom: 5px; }
        .info-item span { font-weight: bold; color: #333; }

        /* Performance Report Styles */
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; height: 400px; position: relative; }
        .performance-table-wrapper { overflow-x: auto; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 8px; }
        .month-filter-wrapper { display: flex; align-items: center; gap: 10px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; }

        @media print { .sidebar, .login-wrapper { display: none; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <img src="https://www.moe.gov.bh/img/logo.png" width="80" style="margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">تسجيل الدخول</h2>
            <form id="loginForm">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div class="password-wrapper" style="margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" onclick="togglePass('loginPass', this)"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <p id="loginError" style="color:red; font-size:0.9rem; margin-top:10px; display:none; line-height:1.6; font-weight:bold;"></p>
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px;">
                    <button type="button" class="btn" style="background:#6c757d; color:white; font-size:0.7rem; padding:5px 10px;" onclick="resetSystem()">إعادة ضبط المصنع (Reset)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">جودة التعليم</div><small style="color:#888;">وزارة التربية</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير الجودة</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">لوحة التحكم</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active"><h3>لوحة التحكم</h3><p>مرحباً بك في النظام</p></div>
            
            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportCSV()"><i class="fas fa-file-export"></i> تصدير CSV</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr id="tableHeadRow">
                            </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                </div>

                <div class="month-filter-wrapper">
                    <label style="font-weight:bold;">اختر الشهر:</label>
                    <select id="visitsMonthFilter" class="form-control" style="width:200px; margin:0;" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="1">يناير</option>
                        <option value="2">فبراير</option>
                        <option value="3">مارس</option>
                        <option value="4">أبريل</option>
                        <option value="5">مايو</option>
                        <option value="6">يونيو</option>
                        <option value="9">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="15%">التاريخ</th>
                            <th width="15%">القسم</th>
                            <th width="20%">اسم المعلمة</th>
                            <th width="15%">التقييم</th>
                            <th width="20%">الزائر</th>
                            <th width="15%">وظيفة الزائر</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                
                <div class="month-filter-wrapper">
                    <label style="font-weight:bold;">اختر الشهر للتقرير:</label>
                    <select id="perfMonthFilter" class="form-control" style="width:200px; margin:0;" onchange="renderPerformance()">
                        <option value="all">كل الأشهر</option>
                        <option value="1">يناير</option>
                        <option value="2">فبراير</option>
                        <option value="3">مارس</option>
                        <option value="4">أبريل</option>
                        <option value="5">مايو</option>
                        <option value="6">يونيو</option>
                        <option value="9">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>

                <div class="performance-table-wrapper">
                    <table class="custom-table" id="performanceTable">
                        </table>
                </div>
            </div>

            <div id="quality-report" class="section-card"><h3>تقرير الجودة</h3></div>
            
            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>
                <div id="gen" class="setting-content-pane active"><p style="color:#666; padding:10px;">(تم إخفاء المحتوى للاختصار - الكود الأصلي موجود هنا)</p></div>
                 <div id="sig" class="setting-content-pane"></div>
                 <div id="fot" class="setting-content-pane"></div>
                 <div id="eval" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                        <h3>الزيارة الصفية</h3>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn" style="background:#2c5aa0; color:white;" onclick="openAddEvalModal()"><i class="fas fa-plus"></i> إضافة تقييم</button>
                        </div>
                    </div>
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th width="10%">#</th>
                                <th width="55%">اسم المعيار</th>
                                <th width="10%">الحالة</th>
                                <th width="25%">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="evalTableBody"></tbody>
                    </table>
                 </div>
                 <div id="vis" class="setting-content-pane"></div>
                 <div id="log" class="setting-content-pane"></div>
            </div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
             <div class="modal-header"><span id="addUserModalTitle">إضافة</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
             <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required>
                    <div id="deptWrapper" class="form-group" style="display:none;">
                        <label>القسم</label>
                        <select id="addDept" class="form-control"></select>
                    </div>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                    </div>
                </form>
             </div>
             <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveUserForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button>
             </div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addVisitForm">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="visitDept" class="form-control" onchange="onVisitDeptChange()">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المعلم/ة</label>
                        <select id="visitTeacher" class="form-control">
                            <option value="">اختر المعلم/ة...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">تاريخ الزيارة</label>
                        <input type="date" id="visitDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقييم</label>
                        <select id="visitEval" class="form-control">
                            <option value="">اختر التقييم...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveVisit()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addEvalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addEvalForm">
                    <input type="hidden" id="editEvalId">
                    <label>اسم المعيار</label>
                    <input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="viewUserModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')">&times;</span></div><div class="modal-body" id="viewUserContent"></div><div class="modal-footer"><button class="btn" onclick="closeModal('viewUserModal')">إغلاق</button></div></div></div>
    <div id="permModal" class="modal-overlay"><div class="modal-box"><div class="modal-body"><div class="perm-list" id="permList"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitPermissions()">حفظ</button><button class="btn" onclick="closeModal('permModal')">إلغاء</button></div></div></div>
    <div id="visitorPickerModal" class="modal-overlay"><div class="modal-box"><div class="modal-body"><input id="visitorSearch"><div id="pickerList"></div></div><div class="modal-footer"><button class="btn" onclick="closeModal('visitorPickerModal')">إلغاء</button></div></div></div>

    <script>
        // === System Configuration ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'quality-report', name: 'تقرير الجودة'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [],
            teachers: [],
            departments: [],
            visits_senior: [], 
            visits_middle: [], 
            settings: {
                schoolName: 'مدرسة مدينة حمد الابتدائية للبنات',
                schoolYear: '2025 / 2026م',
                ministryLogo: '',
                schoolLogo: '',
                schoolStamp: '',
                signature_director_id: '',
                signature_assistant_id: '',
                visitor_order_senior: [],
                visitor_order_middle: [],
                footer_text: '',
                footer_align: 'center',
                footer_fontsize: '12',
                evaluation_criteria: [
                    {id: 1, name: 'يفوق التوقعات بكثير', status: 'active'},
                    {id: 2, name: 'يفوق التوقعات', status: 'active'},
                    {id: 3, name: 'يفي بالتوقعات', status: 'active'},
                    {id: 4, name: 'يفي بالتوقعات جزئياً', status: 'active'}
                ]
            },
            logs: []
        };

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior';
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;
        let performanceChartInstance = null; // For Chart.js

        // === Core Functions ===
        function initSystem() {
            const storedDB = localStorage.getItem('QualitySys_DB_V2');
            if (storedDB) {
                DB = JSON.parse(storedDB);
                if(!DB.departments) DB.departments = [];
                if(!DB.settings) DB.settings = {};
                DB.settings = {...INITIAL_DB.settings, ...DB.settings};
                if(!DB.settings.evaluation_criteria) DB.settings.evaluation_criteria = INITIAL_DB.settings.evaluation_criteria;
                if(!DB.logs) DB.logs = [];
                if(!DB.visits_senior) DB.visits_senior = [];
                if(!DB.visits_middle) DB.visits_middle = [];
                
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) DB[grp].forEach(u => { if(!u.status) u.status = 'active'; });
                });
                
                saveDB();
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                const adm = DB.admins[0];
                SECTIONS.forEach(sec => { adm.permissions[sec.id] = {view: true, edit: true}; });
                saveDB();
            }

            const sessionID = localStorage.getItem('QualitySys_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) {
                        const u = DB[grp].find(x => x.id == sessionID);
                        if(u) found = u;
                    }
                });
                if (found && found.status === 'active') { CURRENT_USER = found; showApp(); }
                else { document.getElementById('loginPage').style.display = 'flex'; }
            } else { document.getElementById('loginPage').style.display = 'flex'; }
        }

        function saveDB() { localStorage.setItem('QualitySys_DB_V2', JSON.stringify(DB)); }

        // --- Logger Helper ---
        function addSystemLog(action, details) {
            const logEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('en-GB'),
                user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر',
                action: action,
                details: details
            };
            if(!DB.logs) DB.logs = [];
            DB.logs.unshift(logEntry);
            if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500);
            saveDB();
        }

        function login(e) {
            e.preventDefault();
            const errBox = document.getElementById('loginError');
            errBox.style.display = 'none';
            const uInput = document.getElementById('loginUser').value.trim();
            const pInput = document.getElementById('loginPass').value.trim();
            let userFound = null;
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                if(DB[grp]) {
                    const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput);
                    if(match) userFound = match;
                }
            });
            if (userFound) {
                if (userFound.status === 'active') {
                    CURRENT_USER = userFound;
                    localStorage.setItem('QualitySys_Session', userFound.id);
                    addSystemLog('تسجيل دخول', `المستخدم: ${userFound.name}`);
                    showApp();
                } else { errBox.innerText = "الحساب غير نشط."; errBox.style.display = 'block'; }
            } else { errBox.innerText = "بيانات غير صحيحة."; errBox.style.display = 'block'; }
        }

        function logout() { 
            if(CURRENT_USER) addSystemLog('تسجيل خروج', `المستخدم: ${CURRENT_USER.name}`);
            localStorage.removeItem('QualitySys_Session'); 
            location.reload(); 
        }

        function resetSystem() {
            if(confirm('تحذير: سيتم حذف كافة البيانات. هل أنت متأكد؟')) {
                localStorage.removeItem('QualitySys_DB_V2');
                localStorage.removeItem('QualitySys_Session');
                location.reload();
            }
        }

        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة."); return; }
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');
            
            if(pageId === 'settings') loadSettings();
            if(pageId === 'visits') renderVisitsTable();
            if(pageId === 'performance') renderPerformance(); // Render performance when tab is clicked
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم';
            applySidebarPermissions();
            renderTable(); // User mgmt table
            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
            });
        }

        // ... (User Management Functions: setTab, renderTable, etc. same as before) ...
        function setTab(tab, el) { CURRENT_TAB = tab; document.querySelectorAll('.custom-tab').forEach(t => { if(t.parentElement == el.parentElement) t.classList.remove('active'); }); el.classList.add('active'); renderTable(); }
        function renderTable() { /* Reused from previous code - simplified for brevity */ const tbody = document.getElementById('usersTableBody'); tbody.innerHTML = ''; const list = DB[CURRENT_TAB]||[]; list.forEach((u,i)=> { tbody.innerHTML += `<tr><td><input type='checkbox' class='user-select-cb' value='${u.id}'></td><td>${i+1}</td><td>${u.name}</td><td>${u.job||u.dept||'-'}</td><td>${u.status}</td><td>-</td></tr>`; }); }
        
        // ... (Settings Logic from previous code) ...
        function setSettingTab(t, el) { document.querySelectorAll('.setting-content-pane').forEach(p=>p.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('#settings .custom-tab').forEach(x=>x.classList.remove('active')); el.classList.add('active'); if(t==='eval') loadEvaluationSettings(); }
        function loadEvaluationSettings() {
             const tbody = document.getElementById('evalTableBody'); tbody.innerHTML = '';
             DB.settings.evaluation_criteria.forEach((item, idx) => {
                 tbody.innerHTML += `<tr><td>${idx+1}</td><td>${item.name}</td><td>${item.status}</td><td><button class="action-btn btn-delete" onclick="deleteEval(${item.id})">حذف</button></td></tr>`;
             });
        }
        function openAddEvalModal() { document.getElementById('addEvalForm').reset(); document.getElementById('addEvalModal').style.display = 'flex'; }
        function saveEvalForm() {
            const name = document.getElementById('evalName').value;
            DB.settings.evaluation_criteria.push({id: Date.now(), name: name, status: 'active'});
            saveDB(); loadEvaluationSettings(); closeModal('addEvalModal');
        }
        function deleteEval(id) { DB.settings.evaluation_criteria = DB.settings.evaluation_criteria.filter(x=>x.id!==id); saveDB(); loadEvaluationSettings(); }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // ============================================
        // === منطق الزيارات الصفية (Updated) ===
        // ============================================

        function setVisitTab(tab, el) {
            CURRENT_VISIT_TAB = tab;
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderVisitsTable();
        }

        function openAddVisitModal() {
            document.getElementById('addVisitForm').reset();
            const deptSel = document.getElementById('visitDept');
            deptSel.innerHTML = '<option value="">اختر القسم...</option>';
            if(DB.departments && DB.departments.length > 0) {
                DB.departments.forEach(d => { deptSel.appendChild(new Option(d.name, d.name)); });
            }
            const evalSel = document.getElementById('visitEval');
            evalSel.innerHTML = '<option value="">اختر التقييم...</option>';
            if(DB.settings.evaluation_criteria) {
                DB.settings.evaluation_criteria.forEach(e => {
                    if(e.status === 'active') evalSel.appendChild(new Option(e.name, e.name));
                });
            }
            document.getElementById('visitTeacher').innerHTML = '<option value="">اختر المعلم/ة...</option>';
            document.getElementById('addVisitModal').style.display = 'flex';
        }

        function onVisitDeptChange() {
            const selectedDept = document.getElementById('visitDept').value;
            const teacherSel = document.getElementById('visitTeacher');
            teacherSel.innerHTML = '<option value="">اختر المعلم/ة...</option>';
            if(selectedDept && DB.teachers) {
                DB.teachers.filter(t => t.dept === selectedDept && t.status === 'active').forEach(t => {
                    teacherSel.appendChild(new Option(t.name, t.name));
                });
            }
        }

        function saveVisit() {
            const dept = document.getElementById('visitDept').value;
            const teacher = document.getElementById('visitTeacher').value;
            const date = document.getElementById('visitDate').value;
            const evalVal = document.getElementById('visitEval').value;

            if(!dept || !teacher || !date || !evalVal) { alert('يرجى تعبئة جميع الحقول'); return; }

            const visitObj = {
                id: Date.now(),
                dept: dept,
                teacher: teacher,
                date: date, // Format YYYY-MM-DD
                eval: evalVal,
                visitorName: CURRENT_USER.name,
                visitorId: CURRENT_USER.id,
                visitorJob: CURRENT_USER.job || CURRENT_USER.dept // حفظ وظيفة الزائر
            };

            let isMiddle = (DB.middle && DB.middle.some(u => u.id === CURRENT_USER.id));

            if(isMiddle) {
                if(!DB.visits_middle) DB.visits_middle = [];
                DB.visits_middle.push(visitObj);
            } else {
                if(!DB.visits_senior) DB.visits_senior = [];
                DB.visits_senior.push(visitObj);
            }

            saveDB();
            renderVisitsTable();
            closeModal('addVisitModal');
            alert('تم حفظ الزيارة');
        }

        function renderVisitsTable() {
            const tbody = document.getElementById('visitsTableBody');
            tbody.innerHTML = '';
            
            // Get selected month from filter
            const monthFilter = document.getElementById('visitsMonthFilter').value;

            let list = [];
            if(CURRENT_VISIT_TAB === 'senior') list = DB.visits_senior || [];
            else list = DB.visits_middle || [];

            // Filter logic
            if(monthFilter !== 'all') {
                list = list.filter(v => {
                    const d = new Date(v.date);
                    return (d.getMonth() + 1) == monthFilter;
                });
            }

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; color:#888;">لا توجد زيارات مسجلة لهذا الشهر</td></tr>';
                return;
            }

            list.sort((a,b) => b.id - a.id);

            list.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.date}</td>
                    <td>${v.dept}</td>
                    <td style="font-weight:bold;">${v.teacher}</td>
                    <td><span class="status-badge status-active" style="background:#eef; color:var(--primary); border:1px solid #ccf;">${v.eval}</span></td>
                    <td>${v.visitorName}</td>
                    <td>${v.visitorJob || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============================================
        // === منطق تقييم الأداء (Performance Report) ===
        // ============================================

        function renderPerformance() {
            const monthFilter = document.getElementById('perfMonthFilter').value;
            const allVisits = [...(DB.visits_senior||[]), ...(DB.visits_middle||[])];
            
            // 1. Filter Visits
            const filteredVisits = monthFilter === 'all' ? allVisits : allVisits.filter(v => {
                return (new Date(v.date).getMonth() + 1) == monthFilter;
            });

            // 2. Aggregate Data by Department and Rating
            // Structure: { 'Math': { total: 5, 'Exceeds': 2, ... }, 'Science': ... }
            const stats = {};
            const evalCriteria = DB.settings.evaluation_criteria.filter(e => e.status === 'active');
            
            // Initialize departments from DB to ensure they appear even if 0 visits (optional, but good for reporting)
            // or just use departments present in visits. Let's use departments present in visits + DB.departments
            const allDepts = new Set([...(DB.departments||[]).map(d=>d.name), ...filteredVisits.map(v=>v.dept)]);
            
            allDepts.forEach(dept => {
                stats[dept] = { total: 0 };
                evalCriteria.forEach(ec => stats[dept][ec.name] = 0);
            });

            filteredVisits.forEach(v => {
                if(!stats[v.dept]) {
                    // In case a department was removed but visit exists
                    stats[v.dept] = { total: 0 };
                    evalCriteria.forEach(ec => stats[v.dept][ec.name] = 0);
                }
                stats[v.dept].total++;
                if(stats[v.dept][v.eval] !== undefined) {
                    stats[v.dept][v.eval]++;
                }
            });

            // 3. Render Table
            const table = document.getElementById('performanceTable');
            let thead = '<thead><tr><th width="5%">م</th><th>الأقسام الأكاديمية</th><th>مجموع عدد الزيارات</th>';
            evalCriteria.forEach(ec => {
                thead += `<th>${ec.name}</th>`;
            });
            thead += '</tr></thead>';
            
            let tbody = '<tbody>';
            let counter = 1;
            Object.keys(stats).forEach(dept => {
                // Skip if department has no visits? Or show 0? The image shows charts so usually meaningful data.
                // We show all to be complete.
                tbody += `<tr>
                    <td>${counter++}</td>
                    <td style="font-weight:bold;">${dept}</td>
                    <td style="background:#eef; font-weight:bold;">${stats[dept].total}</td>`;
                
                evalCriteria.forEach(ec => {
                    const count = stats[dept][ec.name];
                    tbody += `<td>${count}</td>`;
                });
                tbody += '</tr>';
            });
            tbody += '</tbody>';
            table.innerHTML = thead + tbody;

            // 4. Render Chart
            renderPerformanceChart(stats, evalCriteria);
        }

        function renderPerformanceChart(stats, evalCriteria) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const departments = Object.keys(stats);
            
            // Define colors based on keywords in evaluation name (approximate matching to image)
            const getColor = (name) => {
                if(name.includes('بكثير')) return '#28a745'; // Green
                if(name.includes('يفوق') && !name.includes('بكثير')) return '#17a2b8'; // Teal
                if(name.includes('يفي') && !name.includes('جزئياً')) return '#ffc107'; // Yellow
                if(name.includes('جزئياً') || name.includes('يحتاج')) return '#dc3545'; // Red
                return '#6c757d'; // Gray default
            };

            const datasets = evalCriteria.map(ec => {
                return {
                    label: ec.name,
                    data: departments.map(dept => stats[dept][ec.name]),
                    backgroundColor: getColor(ec.name),
                    borderWidth: 0,
                    borderRadius: 4,
                    barPercentage: 0.8,
                    categoryPercentage: 0.8
                };
            });

            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { family: "'Cairo', sans-serif" } }
                        }
                    }
                }
            });
        }

        // Trigger helpers
        function triggerFileSelect(id) { document.getElementById(id).click(); }
        function handleFileUpload(input, prevId, key) { /* existing logic */ }

        document.getElementById('loginForm').addEventListener('submit', login);
        initSystem();
    </script>
</body>
</html>
