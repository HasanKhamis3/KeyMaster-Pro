<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; }
        /* Sticky Header for Scrollable Tables */
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        /* Scrollable Table Wrapper Fix */
        .table-scroll-wrapper {
            max-height: 500px; /* تحديد ارتفاع ثابت */
            overflow-y: auto;  /* تفعيل التمرير العمودي */
            border: 1px solid #eee;
            border-radius: 6px;
            background: #fff;
        }

        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Filters */
        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 150px; font-weight: bold; color: var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }

        /* Settings, Uploads, Signatures, etc. */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .upload-container { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .upload-btn-wrapper { margin-top: 10px; }
        .upload-btn-custom { background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .upload-hint { display: block; margin-top: 5px; color: #888; font-size: 0.8rem; }
        .image-preview-wrapper { margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        .remove-img-btn { position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .signature-grid { display: flex; flex-direction: column; gap: 20px; }
        .signature-card { border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #fcfcfc; text-align: center; width: 100%; }
        .signature-title { color: var(--primary); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        
        .visitor-section { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: white; }
        .visitor-section-title { font-weight: bold; margin-bottom: 15px; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .visitor-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .visitor-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; background: #fff; transition: 0.2s; }
        .visitor-list-item:hover { background-color: #f9fbff; border-color: #cce5ff; }
        .visitor-name { font-weight: bold; color: #333; }
        .visitor-controls { display: flex; gap: 5px; }
        .empty-list-msg { color: #888; font-style: italic; padding: 15px; text-align: center; border: 1px dashed #ddd; border-radius: 6px; background: #fdfdfd; }
        .btn-add-visitor { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .log-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .log-details { font-size: 0.85rem; color: #666; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .picker-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .picker-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .picker-item:hover { background-color: #f0f4f8; }
        .picker-item-name { font-weight: bold; }
        .picker-item-job { font-size: 0.8rem; color: #777; }

        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 40px; }
        .password-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }
        
        .perm-list { border: 1px solid #eee; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .perm-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .perm-header { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        
        .user-view-card { text-align: center; margin-bottom: 20px; }
        .user-view-avatar { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-item label { display: block; color: #777; font-size: 0.85rem; margin-bottom: 5px; }
        .info-item span { font-weight: bold; color: #333; }

        @media print { .sidebar, .login-wrapper { display: none; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <img src="https://www.moe.gov.bh/img/logo.png" width="80" style="margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">تسجيل الدخول</h2>
            <form id="loginForm">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div class="password-wrapper" style="margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" onclick="togglePass('loginPass', this)"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <p id="loginError" style="color:red; font-size:0.9rem; margin-top:10px; display:none; line-height:1.6; font-weight:bold;"></p>
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px;">
                    <button type="button" class="btn" style="background:#6c757d; color:white; font-size:0.7rem; padding:5px 10px;" onclick="resetSystem()">إعادة ضبط المصنع (Reset)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">جودة التعليم</div><small style="color:#888;">وزارة التربية</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-special-teachers"><a onclick="navigate('special-teachers')" data-page="special-teachers"><i class="fas fa-star"></i> المعلمين المتميزين</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير الجودة</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">لوحة التحكم</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active"><h3>لوحة التحكم</h3><p>مرحباً بك في النظام</p></div>
            
            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportCSV()"><i class="fas fa-file-export"></i> تصدير CSV</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>

                <div class="table-scroll-wrapper">
                    <table class="custom-table">
                        <thead>
                            <tr id="tableHeadRow">
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                </div>

                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>

                <div class="table-scroll-wrapper">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th width="15%">التاريخ</th>
                                <th width="15%">القسم</th>
                                <th width="20%">اسم المعلمة</th>
                                <th width="15%">التقييم</th>
                                <th width="20%">الزائر</th>
                                <th width="15%">وظيفة الزائر</th>
                            </tr>
                        </thead>
                        <tbody id="visitsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> اختر الشهر:</label>
                    <select id="perfMonthFilter" class="filter-select" onchange="renderPerformanceChart()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div style="padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <canvas id="perfChart" width="400" height="150"></canvas>
                </div>
            </div>

            <div id="special-teachers" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">المعلمين المتميزين</h3>
                
                <div style="margin-bottom:30px; padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <h5 style="margin-top:0; color:#555;">ملخص بياني</h5>
                    <canvas id="specialChart" width="400" height="100"></canvas>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSpecialTab('distinguished', this)"><i class="fas fa-star" style="color:#ffc107;"></i> المعلمين المتميزين</div>
                    <div class="custom-tab" onclick="setSpecialTab('care', this)"><i class="fas fa-hand-holding-heart" style="color:#dc3545;"></i> المعلمين ذوي الاحتياج</div>
                </div>

                <div id="tab_distinguished" class="special-content active">
                    <div style="margin-bottom:15px; text-align:left;">
                        <button class="btn" style="background:#2c5aa0; color:white;" onclick="openAddSpecialModal('distinguished')"><i class="fas fa-plus"></i> إضافة معلم متميز</button>
                    </div>
                    <div class="table-scroll-wrapper">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th width="15%">القسم</th>
                                    <th width="20%">اسم المعلم/ة</th>
                                    <th width="15%">التقدير</th>
                                    <th width="40%">المبررات / الملاحظات</th>
                                    <th width="10%">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="distinguishedTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab_care" class="special-content" style="display:none;">
                    <div style="margin-bottom:15px; text-align:left;">
                        <button class="btn" style="background:#dc3545; color:white;" onclick="openAddSpecialModal('care')"><i class="fas fa-plus"></i> إضافة معلم يحتاج رعاية</button>
                    </div>
                    <div class="table-scroll-wrapper">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th width="15%">القسم</th>
                                    <th width="20%">اسم المعلم/ة</th>
                                    <th width="15%">التقدير</th>
                                    <th width="40%">المبررات / الملاحظات</th>
                                    <th width="10%">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="careTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="quality-report" class="section-card"><h3>تقرير الجودة</h3></div>
            
            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>

                <div id="gen" class="setting-content-pane active">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">اسم المدرسة</label>
                        <input type="text" id="confSchool" class="form-control" placeholder="أدخل اسم المدرسة">
                    </div>

                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">العام الدراسي</label>
                        <input type="text" id="confYear" class="form-control" placeholder="مثال: 2025 / 2026م">
                    </div>

                    <div class="upload-container">
                        <label class="upload-label">شعار الوزارة</label>
                        <input type="file" id="file_ministry" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_ministry', 'ministryLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_ministry">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_ministry')">
                                <i class="fas fa-upload"></i> تحميل شعار الوزارة
                            </button>
                            <span class="upload-hint">الحجم المقترح: 200x80 بكسل</span>
                        </div>
                        <div id="preview_wrap_ministry" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_ministry" class="image-preview" onclick="openImageModal(this.src)" title="اضغط للتكبير">
                            <button class="remove-img-btn" onclick="removeImage('preview_ministry', 'ministryLogo', 'file_ministry')" title="حذف الصورة"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div class="upload-container">
                        <label class="upload-label">شعار المدرسة</label>
                        <input type="file" id="file_school" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_school', 'schoolLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_school">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_school')">
                                <i class="fas fa-upload"></i> تحميل شعار المدرسة
                            </button>
                            <span class="upload-hint">الحجم المقترح: 200x200 بكسل</span>
                        </div>
                        <div id="preview_wrap_school" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_school" class="image-preview" onclick="openImageModal(this.src)" title="اضغط للتكبير">
                            <button class="remove-img-btn" onclick="removeImage('preview_school', 'schoolLogo', 'file_school')" title="حذف الصورة"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div class="upload-container">
                        <label class="upload-label">ختم المدرسة</label>
                        <input type="file" id="file_stamp" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_stamp', 'schoolStamp')">
                        <div class="upload-btn-wrapper" id="btn_wrap_stamp">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_stamp')">
                                <i class="fas fa-upload"></i> تحميل ختم المدرسة
                            </button>
                            <span class="upload-hint">يستخدم في التقارير الرسمية</span>
                        </div>
                        <div id="preview_wrap_stamp" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_stamp" class="image-preview" onclick="openImageModal(this.src)" title="اضغط للتكبير">
                            <button class="remove-img-btn" onclick="removeImage('preview_stamp', 'schoolStamp', 'file_stamp')" title="حذف الصورة"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div style="text-align: left; border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveGeneralSettings()">حفظ الإعدادات</button>
                    </div>
                </div>

                <div id="sig" class="setting-content-pane">
                    <p style="margin-bottom:20px; color:#666;">تحديد الأشخاص المسؤولين عن توقيع التقرير من القيادة العليا</p>
                    <div class="signature-grid">
                        <div class="signature-card">
                            <div class="signature-title">مدير/ة المدرسة</div>
                            <div class="form-group">
                                <label style="display:block; text-align:right; margin-bottom:5px; color:#777;">اختر مدير/ة المدرسة</label>
                                <select id="sig_director" class="form-control"><option value="">اختر مدير المدرسة</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary" style="min-width:100px;" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn" style="background:#dc3545; color:white; min-width:100px;" onclick="clearSignature('sig_director')">إزالة</button>
                            </div>
                        </div>

                        <div class="signature-card">
                            <div class="signature-title">المدير/ة المساعد/ة</div>
                            <div class="form-group">
                                <label style="display:block; text-align:right; margin-bottom:5px; color:#777;">اختر المدير/ة المساعد/ة</label>
                                <select id="sig_assistant" class="form-control"><option value="">اختر المدير المساعد</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary" style="min-width:100px;" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn" style="background:#dc3545; color:white; min-width:100px;" onclick="clearSignature('sig_assistant')">إزالة</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fot" class="setting-content-pane">
                    <h3 style="color:var(--primary); margin-bottom:20px; font-weight:bold;">إعدادات تذييل التقرير</h3>
                    
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">النص الذي سيظهر في تذييل كل صفحة من التقرير</label>
                        <label style="display:block; color:#666; font-size:0.9rem; margin-bottom:5px;">نص التذييل</label>
                        <textarea id="footer_text" class="form-control" rows="5" placeholder="أدخل نص التذييل الذي سيظهر في أسفل كل صفحة من التقرير"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">محاذاة التذييل</label>
                        <select id="footer_align" class="form-control">
                            <option value="center">وسط</option>
                            <option value="right">يمين</option>
                            <option value="left">يسار</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">حجم الخط</label>
                        <select id="footer_fontsize" class="form-control">
                            <option value="10">10 نقطة</option>
                            <option value="12">12 نقطة</option>
                            <option value="14">14 نقطة</option>
                            <option value="16">16 نقطة</option>
                        </select>
                    </div>

                    <div style="text-align:left; margin-top:20px;">
                        <button class="btn" style="background:#28a745; color:white; font-weight:bold;" onclick="saveFooterSettings()">حفظ إعدادات التذييل</button>
                    </div>
                </div>

                <div id="eval" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                        <h3>الزيارة الصفية</h3>
                        
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn" style="background:#2c5aa0; color:white;" onclick="openAddEvalModal()"><i class="fas fa-plus"></i> إضافة تقييم</button>
                        </div>
                    </div>

                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th width="10%">#</th>
                                <th width="55%">اسم المعيار</th>
                                <th width="10%">الحالة</th>
                                <th width="25%">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="evalTableBody">
                            </tbody>
                    </table>
                </div>

                <div id="vis" class="setting-content-pane">
                    <p style="margin-bottom:20px; color:#666;">حدد ترتيب ظهور أسماء الزوار في تقرير الزيارات الصفية</p>
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة العليا</div>
                        <ul id="list_visitor_senior" class="visitor-list"><li class="empty-list-msg">لم يتم إضافة زوار بعد</li></ul>
                        <button class="btn-add-visitor" onclick="openVisitorPicker('senior')">+ إضافة زائر من القيادة العليا</button>
                    </div>
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة الوسطى</div>
                        <ul id="list_visitor_middle" class="visitor-list"><li class="empty-list-msg">لم يتم إضافة زوار بعد</li></ul>
                        <button class="btn-add-visitor" onclick="openVisitorPicker('middle')">+ إضافة زائر من القيادة الوسطى</button>
                    </div>
                    <div style="text-align: left; margin-top: 20px;">
                        <button class="btn btn-toggle" onclick="saveVisitorOrder()">حفظ الترتيب</button>
                    </div>
                </div>

                <div id="log" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="color:var(--primary); margin:0;">سجل العمليات (Audit Log)</h4>
                        <div>
                            <button class="btn" style="background:#17a2b8; color:white; font-size:0.8rem;" onclick="loadSystemLogs()"><i class="fas fa-sync"></i> تحديث</button>
                            <button class="btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="clearSystemLogs()"><i class="fas fa-trash"></i> مسح السجل</button>
                        </div>
                    </div>
                    
                    <div class="log-table-wrapper">
                        <table class="custom-table" style="font-size:0.9rem;">
                            <thead>
                                <tr>
                                    <th width="20%">التاريخ والوقت</th>
                                    <th width="20%">المستخدم</th>
                                    <th width="20%">الحدث</th>
                                    <th width="40%">التفاصيل</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="addSpecialCaseModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="specialModalTitle"></span> <span onclick="closeModal('addSpecialCaseModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addSpecialForm">
                    <input type="hidden" id="spType">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="spDept" class="form-control" onchange="onSpecialDeptChange()">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">اسم المعلم/ة</label>
                        <select id="spTeacher" class="form-control">
                            <option value="">اختر المعلم/ة...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقدير</label>
                        <select id="spEval" class="form-control">
                            <option value="">اختر التقييم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المبررات / الملاحظات</label>
                        <textarea id="spNotes" class="form-control" rows="4" placeholder="سجل الملاحظات هنا..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveSpecialCase()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addSpecialCaseModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required>
                    <div id="deptWrapper" class="form-group" style="display:none;">
                        <label>القسم</label>
                        <select id="addDept" class="form-control"></select>
                    </div>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveUserForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addVisitForm">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="visitDept" class="form-control" onchange="onVisitDeptChange()">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المعلم/ة</label>
                        <select id="visitTeacher" class="form-control">
                            <option value="">اختر المعلم/ة...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">تاريخ الزيارة</label>
                        <input type="date" id="visitDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقييم</label>
                        <select id="visitEval" class="form-control">
                            <option value="">اختر التقييم...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveVisit()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addEvalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addEvalForm">
                    <input type="hidden" id="editEvalId">
                    <label>اسم المعيار</label>
                    <input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="viewUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewUserContent"></div>
            <div class="modal-footer">
                <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="permModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <h4 id="permTargetName" style="margin-top:0; color:var(--primary); margin-bottom:15px;"></h4>
                <div class="perm-header">
                    <span>تحديد الكل</span>
                    <div style="display:flex; gap:15px;">
                        <label><input type="checkbox" onchange="toggleAllPerms('view', this)"> الكل معاينة</label>
                        <label><input type="checkbox" onchange="toggleAllPerms('edit', this)"> الكل تعديل</label>
                    </div>
                </div>
                <div class="perm-list" id="permList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="imageViewModal" class="modal-overlay" onclick="closeModal('imageViewModal')">
        <div style="position:relative; max-width:90%; max-height:90%;">
            <span onclick="closeModal('imageViewModal')" style="position:absolute; top:-40px; right:0; color:white; font-size:30px; cursor:pointer;">&times;</span>
            <img id="fullImage" src="" style="max-width:100%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        </div>
    </div>

    <div id="visitorPickerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">اختر اسماً للإضافة <span onclick="closeModal('visitorPickerModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <input type="text" id="visitorSearch" class="form-control" placeholder="بحث عن اسم..." onkeyup="filterPickerList()">
                <div id="pickerList" class="picker-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#ddd;" onclick="closeModal('visitorPickerModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // === System Configuration ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'special-teachers', name: 'المعلمين المتميزين'}, // Renamed
            {id: 'quality-report', name: 'تقرير الجودة'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [],
            teachers: [],
            departments: [],
            visits_senior: [], 
            visits_middle: [], 
            special_cases: [], // Store Distinguished and Care teachers
            settings: {
                schoolName: 'مدرسة مدينة حمد الابتدائية للبنات',
                schoolYear: '2025 / 2026م',
                ministryLogo: '',
                schoolLogo: '',
                schoolStamp: '',
                signature_director_id: '',
                signature_assistant_id: '',
                visitor_order_senior: [],
                visitor_order_middle: [],
                footer_text: '',
                footer_align: 'center',
                footer_fontsize: '12',
                evaluation_criteria: []
            },
            logs: [] 
        };

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior'; 
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;
        let performanceChartInstance = null; 
        let specialChartInstance = null; // Chart for special teachers

        // === Core Functions ===
        function initSystem() {
            const storedDB = localStorage.getItem('QualitySys_DB_V2');
            if (storedDB) {
                DB = JSON.parse(storedDB);
                if(!DB.departments) DB.departments = [];
                if(!DB.settings) DB.settings = {};
                DB.settings = {...INITIAL_DB.settings, ...DB.settings};
                if(!DB.settings.evaluation_criteria) DB.settings.evaluation_criteria = [];
                if(!DB.logs) DB.logs = [];
                if(!DB.visits_senior) DB.visits_senior = [];
                if(!DB.visits_middle) DB.visits_middle = [];
                if(!DB.special_cases) DB.special_cases = [];

                ['admins', 'senior', 'middle', 'teachers', 'departments'].forEach(grp => {
                    if(DB[grp] && Array.isArray(DB[grp])) {
                        DB[grp].forEach(u => { 
                            if(grp !== 'departments') { 
                                if(!u.permissions) u.permissions = JSON.parse(JSON.stringify(DEFAULT_PERMS));
                                u.login = String(u.login).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                                u.pass = String(u.pass).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                            }
                            if(!u.status) u.status = 'active'; 
                        });
                    }
                });
                
                if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins));
                const adm = DB.admins.find(u => u.login === 'admin');
                if(adm) { 
                    adm.pass = 'Hasan@12'; adm.job = 'مدير النظام'; adm.status = 'active'; 
                    SECTIONS.forEach(sec => { if(!adm.permissions[sec.id]) adm.permissions[sec.id] = {}; adm.permissions[sec.id].view = true; adm.permissions[sec.id].edit = true; });
                } else { 
                    const newAdmin = JSON.parse(JSON.stringify(INITIAL_DB.admins[0]));
                    SECTIONS.forEach(sec => { newAdmin.permissions[sec.id] = {view: true, edit: true}; });
                    DB.admins.push(newAdmin); 
                }
                saveDB();
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                const adm = DB.admins[0];
                SECTIONS.forEach(sec => { adm.permissions[sec.id] = {view: true, edit: true}; });
                saveDB();
            }

            const sessionID = localStorage.getItem('QualitySys_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) {
                        const u = DB[grp].find(x => x.id == sessionID);
                        if(u) found = u;
                    }
                });
                if (found && found.status === 'active') { CURRENT_USER = found; showApp(); }
                else { document.getElementById('loginPage').style.display = 'flex'; }
            } else { document.getElementById('loginPage').style.display = 'flex'; }
        }

        function saveDB() { localStorage.setItem('QualitySys_DB_V2', JSON.stringify(DB)); }

        function addSystemLog(action, details) {
            const logEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('en-GB'),
                user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر',
                action: action,
                details: details
            };
            if(!DB.logs) DB.logs = [];
            DB.logs.unshift(logEntry); 
            if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500);
            saveDB();
        }

        function login(e) {
            e.preventDefault();
            const errBox = document.getElementById('loginError');
            errBox.style.display = 'none';
            const uInput = document.getElementById('loginUser').value.trim();
            const pInput = document.getElementById('loginPass').value.trim();
            let userFound = null;
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                if(DB[grp]) {
                    const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput);
                    if(match) userFound = match;
                }
            });
            if (userFound) {
                if (userFound.status === 'active') {
                    CURRENT_USER = userFound;
                    localStorage.setItem('QualitySys_Session', userFound.id);
                    addSystemLog('تسجيل دخول', `المستخدم: ${userFound.name}`);
                    showApp();
                } else {
                    errBox.innerText = "نعتذر منك، الحساب غير نشط حالياً.";
                    errBox.style.display = 'block';
                }
            } else {
                errBox.innerText = "بيانات غير صحيحة.";
                errBox.style.display = 'block';
            }
        }

        function logout() { 
            if(CURRENT_USER) addSystemLog('تسجيل خروج', `المستخدم: ${CURRENT_USER.name}`);
            localStorage.removeItem('QualitySys_Session'); 
            location.reload(); 
        }

        function resetSystem() {
            if(confirm('تحذير: سيتم حذف كافة البيانات. هل أنت متأكد؟')) {
                localStorage.removeItem('QualitySys_DB_V2');
                localStorage.removeItem('QualitySys_Session');
                location.reload();
            }
        }

        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة."); return; }
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');
            
            if(pageId === 'settings') loadSettings();
            if(pageId === 'visits') renderVisitsTable(); 
            if(pageId === 'performance') renderPerformanceChart();
            if(pageId === 'special-teachers') renderSpecialCases();
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم';
            applySidebarPermissions();
            renderTable();
            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
            });
        }

        // ... [Basic User Management Functions: setTab, renderTable, moveUser, etc.] ...
        function setTab(tab, el) {
            CURRENT_TAB = tab;
            document.querySelectorAll('.custom-tab').forEach(t => {
                 if(t.parentElement.previousElementSibling && t.parentElement.previousElementSibling.id === 'userActionButtons') { /*pass*/ } 
                 else if (el.parentElement === t.parentElement) { t.classList.remove('active'); }
            });
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
            renderTable();
        }

        function renderTable() {
            const headRow = document.getElementById('tableHeadRow');
            const tbody = document.getElementById('usersTableBody');
            const addBtn = document.getElementById('addBtnMain');
            const bulkPermBtn = document.getElementById('bulkPermBtn');
            tbody.innerHTML = '';
            
            const userPerms = CURRENT_USER.permissions['user-management'] || {view:true, edit:false};
            const canEdit = userPerms.edit === true;
            const actionButtons = document.getElementById('userActionButtons');
            const noEditMsg = document.getElementById('noEditPermissionMsg');
            
            if(canEdit) { actionButtons.style.display = 'flex'; noEditMsg.style.display = 'none'; } 
            else { actionButtons.style.display = 'none'; noEditMsg.style.display = 'block'; }

            if (CURRENT_TAB === 'departments') {
                headRow.innerHTML = `<th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th><th width="10%">الترتيب</th><th width="40%">اسم القسم</th><th width="15%">الحالة</th><th width="30%">الإدارة</th>`;
                addBtn.innerText = "إضافة قسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()'); 
                if(bulkPermBtn) bulkPermBtn.style.display = 'none'; 
            } else {
                headRow.innerHTML = `<th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th><th width="5%">#</th><th width="25%">الاسم</th><th width="15%">الوظيفة</th><th width="15%">الحالة</th><th width="35%">الإجراءات</th>`;
                addBtn.innerText = "إضافة اسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()');
                if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex';
            }

            const list = DB[CURRENT_TAB] || [];
            list.forEach((u, idx) => {
                const isActive = u.status === 'active';
                const statusBadge = isActive ? `<span class="status-badge status-active">مفعل</span>` : `<span class="status-badge status-inactive">معطل</span>`;
                let row = `<td><input type="checkbox" class="custom-checkbox user-select-cb" value="${u.id}" ${canEdit ? '' : 'disabled'}></td>`;
                row += `<td>${idx+1}</td><td>${u.name}</td>`;
                if (CURRENT_TAB !== 'departments') row += `<td>${u.job || (CURRENT_TAB === 'teachers' ? u.dept : '-')}</td>`;
                row += `<td>${statusBadge}</td>`;
                row += `<td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">`;
                if(canEdit) {
                    row += `<button class="action-btn btn-move" onclick="moveUser(${u.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button>`;
                    row += `<button class="action-btn btn-move" onclick="moveUser(${u.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button>`;
                }
                if (CURRENT_TAB === 'departments') {
                    if(canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button><button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button><button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button>`;
                    }
                } else {
                    row += `<button class="action-btn btn-view" onclick="viewUser(${u.id})"><i class="fas fa-eye"></i> معاينة</button>`;
                    if (canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button><button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button><button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button><button class="action-btn btn-perm" onclick="openPerms(${u.id})"><i class="fas fa-key"></i> صلاحيات</button>`;
                    }
                }
                row += `</div></td>`;
                const tr = document.createElement('tr');
                tr.innerHTML = row;
                tbody.appendChild(tr);
            });
        }
        function moveUser(id, direction) {
            const list = DB[CURRENT_TAB];
            const index = list.findIndex(u => u.id === id);
            if (index === -1) return;
            if (direction === 'up' && index > 0) { [list[index], list[index - 1]] = [list[index - 1], list[index]]; } 
            else if (direction === 'down' && index < list.length - 1) { [list[index], list[index + 1]] = [list[index + 1], list[index]]; }
            saveDB();
            renderTable();
        }
        function toggleSelectAll(source) { document.querySelectorAll('.user-select-cb').forEach(cb => { if(!cb.disabled) cb.checked = source.checked; }); }
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            if(confirm(`هل أنت متأكد من حذف ${checkboxes.length} عنصر؟`)) {
                const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => !idsToDelete.includes(u.id));
                addSystemLog('حذف جماعي', `حذف ${idsToDelete.length} عنصر من ${CURRENT_TAB}`);
                saveDB();
                renderTable();
                document.getElementById('selectAll').checked = false;
            }
        }
        function toggleStatusSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            const idsToToggle = Array.from(checkboxes).map(cb => parseInt(cb.value));
            DB[CURRENT_TAB].forEach(u => { if(idsToToggle.includes(u.id)) u.status = (u.status === 'active') ? 'inactive' : 'active'; });
            addSystemLog('تغيير حالة جماعي', `تعديل ${idsToToggle.length} عنصر في ${CURRENT_TAB}`);
            saveDB();
            renderTable();
        }
        function toggleStatus(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            if(u) { u.status = (u.status === 'active') ? 'inactive' : 'active'; addSystemLog('تغيير حالة', `المستخدم/القسم: ${u.name} - الحالة الجديدة: ${u.status}`); saveDB(); renderTable(); }
        }
        function deleteUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            if(confirm('هل أنت متأكد من الحذف؟')) { addSystemLog('حذف مستخدم', `حذف: ${u ? u.name : id}`); DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => u.id !== id); saveDB(); renderTable(); }
        }
        function viewUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            const content = document.getElementById('viewUserContent');
            content.innerHTML = `<div class="user-view-card"><div class="user-view-avatar">${u.name.charAt(0)}</div><h3 style="color:var(--primary); margin:0;">${u.name}</h3></div><div class="info-grid"><div class="info-item"><label>الوظيفة</label><span>${u.job || u.dept || '-'}</span></div><div class="info-item"><label>رقم الهاتف</label><span>${u.phone || '-'}</span></div><div class="info-item"><label>الحالة</label><span style="color:${u.status==='active'?'green':'red'}">${u.status==='active'?'مفعل':'معطل'}</span></div><div class="info-item"><label>اسم الدخول</label><span style="background:#eee; padding:2px 5px; border-radius:4px;">${u.login || '-'}</span></div></div>`;
            document.getElementById('viewUserModal').style.display = 'flex';
        }

        // ... [Permissions, Uploads, Settings Logic] ...
        function openPerms(id) {
            if (CURRENT_TAB === 'departments') return;
            IS_BULK_PERM_MODE = false;
            EDITING_PERM_ID = id;
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            document.getElementById('permTargetName').innerText = 'صلاحيات: ' + u.name;
            const masters = document.querySelectorAll('.perm-header input');
            if(masters) masters.forEach(m => m.checked = false);
            const container = document.getElementById('permList');
            container.innerHTML = '';
            const userPerms = u.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const p = userPerms[sec.id] || {view: true, edit: false};
                container.innerHTML += `<div class="perm-item"><span>${sec.name}</span><div style="display:flex; gap:15px;"><label><input type="checkbox" id="pv_${sec.id}" class="perm-view-cb" ${p.view ? 'checked' : ''}> معاينة</label><label><input type="checkbox" id="pe_${sec.id}" class="perm-edit-cb" ${p.edit ? 'checked' : ''}> تعديل</label></div></div>`;
            });
            document.getElementById('permModal').style.display = 'flex';
        }
        function toggleAllPerms(type, source) { const className = type === 'view' ? '.perm-view-cb' : '.perm-edit-cb'; document.querySelectorAll(className).forEach(cb => cb.checked = source.checked); }
        function submitPermissions() {
            if (IS_BULK_PERM_MODE) {
                const checkboxes = document.querySelectorAll('.user-select-cb:checked');
                const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
                const newPerms = {};
                SECTIONS.forEach(sec => { newPerms[sec.id] = { view: document.getElementById(`pv_${sec.id}`).checked, edit: document.getElementById(`pe_${sec.id}`).checked }; });
                DB[CURRENT_TAB].forEach(u => { if (ids.includes(u.id)) { u.permissions = JSON.parse(JSON.stringify(newPerms)); } });
                addSystemLog('صلاحيات', `تعديل صلاحيات ${ids.length} مستخدم`);
                alert('تم تحديث الصلاحيات بنجاح.');
            } else {
                const u = DB[CURRENT_TAB].find(x => x.id === EDITING_PERM_ID);
                SECTIONS.forEach(sec => { if(!u.permissions[sec.id]) u.permissions[sec.id] = {}; u.permissions[sec.id].view = document.getElementById(`pv_${sec.id}`).checked; u.permissions[sec.id].edit = document.getElementById(`pe_${sec.id}`).checked; });
                if (CURRENT_USER.id === u.id) { CURRENT_USER = u; applySidebarPermissions(); renderTable(); }
                addSystemLog('صلاحيات', `تعديل صلاحيات المستخدم: ${u.name}`);
            }
            saveDB();
            closeModal('permModal');
        }
        function openBulkPerms() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي مستخدم.'); return; }
            IS_BULK_PERM_MODE = true;
            document.getElementById('permTargetName').innerText = `تعديل صلاحيات (${checkboxes.length}) مستخدم`;
            const masters = document.querySelectorAll('.perm-header input');
            if(masters) masters.forEach(m => m.checked = false);
            const container = document.getElementById('permList');
            container.innerHTML = '';
            SECTIONS.forEach(sec => { container.innerHTML += `<div class="perm-item"><span>${sec.name}</span><div style="display:flex; gap:15px;"><label><input type="checkbox" id="pv_${sec.id}" class="perm-view-cb"> معاينة</label><label><input type="checkbox" id="pe_${sec.id}" class="perm-edit-cb"> تعديل</label></div></div>`; });
            document.getElementById('permModal').style.display = 'flex';
        }
        
        function openAddUserModal() { 
            const isDept = (CURRENT_TAB === 'departments');
            const isTeacher = (CURRENT_TAB === 'teachers');
            document.getElementById('editUserId').value = ''; 
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModal').style.display = 'flex'; 
            if (isDept) {
                document.getElementById('addUserModalTitle').innerText = 'إضافة قسم جديد';
                document.getElementById('userFields').style.display = 'none';
                document.getElementById('deptWrapper').style.display = 'none';
            } else if (isTeacher) {
                document.getElementById('addUserModalTitle').innerText = 'إضافة معلمة جديدة';
                document.getElementById('userFields').style.display = 'none';
                document.getElementById('deptWrapper').style.display = 'block';
                const sel = document.getElementById('addDept');
                sel.innerHTML = '<option value="">اختر القسم...</option>';
                if(DB.departments && DB.departments.length > 0) {
                    DB.departments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.name; opt.innerText = d.name; sel.appendChild(opt);
                    });
                } else { sel.innerHTML = '<option value="">لا توجد أقسام مضافة</option>'; }
            } else {
                document.getElementById('addUserModalTitle').innerText = 'إضافة مستخدم جديد';
                document.getElementById('userFields').style.display = 'block';
                document.getElementById('deptWrapper').style.display = 'none';
            }
        }
        function editUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            if(!u) return;
            document.getElementById('editUserId').value = u.id;
            document.getElementById('addName').value = u.name;
            const isDept = (CURRENT_TAB === 'departments');
            const isTeacher = (CURRENT_TAB === 'teachers');
            if (isDept) {
                document.getElementById('userFields').style.display = 'none';
                document.getElementById('deptWrapper').style.display = 'none';
            } else if (isTeacher) {
                document.getElementById('userFields').style.display = 'none';
                document.getElementById('deptWrapper').style.display = 'block';
                const sel = document.getElementById('addDept');
                sel.innerHTML = '<option value="">اختر القسم...</option>';
                if(DB.departments && DB.departments.length > 0) {
                    DB.departments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.name; opt.innerText = d.name;
                        if (u.dept === d.name) opt.selected = true;
                        sel.appendChild(opt);
                    });
                }
            } else {
                document.getElementById('userFields').style.display = 'block';
                document.getElementById('deptWrapper').style.display = 'none';
                document.getElementById('addJob').value = u.job || u.dept || '';
                document.getElementById('addPhone').value = u.phone || '';
                document.getElementById('addLogin').value = u.login || '';
                document.getElementById('addPass').value = u.pass || '';
            }
            document.getElementById('addUserModalTitle').innerText = 'تعديل البيانات';
            document.getElementById('addUserModal').style.display = 'flex'; 
        }
        function saveUserForm() {
            const name = document.getElementById('addName').value.trim();
            if(!name) { alert("يرجى إدخال الاسم"); return; }
            const editId = document.getElementById('editUserId').value;
            const isEdit = editId !== '';
            let targetUser;
            if (isEdit) {
                targetUser = DB[CURRENT_TAB].find(u => u.id == editId);
                targetUser.name = name;
                addSystemLog('تعديل مستخدم', `تعديل بيانات: ${name}`);
            } else {
                targetUser = { id: Date.now(), name: name, status: 'active' };
                if (CURRENT_TAB !== 'departments') {
                    targetUser.dateAdded = new Date().toLocaleDateString('en-GB');
                    targetUser.permissions = JSON.parse(JSON.stringify(DEFAULT_PERMS));
                }
                addSystemLog('إضافة مستخدم', `إضافة جديد: ${name} في ${CURRENT_TAB}`);
            }
            if (CURRENT_TAB === 'teachers') {
                const deptVal = document.getElementById('addDept').value;
                if(!deptVal) { alert("يرجى اختيار القسم"); return; }
                targetUser.dept = deptVal;
            } else if (CURRENT_TAB !== 'departments') {
                targetUser.job = document.getElementById('addJob').value.trim();
                targetUser.phone = document.getElementById('addPhone').value.trim();
                targetUser.login = document.getElementById('addLogin').value.trim();
                targetUser.pass = document.getElementById('addPass').value.trim();
            }
            if (!isEdit) DB[CURRENT_TAB].push(targetUser);
            saveDB();
            renderTable();
            closeModal('addUserModal');
        }

        // ... [Core functions for Visits, Settings, Utils retained] ...
        function togglePass(id, icon) { const input = document.getElementById(id); if(input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); } else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function setSettingTab(t, el) { 
            document.querySelectorAll('.setting-content-pane').forEach(p => p.classList.remove('active')); 
            document.getElementById(t).classList.add('active'); 
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('active'));
            el.classList.add('active'); 
            if (t === 'sig') loadSignatureSettings();
            if (t === 'vis') loadVisitorSettings();
            if (t === 'fot') loadFooterSettings();
            if (t === 'log') loadSystemLogs();
            if (t === 'eval') loadEvaluationSettings();
        }
        function loadSettings() {
            const s = DB.settings;
            document.getElementById('confSchool').value = s.schoolName || '';
            document.getElementById('confYear').value = s.schoolYear || '';
            showImagePreview('preview_ministry', 'preview_wrap_ministry', 'btn_wrap_ministry', s.ministryLogo);
            showImagePreview('preview_school', 'preview_wrap_school', 'btn_wrap_school', s.schoolLogo);
            showImagePreview('preview_stamp', 'preview_wrap_stamp', 'btn_wrap_stamp', s.schoolStamp);
        }
        function showImagePreview(imgId, wrapId, btnId, src) {
            const img = document.getElementById(imgId);
            const wrap = document.getElementById(wrapId);
            const btn = document.getElementById(btnId);
            if (src) { img.src = src; wrap.style.display = 'inline-block'; btn.style.display = 'none'; } 
            else { wrap.style.display = 'none'; btn.style.display = 'block'; }
        }
        function triggerFileSelect(inputId) { document.getElementById(inputId).click(); }
        function handleFileUpload(input, previewId, dbKey) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    const img = document.getElementById(previewId);
                    img.src = dataUrl;
                    const wrapId = previewId.replace('preview_', 'preview_wrap_');
                    const btnId = previewId.replace('preview_', 'btn_wrap_');
                    document.getElementById(wrapId).style.display = 'inline-block';
                    document.getElementById(btnId).style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function removeImage(previewId, dbKey, inputId) {
            if(confirm('هل تريد حذف هذه الصورة؟')) {
                const img = document.getElementById(previewId);
                img.src = '';
                document.getElementById(inputId).value = ''; 
                const wrapId = previewId.replace('preview_', 'preview_wrap_');
                const btnId = previewId.replace('preview_', 'btn_wrap_');
                document.getElementById(wrapId).style.display = 'none';
                document.getElementById(btnId).style.display = 'block';
            }
        }
        function saveGeneralSettings() {
            DB.settings.schoolName = document.getElementById('confSchool').value;
            DB.settings.schoolYear = document.getElementById('confYear').value;
            const minSrc = document.getElementById('preview_ministry').getAttribute('src');
            const schSrc = document.getElementById('preview_school').getAttribute('src');
            const stmSrc = document.getElementById('preview_stamp').getAttribute('src');
            DB.settings.ministryLogo = (minSrc && minSrc.startsWith('data:')) ? minSrc : ''; 
            DB.settings.schoolLogo = (schSrc && schSrc.startsWith('data:')) ? schSrc : ''; 
            DB.settings.schoolStamp = (stmSrc && stmSrc.startsWith('data:')) ? stmSrc : ''; 
            addSystemLog('إعدادات', 'تحديث الإعدادات العامة');
            saveDB();
            alert('تم حفظ الإعدادات بنجاح');
        }
        function openImageModal(src) {
            if(!src) return;
            document.getElementById('fullImage').src = src;
            document.getElementById('imageViewModal').style.display = 'flex';
        }
        function loadSignatureSettings() {
            const seniors = DB.senior || [];
            const dirSelect = document.getElementById('sig_director');
            const asstSelect = document.getElementById('sig_assistant');
            const populate = (sel, selectedVal) => {
                sel.innerHTML = '<option value="">اختر...</option>';
                seniors.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id; opt.innerText = u.name;
                    if(u.id == selectedVal) opt.selected = true;
                    sel.appendChild(opt);
                });
            };
            populate(dirSelect, DB.settings.signature_director_id);
            populate(asstSelect, DB.settings.signature_assistant_id);
        }
        function saveSignatureSettings() {
            DB.settings.signature_director_id = document.getElementById('sig_director').value;
            DB.settings.signature_assistant_id = document.getElementById('sig_assistant').value;
            addSystemLog('إعدادات', 'تحديث إعدادات التوقيعات');
            saveDB();
            alert('تم حفظ التوقيعات');
        }
        function clearSignature(elemId) { document.getElementById(elemId).value = ""; saveSignatureSettings(); }
        function loadVisitorSettings() { renderVisitorList('senior'); renderVisitorList('middle'); }
        function renderVisitorList(type) {
            const listContainer = document.getElementById(`list_visitor_${type}`);
            const orderIds = type === 'senior' ? DB.settings.visitor_order_senior : DB.settings.visitor_order_middle;
            const sourceDB = type === 'senior' ? DB.senior : DB.middle;
            listContainer.innerHTML = '';
            if(!orderIds || orderIds.length === 0) { listContainer.innerHTML = '<li class="empty-list-msg">لم يتم إضافة زوار بعد</li>'; return; }
            orderIds.forEach((id, index) => {
                const user = sourceDB.find(u => u.id == id);
                if(user) {
                    const li = document.createElement('li');
                    li.className = 'visitor-list-item';
                    li.innerHTML = `<span class="visitor-name">${user.name}</span><div class="visitor-controls"><button class="action-btn btn-move" onclick="moveVisitorItem('${type}', ${index}, 'up')" title="للأعلى"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveVisitorItem('${type}', ${index}, 'down')" title="للأسفل"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-delete" onclick="removeVisitorItem('${type}', ${index})"><i class="fas fa-trash"></i></button></div>`;
                    listContainer.appendChild(li);
                }
            });
        }
        function openVisitorPicker(type) {
            CURRENT_PICKER_TYPE = type;
            document.getElementById('visitorSearch').value = '';
            filterPickerList();
            document.getElementById('visitorPickerModal').style.display = 'flex';
        }
        function filterPickerList() {
            const query = document.getElementById('visitorSearch').value.toLowerCase();
            const listDiv = document.getElementById('pickerList');
            listDiv.innerHTML = '';
            const type = CURRENT_PICKER_TYPE;
            const sourceDB = type === 'senior' ? DB.senior : DB.middle;
            const currentOrder = type === 'senior' ? DB.settings.visitor_order_senior : DB.settings.visitor_order_middle;
            const availableUsers = sourceDB.filter(u => !currentOrder.includes(u.id));
            availableUsers.forEach(u => {
                if(u.name.toLowerCase().includes(query)) {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.innerHTML = `<div><div class="picker-item-name">${u.name}</div><div class="picker-item-job">${u.job || u.dept || ''}</div></div><i class="fas fa-plus-circle" style="color:var(--success);"></i>`;
                    item.onclick = () => addVisitorToOrder(u.id);
                    listDiv.appendChild(item);
                }
            });
            if(listDiv.innerHTML === '') listDiv.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">لا توجد أسماء متاحة</div>';
        }
        function addVisitorToOrder(id) {
            if(CURRENT_PICKER_TYPE === 'senior') { if(!DB.settings.visitor_order_senior) DB.settings.visitor_order_senior = []; DB.settings.visitor_order_senior.push(id); } 
            else { if(!DB.settings.visitor_order_middle) DB.settings.visitor_order_middle = []; DB.settings.visitor_order_middle.push(id); }
            closeModal('visitorPickerModal');
            renderVisitorList(CURRENT_PICKER_TYPE);
        }
        function removeVisitorItem(type, index) {
            const arr = type === 'senior' ? DB.settings.visitor_order_senior : DB.settings.visitor_order_middle;
            arr.splice(index, 1);
            renderVisitorList(type);
        }
        function moveVisitorItem(type, index, direction) {
            const arr = type === 'senior' ? DB.settings.visitor_order_senior : DB.settings.visitor_order_middle;
            if (direction === 'up' && index > 0) { [arr[index], arr[index - 1]] = [arr[index - 1], arr[index]]; } 
            else if (direction === 'down' && index < arr.length - 1) { [arr[index], arr[index + 1]] = [arr[index + 1], arr[index]]; }
            renderVisitorList(type);
        }
        function saveVisitorOrder() { addSystemLog('إعدادات', 'تحديث ترتيب الزوار'); saveDB(); alert('تم حفظ ترتيب الزوار بنجاح'); }
        function loadFooterSettings() {
            const s = DB.settings;
            document.getElementById('footer_text').value = s.footer_text || '';
            document.getElementById('footer_align').value = s.footer_align || 'center';
            document.getElementById('footer_fontsize').value = s.footer_fontsize || '12';
        }
        function saveFooterSettings() {
            DB.settings.footer_text = document.getElementById('footer_text').value;
            DB.settings.footer_align = document.getElementById('footer_align').value;
            DB.settings.footer_fontsize = document.getElementById('footer_fontsize').value;
            addSystemLog('إعدادات', 'تحديث تذييل التقرير');
            saveDB();
            alert('تم حفظ إعدادات التذييل');
        }
        function loadEvaluationSettings() {
            const tbody = document.getElementById('evalTableBody');
            tbody.innerHTML = '';
            const list = DB.settings.evaluation_criteria || [];
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="padding:20px; color:#888;">لم يتم إضافة معايير بعد</td></tr>'; return; }
            list.forEach((item, idx) => {
                const isActive = item.status === 'active';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${idx + 1}</td><td>${item.name}</td><td><span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">${isActive ? 'مفعل' : 'معطل'}</span></td><td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;"><button class="action-btn btn-move" onclick="moveEval(${item.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveEval(${item.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleEvalStatus(${item.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button><button class="action-btn btn-edit" onclick="openAddEvalModal(${item.id})"><i class="fas fa-edit"></i> تعديل</button><button class="action-btn btn-delete" onclick="deleteEval(${item.id})"><i class="fas fa-trash"></i> حذف</button></div></td>`;
                tbody.appendChild(tr);
            });
        }
        function openAddEvalModal(id = null) {
            document.getElementById('addEvalForm').reset();
            document.getElementById('editEvalId').value = '';
            if(id) {
                const item = DB.settings.evaluation_criteria.find(x => x.id === id);
                if(item) { document.getElementById('editEvalId').value = item.id; document.getElementById('evalName').value = item.name; }
            }
            document.getElementById('addEvalModal').style.display = 'flex';
        }
        function saveEvalForm() {
            const name = document.getElementById('evalName').value.trim();
            if(!name) { alert('يرجى تعبئة اسم المعيار'); return; }
            const editId = document.getElementById('editEvalId').value;
            let list = DB.settings.evaluation_criteria;
            if(editId) {
                const item = list.find(x => x.id == editId);
                if(item) { item.name = name; }
            } else { list.push({ id: Date.now(), name: name, status: 'active' }); }
            addSystemLog('إعدادات التقييم', editId ? 'تعديل معيار' : 'إضافة معيار جديد');
            saveDB();
            loadEvaluationSettings();
            closeModal('addEvalModal');
        }
        function deleteEval(id) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                DB.settings.evaluation_criteria = DB.settings.evaluation_criteria.filter(x => x.id !== id);
                addSystemLog('إعدادات التقييم', 'حذف معيار تقييم');
                saveDB();
                loadEvaluationSettings();
            }
        }
        function toggleEvalStatus(id) {
            const item = DB.settings.evaluation_criteria.find(x => x.id === id);
            if(item) { item.status = (item.status === 'active') ? 'inactive' : 'active'; saveDB(); loadEvaluationSettings(); }
        }
        function moveEval(id, direction) {
            const list = DB.settings.evaluation_criteria;
            const index = list.findIndex(x => x.id === id);
            if(index === -1) return;
            if (direction === 'up' && index > 0) { [list[index], list[index - 1]] = [list[index - 1], list[index]]; } 
            else if (direction === 'down' && index < list.length - 1) { [list[index], list[index + 1]] = [list[index + 1], list[index]]; }
            saveDB();
            loadEvaluationSettings();
        }
        function loadSystemLogs() {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            const logs = DB.logs || [];
            if(logs.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">لا توجد سجلات</td></tr>'; return; }
            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-size:0.85rem;">${log.date}</td><td style="font-weight:bold;">${log.user}</td><td><span class="status-badge" style="background:#e2e3e5; color:#383d41;">${log.action}</span></td><td><div class="log-details" title="${log.details}">${log.details}</div></td>`;
                tbody.appendChild(tr);
            });
        }
        function clearSystemLogs() {
            if(confirm('هل أنت متأكد من مسح كافة السجلات؟ لا يمكن التراجع عن هذه العملية.')) { DB.logs = []; addSystemLog('سجل النظام', 'مسح كافة السجلات السابقة'); saveDB(); loadSystemLogs(); }
        }

        // ============================================
        // === Visit Logic & Helpers ===
        // ============================================
        function setVisitTab(tab, el) { CURRENT_VISIT_TAB = tab; Array.from(el.parentElement.children).forEach(c => c.classList.remove('active')); el.classList.add('active'); renderVisitsTable(); }
        function openAddVisitModal() {
            document.getElementById('addVisitForm').reset();
            const deptSel = document.getElementById('visitDept');
            deptSel.innerHTML = '<option value="">اختر القسم...</option>';
            if(DB.departments && DB.departments.length > 0) { DB.departments.forEach(d => { const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name; deptSel.appendChild(opt); }); } 
            else { deptSel.innerHTML = '<option value="">لا توجد أقسام مضافة</option>'; }
            const evalSel = document.getElementById('visitEval');
            evalSel.innerHTML = '<option value="">اختر التقييم...</option>';
            if(DB.settings.evaluation_criteria && DB.settings.evaluation_criteria.length > 0) { DB.settings.evaluation_criteria.forEach(e => { if(e.status === 'active') { const opt = document.createElement('option'); opt.value = e.name; opt.innerText = e.name; evalSel.appendChild(opt); } }); }
            document.getElementById('visitTeacher').innerHTML = '<option value="">اختر المعلم/ة...</option>';
            document.getElementById('addVisitModal').style.display = 'flex';
        }
        function onVisitDeptChange() {
            const selectedDept = document.getElementById('visitDept').value;
            const teacherSel = document.getElementById('visitTeacher');
            teacherSel.innerHTML = '<option value="">اختر المعلم/ة...</option>';
            if(selectedDept && DB.teachers) {
                const teachers = DB.teachers.filter(t => t.dept === selectedDept && t.status === 'active');
                if(teachers.length > 0) { teachers.forEach(t => { const opt = document.createElement('option'); opt.value = t.name; opt.innerText = t.name; teacherSel.appendChild(opt); }); } 
                else { teacherSel.innerHTML = '<option value="">لا يوجد معلمات في هذا القسم</option>'; }
            }
        }
        function saveVisit() {
            const dept = document.getElementById('visitDept').value;
            const teacher = document.getElementById('visitTeacher').value;
            const date = document.getElementById('visitDate').value;
            const eval = document.getElementById('visitEval').value;
            if(!dept || !teacher || !date || !eval) { alert('يرجى تعبئة جميع الحقول المطلوبة'); return; }
            const visitObj = { id: Date.now(), dept: dept, teacher: teacher, date: date, eval: eval, visitorName: CURRENT_USER.name, visitorId: CURRENT_USER.id };
            let isMiddle = false;
            if(DB.middle && DB.middle.some(u => u.id === CURRENT_USER.id)) { isMiddle = true; }
            if(isMiddle) { if(!DB.visits_middle) DB.visits_middle = []; DB.visits_middle.push(visitObj); addSystemLog('زيارة صفية', `إضافة زيارة (وسطى): ${teacher}`); } 
            else { if(!DB.visits_senior) DB.visits_senior = []; DB.visits_senior.push(visitObj); addSystemLog('زيارة صفية', `إضافة زيارة (عليا): ${teacher}`); }
            saveDB(); renderVisitsTable(); closeModal('addVisitModal'); alert('تم حفظ الزيارة بنجاح');
        }
        function getLatestJobTitle(userId) {
            const groups = ['admins', 'senior', 'middle', 'teachers'];
            for(let g of groups) { if(DB[g]) { const found = DB[g].find(u => u.id == userId); if(found) return found.job || found.dept || '-'; } }
            return '-';
        }
        function renderVisitsTable() {
            const tbody = document.getElementById('visitsTableBody');
            const monthFilter = document.getElementById('visitMonthFilter').value;
            tbody.innerHTML = '';
            let list = [];
            if(CURRENT_VISIT_TAB === 'senior') list = DB.visits_senior || [];
            else list = DB.visits_middle || [];
            if (monthFilter !== 'all') { list = list.filter(v => { const m = String(new Date(v.date).getMonth() + 1).padStart(2, '0'); return m === monthFilter; }); }
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; color:#888;">لا توجد زيارات مسجلة لهذا الشهر</td></tr>'; return; }
            list.sort((a,b) => b.id - a.id);
            list.forEach(v => {
                const currentJob = getLatestJobTitle(v.visitorId);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${v.date}</td><td>${v.dept}</td><td style="font-weight:bold;">${v.teacher}</td><td><span class="status-badge status-active" style="background:#eef; color:var(--primary); border:1px solid #ccf;">${v.eval}</span></td><td>${v.visitorName}</td><td>${currentJob}</td>`;
                tbody.appendChild(tr);
            });
        }
        function renderPerformanceChart() {
            const monthFilter = document.getElementById('perfMonthFilter').value;
            const ctx = document.getElementById('perfChart').getContext('2d');
            let allVisits = [...(DB.visits_senior || []), ...(DB.visits_middle || [])];
            if (monthFilter !== 'all') { allVisits = allVisits.filter(v => { const m = String(new Date(v.date).getMonth() + 1).padStart(2, '0'); return m === monthFilter; }); }
            const departments = [...new Set(allVisits.map(v => v.dept))];
            let criteriaNames = DB.settings.evaluation_criteria ? DB.settings.evaluation_criteria.filter(c => c.status === 'active').map(c => c.name) : [];
            allVisits.forEach(v => { if(!criteriaNames.includes(v.eval)) criteriaNames.push(v.eval); });
            const datasets = criteriaNames.map((crit, index) => {
                const data = departments.map(dept => { return allVisits.filter(v => v.dept === dept && v.eval === crit).length; });
                const colors = ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6610f2', '#fd7e14'];
                return { label: crit, data: data, backgroundColor: colors[index % colors.length], borderWidth: 0 };
            });
            if (performanceChartInstance) { performanceChartInstance.destroy(); }
            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: departments.length > 0 ? departments : ['لا توجد بيانات'], datasets: datasets },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } }, plugins: { legend: { position: 'top', rtl: true, labels: { font: { family: 'Cairo' } } }, tooltip: { titleFont: { family: 'Cairo' }, bodyFont: { family: 'Cairo' } } } }
            });
        }

        // ==============================================================
        // === Special Teachers Logic (المعلمين المتميزين وذوي الاحتياج) ===
        // ==============================================================

        function setSpecialTab(type, el) {
            document.querySelectorAll('.special-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.special-content button').forEach(b => {}); 
            document.getElementById(`tab_${type}`).style.display = 'block';
            document.querySelectorAll('#special-teachers .custom-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        function openAddSpecialModal(type) {
            const form = document.getElementById('addSpecialForm');
            form.reset();
            document.getElementById('spType').value = type;
            const title = type === 'distinguished' ? 'إضافة معلم متميز' : 'إضافة معلم يحتاج رعاية';
            document.getElementById('specialModalTitle').innerText = title;
            const deptSel = document.getElementById('spDept');
            deptSel.innerHTML = '<option value="">اختر القسم...</option>';
            if(DB.departments && DB.departments.length > 0) {
                DB.departments.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.name; opt.innerText = d.name; deptSel.appendChild(opt);
                });
            }
            const evalSel = document.getElementById('spEval');
            evalSel.innerHTML = '<option value="">اختر التقييم...</option>';
            if(DB.settings.evaluation_criteria && DB.settings.evaluation_criteria.length > 0) {
                DB.settings.evaluation_criteria.forEach(e => {
                    if(e.status === 'active') {
                        const opt = document.createElement('option');
                        opt.value = e.name; opt.innerText = e.name; evalSel.appendChild(opt);
                    }
                });
            }
            document.getElementById('spTeacher').innerHTML = '<option value="">اختر القسم أولاً</option>';
            document.getElementById('addSpecialCaseModal').style.display = 'flex';
        }

        function onSpecialDeptChange() {
            const selectedDept = document.getElementById('spDept').value;
            const teacherSel = document.getElementById('spTeacher');
            teacherSel.innerHTML = '<option value="">اختر المعلم/ة...</option>';
            if(selectedDept && DB.teachers) {
                const teachers = DB.teachers.filter(t => t.dept === selectedDept && t.status === 'active');
                if(teachers.length > 0) {
                    teachers.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.name; opt.innerText = t.name; teacherSel.appendChild(opt);
                    });
                } else {
                    teacherSel.innerHTML = '<option value="">لا يوجد معلمات في هذا القسم</option>';
                }
            }
        }

        function saveSpecialCase() {
            const type = document.getElementById('spType').value;
            const dept = document.getElementById('spDept').value;
            const teacher = document.getElementById('spTeacher').value;
            const eval = document.getElementById('spEval').value;
            const notes = document.getElementById('spNotes').value;
            if(!dept || !teacher || !eval) { alert('يرجى تعبئة الحقول المطلوبة (القسم، المعلم، التقدير)'); return; }
            const item = { id: Date.now(), type: type, dept: dept, teacher: teacher, eval: eval, notes: notes, dateAdded: new Date().toLocaleDateString('en-GB') };
            if(!DB.special_cases) DB.special_cases = [];
            DB.special_cases.push(item);
            const logType = type === 'distinguished' ? 'معلم متميز' : 'رعاية معلم';
            addSystemLog(logType, `إضافة: ${teacher} (${dept})`);
            saveDB(); renderSpecialCases(); closeModal('addSpecialCaseModal'); alert('تم الحفظ بنجاح');
        }

        function deleteSpecialCase(id) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                DB.special_cases = DB.special_cases.filter(x => x.id !== id);
                saveDB(); renderSpecialCases();
            }
        }

        function renderSpecialCases() {
            const distBody = document.getElementById('distinguishedTableBody');
            const careBody = document.getElementById('careTableBody');
            distBody.innerHTML = '';
            careBody.innerHTML = '';
            const list = DB.special_cases || [];
            const distList = list.filter(x => x.type === 'distinguished');
            const careList = list.filter(x => x.type === 'care');

            if(distList.length === 0) { distBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">لا يوجد بيانات</td></tr>'; } 
            else {
                distList.forEach(x => {
                    distBody.innerHTML += `<tr><td>${x.dept}</td><td style="font-weight:bold;">${x.teacher}</td><td><span class="status-badge status-active">${x.eval}</span></td><td style="text-align:right; font-size:0.9rem;">${x.notes || '-'}</td><td><button class="action-btn btn-delete" onclick="deleteSpecialCase(${x.id})"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            }

            if(careList.length === 0) { careBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">لا يوجد بيانات</td></tr>'; } 
            else {
                careList.forEach(x => {
                    careBody.innerHTML += `<tr><td>${x.dept}</td><td style="font-weight:bold;">${x.teacher}</td><td><span class="status-badge status-inactive">${x.eval}</span></td><td style="text-align:right; font-size:0.9rem;">${x.notes || '-'}</td><td><button class="action-btn btn-delete" onclick="deleteSpecialCase(${x.id})"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            }
            renderSpecialChart(distList.length, careList.length);
        }

        function renderSpecialChart(distCount, careCount) {
            const ctx = document.getElementById('specialChart').getContext('2d');
            if(specialChartInstance) { specialChartInstance.destroy(); }
            specialChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['المعلمين المتميزين', 'المعلمين ذوي الاحتياج'], datasets: [{ label: 'العدد', data: [distCount, careCount], backgroundColor: ['#28a745', '#dc3545'], borderWidth: 0, barThickness: 50 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { titleFont: { family: 'Cairo' }, bodyFont: { family: 'Cairo' } } } }
            });
        }

        document.getElementById('loginForm').addEventListener('submit', login);
        initSystem();
    </script>
</body>
</html>
