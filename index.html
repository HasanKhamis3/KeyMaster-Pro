<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إتقان لمتابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; --disabled: #e9ecef; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login Page Styling */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-logo-container { margin-bottom: 25px; }
        .login-logo-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 10px; }
        .login-title { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin: 0; }
        .login-subtitle { color: #777; font-size: 0.9rem; margin-top: 5px; display: block; }

        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .form-control:disabled { background-color: var(--disabled); cursor: not-allowed; color: #666; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* Dashboard Specific Styles */
        .dashboard-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .stat-card::before { content: ''; position: absolute; right: 0; top: 0; height: 100%; width: 5px; background: var(--primary); }
        .stat-card.blue::before { background: var(--primary); }
        .stat-card.green::before { background: var(--success); }
        .stat-card.red::before { background: var(--danger); }
        .stat-card.orange::before { background: var(--warning); }
        
        .stat-info h3 { font-size: 2rem; margin: 0; font-weight: 700; color: #333; }
        .stat-info p { margin: 0; font-size: 0.9rem; color: #777; font-weight: 600; }
        .stat-icon-bg { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .bg-light-blue { background: #eef4ff; color: var(--primary); }
        .bg-light-green { background: #e8f7ec; color: var(--success); }
        .bg-light-red { background: #fdeaea; color: var(--danger); }
        .bg-light-orange { background: #fff8e1; color: var(--warning); }

        .dashboard-charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 992px) { .dashboard-charts-row { grid-template-columns: 1fr; } }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.04); overflow: hidden; }
        .chart-title { font-weight: bold; margin-bottom: 20px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        .reason-cell { white-space: pre-wrap; text-align: right; line-height: 1.6; min-width: 250px; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Filters */
        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 150px; font-weight: bold; color: var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* ========================================= */
        /* STRICT WORD REPORT SIMULATION STYLES     */
        /* ========================================= */
        .report-preview-container {
            background: #525659;
            padding: 30px;
            overflow: auto;
            max-height: 800px;
            display: flex;
            justify-content: center;
        }
        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm; /* Standard Word Margins */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            position: relative;
            color: black;
            font-family: 'Tajawal', 'Cairo', sans-serif;
            direction: rtl;
            box-sizing: border-box;
        }
        
        /* Typography matching the Word Doc */
        .word-header-table { width: 100%; margin-bottom: 20px; border: none; }
        .word-header-table td { border: none; vertical-align: middle; padding: 0; }
        
        .word-title-box {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            margin: 15px auto;
            width: 90%;
            background-color: #f2f2f2; /* Light gray fill */
        }
        .word-title-box h2 {
            margin: 0;
            font-size: 16pt;
            font-weight: bold;
            font-family: 'Tajawal', sans-serif;
        }
        
        .word-meta-info {
            text-align: center;
            font-weight: bold;
            font-size: 14pt;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .word-signatures-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 10px;
            font-weight: bold;
            font-size: 12pt;
        }

        .word-section-title {
            font-weight: bold;
            text-decoration: underline;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 12pt;
            color: black; /* Strict black */
        }

        /* Strict Table Styling */
        .word-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 11pt;
            page-break-inside: avoid;
        }
        .word-table th {
            border: 1px solid #000;
            padding: 5px;
            background-color: #e6e6e6; /* Standard Word Table Header Gray */
            text-align: center;
            font-weight: bold;
            vertical-align: middle;
        }
        .word-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        .word-table td.align-right { text-align: right; }
        
        /* Stats List */
        .word-stats-list {
            font-size: 12pt;
            margin-bottom: 15px;
            line-height: 1.8;
            padding-right: 20px;
        }

        @media print {
            body * { visibility: hidden; }
            .a4-page, .a4-page * { visibility: visible; }
            .a4-page { position: absolute; left: 0; top: 0; margin: 0; padding: 20mm; width: 100%; box-shadow: none; height: auto; }
            .sidebar, .top-header, .filter-container, .btn, .custom-tabs { display: none !important; }
            .report-preview-container { background: white; padding: 0; overflow: visible; display: block; }
            /* Force page breaks */
            .page-break { page-break-before: always; }
        }

        .saved-report-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px; background: #fff; }
        .saved-report-info h4 { margin: 0 0 5px 0; color: var(--primary); }
        .saved-report-info small { color: #777; }

    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <div class="login-logo-container">
                <i class="fas fa-graduation-cap login-logo-icon"></i>
                <h1 class="login-title">نظام إتقان</h1>
                <span class="login-subtitle">لمتابعة جودة التعليم</span>
            </div>
            <h2 style="color:#555; margin:0 0 20px 0; font-size:1.2rem;">تسجيل الدخول</h2>
            <form id="loginForm" onsubmit="login(event)">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div class="password-wrapper" style="margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" onclick="togglePass('loginPass', this)"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <div id="loginError" style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 6px; margin-top: 15px; font-size: 0.9rem; line-height: 1.5; display: none; text-align: center;"></div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">إتقان</div><small id="sidebarSchoolName" style="color:#888;">...</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-distinguished"><a onclick="navigate('distinguished')" data-page="distinguished"><i class="fas fa-star"></i> المعلمين المتميزين</a></li>
                <li id="nav-qualitative"><a onclick="navigate('qualitative')" data-page="qualitative"><i class="fas fa-file-alt"></i> التقرير النوعي</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير جودة التعليم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">...</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active">
                <div class="filter-container" style="justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label class="filter-label"><i class="fas fa-calendar-alt"></i> تصفية البيانات حسب الشهر:</label>
                        <select id="dashMonthFilter" class="filter-select" onchange="renderDashboard()">
                            <option value="all">كل الأشهر</option>
                            <option value="01">يناير</option>
                            <option value="02">فبراير</option>
                            <option value="03">مارس</option>
                            <option value="04">أبريل</option>
                            <option value="05">مايو</option>
                            <option value="06">يونيو</option>
                            <option value="07">يوليو</option>
                            <option value="08">أغسطس</option>
                            <option value="09">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                    <div style="color: #777; font-weight: bold; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> يتم عرض الإحصائيات بناءً على الشهر المحدد
                    </div>
                </div>
                <div class="dashboard-stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-info"><h3 id="stat_total_visits">0</h3><p>إجمالي الزيارات الصفية</p></div>
                        <div class="stat-icon-bg bg-light-blue"><i class="fas fa-clipboard-check"></i></div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-info"><h3 id="stat_distinguished">0</h3><p>المعلمين المتميزين</p></div>
                        <div class="stat-icon-bg bg-light-green"><i class="fas fa-star"></i></div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info"><h3 id="stat_qualitative">0</h3><p>التقارير النوعية</p></div>
                        <div class="stat-icon-bg bg-light-orange"><i class="fas fa-file-alt"></i></div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-info"><h3 id="stat_care">0</h3><p>معلمين بحاجة لرعاية</p></div>
                        <div class="stat-icon-bg bg-light-red"><i class="fas fa-hand-holding-heart"></i></div>
                    </div>
                </div>
                <div class="dashboard-charts-row">
                    <div class="chart-box">
                        <div class="chart-title"><span>توزيع الزيارات حسب الأقسام</span><i class="fas fa-chart-bar" style="color:#aaa;"></i></div>
                        <div style="position: relative; height: 250px; width: 100%;"><canvas id="dashBarChart"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title"><span>نسب التقييم</span><i class="fas fa-chart-pie" style="color:#aaa;"></i></div>
                        <div style="position: relative; height: 250px; width: 100%;"><canvas id="dashPieChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <button id="btnAddVisit" class="btn btn-primary btn-restricted" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>
                <table class="custom-table">
                    <thead><tr><th width="15%">التاريخ</th><th width="15%">القسم</th><th width="20%">اسم المعلمة</th><th width="15%">التقييم</th><th width="15%">الزائر</th><th width="10%">الوظيفة</th><th width="10%">الإجراءات</th></tr></thead>
                    <tbody id="visitsTableBody"></tbody>
                </table>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> اختر الشهر:</label>
                    <select id="perfMonthFilter" class="filter-select" onchange="renderPerformanceChart()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div style="padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <canvas id="perfChart" width="400" height="150"></canvas>
                </div>
            </div>

            <div id="distinguished" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">المعلمين المتميزين والأولى بالرعاية</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="distMonthFilter" class="filter-select" onchange="renderDistinguishedTables()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div class="btn-group-restricted" style="display:flex; gap:15px; margin-bottom:25px;">
                    <button class="btn" style="background:#2c5aa0; color:white;" onclick="openDistinguishedModal('distinguished')"><i class="fas fa-plus-circle"></i> إضافة معلم متميز</button>
                    <button class="btn" style="background:#da291c; color:white;" onclick="openDistinguishedModal('care')"><i class="fas fa-plus-circle"></i> إضافة معلم يحتاج رعاية</button>
                </div>
                <div class="table-section-title">المعلمين المتميزين</div>
                <table class="custom-table">
                    <thead><tr id="distHeadRow"><th width="5%">#</th><th width="20%">اسم المعلم/ة</th><th width="15%">القسم</th><th width="10%">التقدير</th><th width="30%">المبررات</th><th width="20%" class="col-actions">الإجراء</th></tr></thead>
                    <tbody id="distinguishedTableBody"></tbody>
                </table>
                <div class="table-section-title" style="margin-top:40px;">المعلمين الأولى بالرعاية</div>
                <table class="custom-table">
                    <thead><tr id="careHeadRow"><th width="5%">#</th><th width="20%">اسم المعلم/ة</th><th width="15%">القسم</th><th width="10%">التقدير</th><th width="30%">المبررات</th><th width="20%" class="col-actions">الإجراء</th></tr></thead>
                    <tbody id="careTableBody"></tbody>
                </table>
            </div>

            <div id="qualitative" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">التقرير النوعي</h3>
                    <button class="btn btn-primary btn-restricted" style="width:auto;" onclick="openQualitativeModal()"><i class="fas fa-plus"></i> إضافة تقرير</button>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="qualMonthFilter" class="filter-select" onchange="renderQualitativeTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <table class="custom-table">
                    <thead><tr><th width="5%">#</th><th width="15%">الأقسام الأكاديمية</th><th width="30%">جوانب القوة</th><th width="30%">جوانب بحاجة إلى تطوير</th><th width="20%" class="col-actions">الإجراء</th></tr></thead>
                    <tbody id="qualitativeTableBody"></tbody>
                </table>
            </div>

            <div id="quality-report" class="section-card">
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setReportTab('create', this)">إنشاء تقرير</div>
                    <div class="custom-tab" onclick="setReportTab('saved', this)">سجل التقارير المحفوظة</div>
                </div>

                <div id="report-create-pane">
                    <div class="filter-container" style="justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label class="filter-label">شهر التقرير:</label>
                            <select id="reportMonthSelect" class="filter-select">
                                <option value="01">يناير</option>
                                <option value="02">فبراير</option>
                                <option value="03">مارس</option>
                                <option value="04">أبريل</option>
                                <option value="05">مايو</option>
                                <option value="06">يونيو</option>
                                <option value="07">يوليو</option>
                                <option value="08">أغسطس</option>
                                <option value="09">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateQualityReport()"> إصدار التقرير</button>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-view" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
                            <button class="btn btn-edit" onclick="exportToWord()"><i class="fas fa-file-word"></i> تصدير Word</button>
                            <button class="btn btn-toggle" onclick="saveReport()"><i class="fas fa-save"></i> حفظ</button>
                        </div>
                    </div>

                    <div class="report-preview-container">
                        <div id="a4-report-content" class="a4-page">
                            <div style="text-align:center; padding:50px; color:#888;">
                                <i class="fas fa-file-alt" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
                                يرجى اختيار الشهر والضغط على "إصدار التقرير"
                            </div>
                        </div>
                    </div>
                </div>

                <div id="report-saved-pane" style="display:none;">
                    <div id="savedReportsList"></div>
                </div>
            </div>

            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn" style="background:#28a745; color:white;" onclick="triggerImportExcel()"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                        <input type="file" id="importExcelInput" hidden accept=".xlsx, .xls, .csv" onchange="handleExcelImport(this)">
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>
                <table class="custom-table">
                    <thead><tr id="tableHeadRow"></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
            
            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>
                <div id="gen" class="setting-content-pane active">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">اسم المدرسة</label>
                        <input type="text" id="confSchool" class="form-control" placeholder="أدخل اسم المدرسة">
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">العام الدراسي</label>
                        <input type="text" id="confYear" class="form-control" placeholder="مثال: 2025 / 2026م">
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار الوزارة</label>
                        <input type="file" id="file_ministry" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_ministry', 'ministryLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_ministry">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_ministry')"><i class="fas fa-upload"></i> تحميل شعار الوزارة</button>
                            <span class="upload-hint">الحجم المقترح: 200x80 بكسل</span>
                        </div>
                        <div id="preview_wrap_ministry" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_ministry" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_ministry', 'ministryLogo', 'file_ministry')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار المدرسة</label>
                        <input type="file" id="file_school" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_school', 'schoolLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_school">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_school')"><i class="fas fa-upload"></i> تحميل شعار المدرسة</button>
                            <span class="upload-hint">الحجم المقترح: 200x200 بكسل</span>
                        </div>
                        <div id="preview_wrap_school" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_school" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_school', 'schoolLogo', 'file_school')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">ختم المدرسة</label>
                        <input type="file" id="file_stamp" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_stamp', 'schoolStamp')">
                        <div class="upload-btn-wrapper" id="btn_wrap_stamp">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_stamp')"><i class="fas fa-upload"></i> تحميل ختم المدرسة</button>
                            <span class="upload-hint">يستخدم في التقارير الرسمية</span>
                        </div>
                        <div id="preview_wrap_stamp" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_stamp" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_stamp', 'schoolStamp', 'file_stamp')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div style="text-align: left; border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary setting-edit-btn" style="width: 200px;" onclick="saveGeneralSettings()">حفظ الإعدادات</button>
                    </div>
                </div>
                <div id="sig" class="setting-content-pane">
                    <div class="signature-grid">
                        <div class="signature-card">
                            <div class="signature-title">مدير/ة المدرسة</div>
                            <div class="form-group">
                                <select id="sig_director" class="form-control" onchange="onSigChange()"><option value="">اختر مدير المدرسة</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary setting-edit-btn" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_director')">إزالة</button>
                            </div>
                        </div>
                        <div class="signature-card">
                            <div class="signature-title">المدير/ة المساعد/ة</div>
                            <div class="form-group">
                                <select id="sig_assistant" class="form-control" onchange="onSigChange()"><option value="">اختر المدير المساعد</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary setting-edit-btn" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_assistant')">إزالة</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header"><span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <form id="addUserForm"> <input type="hidden" id="editUserId"> <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required> <div id="deptWrapper" class="form-group" style="display:none;"> <label>القسم</label><select id="addDept" class="form-control"></select> </div> <div id="userFields"> <label>الوظيفة</label><input type="text" id="addJob" class="form-control"> <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control"> <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control"> <label>كلمة المرور</label><input type="password" id="addPass" class="form-control"> </div> </form> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="saveUserForm()">حفظ</button> <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button> </div> </div> </div>
    <div id="distinguishedModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header"><span id="distinguishedModalTitle">إضافة</span> <span onclick="closeModal('distinguishedModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <form id="distinguishedForm"> <input type="hidden" id="distType"> <input type="hidden" id="distEditId"> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label> <select id="distDept" class="form-control" onchange="onDistinguishedDeptChange()"><option value="">اختر القسم...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">اسم المعلم/ة</label> <select id="distTeacher" class="form-control"><option value="">اختر المعلم/ة...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">التقدير</label> <select id="distEval" class="form-control"><option value="">اختر التقدير...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">المبررات / ملاحظات</label> <textarea id="distReason" class="form-control" rows="4"></textarea> </div> </form> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="saveDistinguishedEntry()">حفظ البيانات</button> <button class="btn" style="background:#ddd;" onclick="closeModal('distinguishedModal')">إلغاء</button> </div> </div> </div>
    <div id="addQualitativeModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header"><span>إضافة تقرير نوعي</span> <span onclick="closeModal('addQualitativeModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <form id="qualitativeForm"> <input type="hidden" id="qualEditId"> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label> <select id="qualDept" class="form-control"><option value="">اختر القسم...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب القوة</label> <textarea id="qualStrength" class="form-control" rows="4" placeholder="سجل جوانب القوة هنا..."></textarea> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب بحاجة إلى تطوير</label> <textarea id="qualImprove" class="form-control" rows="4" placeholder="سجل جوانب التطوير هنا..."></textarea> </div> </form> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="saveQualitative()">حفظ</button> <button class="btn" style="background:#ddd;" onclick="closeModal('addQualitativeModal')">إلغاء</button> </div> </div> </div>
    <div id="addVisitModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <form id="addVisitForm"> <input type="hidden" id="visitEditId"> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label> <select id="visitDept" class="form-control" onchange="onVisitDeptChange()"><option value="">اختر القسم...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">المعلم/ة</label> <select id="visitTeacher" class="form-control"><option value="">اختر المعلم/ة...</option></select> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">تاريخ الزيارة</label> <input type="date" id="visitDate" class="form-control"> </div> <div class="form-group"> <label style="font-weight:bold; display:block; margin-bottom:5px;">التقييم</label> <select id="visitEval" class="form-control"><option value="">اختر التقييم...</option></select> </div> </form> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="saveVisit()">حفظ</button> <button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button> </div> </div> </div>
    <div id="viewVisitModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header">تفاصيل الزيارة <span onclick="closeModal('viewVisitModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body" id="viewVisitContent"> </div> <div class="modal-footer"> <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewVisitModal')">إغلاق</button> </div> </div> </div>
    <div id="addEvalModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <form id="addEvalForm"> <input type="hidden" id="editEvalId"> <label>اسم المعيار</label> <input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال"> </form> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button> <button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button> </div> </div> </div>
    <div id="viewUserModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body" id="viewUserContent"></div> <div class="modal-footer"><button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button></div> </div> </div>
    <div id="permModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <h4 id="permTargetName" style="margin-top:0; color:var(--primary); margin-bottom:15px;"></h4> <div class="perm-header"> <span>تحديد الكل</span> <div style="display:flex; gap:15px;"> <label><input type="checkbox" onchange="toggleAllPerms('view', this)"> الكل معاينة</label> <label><input type="checkbox" onchange="toggleAllPerms('edit', this)"> الكل تعديل</label> </div> </div> <div class="perm-list" id="permList"></div> </div> <div class="modal-footer"> <button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button> <button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button> </div> </div> </div>
    <div id="imageViewModal" class="modal-overlay" onclick="closeModal('imageViewModal')"> <div style="position:relative; max-width:90%; max-height:90%;"> <span onclick="closeModal('imageViewModal')" style="position:absolute; top:-40px; right:0; color:white; font-size:30px; cursor:pointer;">&times;</span> <img id="fullImage" src="" style="max-width:100%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(0,0,0,0.5);"> </div> </div>
    <div id="visitorPickerModal" class="modal-overlay"> <div class="modal-box"> <div class="modal-header">اختر اسماً للإضافة <span onclick="closeModal('visitorPickerModal')" style="cursor:pointer;">&times;</span></div> <div class="modal-body"> <input type="text" id="visitorSearch" class="form-control" placeholder="بحث عن اسم..." onkeyup="filterPickerList()"> <div id="pickerList" class="picker-list"></div> </div> <div class="modal-footer"><button class="btn" style="background:#ddd;" onclick="closeModal('visitorPickerModal')">إغلاق</button></div> </div> </div>

    <script>
        // ... (Previous JS Logic for System Init, Login, Routing, CRUD operations remains identical) ...
        // I will copy the logic and insert the REWRITTEN generateQualityReport function below.

        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'distinguished', name: 'المعلمين المتميزين'},
            {id: 'qualitative', name: 'التقرير النوعي'},
            {id: 'quality-report', name: 'تقرير جودة التعليم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const DB_KEY = 'Etqan_System_DB_Final';

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [], teachers: [], departments: [],
            visits_senior: [], visits_middle: [],
            distinguished: [], care_needed: [], qualitative_reports: [], saved_reports: [],
            settings: { schoolName: 'مدرسة مدينة حمد الابتدائية للبنات', schoolYear: '2025 / 2026م', evaluation_criteria: [], visitor_order_senior: [], visitor_order_middle: [] },
            logs: [] 
        };
        SECTIONS.forEach(sec => { INITIAL_DB.admins[0].permissions[sec.id] = {view: true, edit: true}; });

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior'; 
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;
        let performanceChartInstance = null; 
        let dashBarChartInst = null;
        let dashPieChartInst = null;

        // ... (Standard helper functions: canEdit, initSystem, saveDB, etc. omitted for brevity, they are the same as before) ...
        function canEdit(pageId) { if(!CURRENT_USER) return false; const p = CURRENT_USER.permissions || DEFAULT_PERMS; return (p[pageId] && p[pageId].edit === true); }
        function initSystem() { const storedDB = localStorage.getItem(DB_KEY); if (storedDB) { try { DB = JSON.parse(storedDB); if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins)); if(!DB.senior) DB.senior = []; if(!DB.middle) DB.middle = []; if(!DB.teachers) DB.teachers = []; if(!DB.departments) DB.departments = []; if(!DB.visits_senior) DB.visits_senior = []; if(!DB.visits_middle) DB.visits_middle = []; if(!DB.distinguished) DB.distinguished = []; if(!DB.care_needed) DB.care_needed = []; if(!DB.qualitative_reports) DB.qualitative_reports = []; if(!DB.saved_reports) DB.saved_reports = []; if(!DB.logs) DB.logs = []; if(!DB.settings) DB.settings = {}; DB.settings = {...INITIAL_DB.settings, ...DB.settings}; saveDB(); } catch (e) { DB = JSON.parse(JSON.stringify(INITIAL_DB)); saveDB(); } } else { DB = JSON.parse(JSON.stringify(INITIAL_DB)); saveDB(); } const sessionID = localStorage.getItem('Etqan_Session'); if (sessionID) { let found = null; ['admins', 'senior', 'middle', 'teachers'].forEach(grp => { if(DB[grp]) { const u = DB[grp].find(x => x.id == sessionID); if(u) found = u; } }); if (found && found.status === 'active') { CURRENT_USER = found; showApp(); } else { localStorage.removeItem('Etqan_Session'); document.getElementById('loginPage').style.display = 'flex'; } } else { document.getElementById('loginPage').style.display = 'flex'; } }
        function saveDB() { if(DB && DB.admins) localStorage.setItem(DB_KEY, JSON.stringify(DB)); }
        function addSystemLog(action, details) { const logEntry = { id: Date.now(), date: new Date().toLocaleString('en-GB'), user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر', action: action, details: details }; if(!DB.logs) DB.logs = []; DB.logs.unshift(logEntry); if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500); saveDB(); }
        function login(e) { e.preventDefault(); const uInput = document.getElementById('loginUser').value.trim(); const pInput = document.getElementById('loginPass').value.trim(); let userFound = null; ['admins', 'senior', 'middle', 'teachers'].forEach(grp => { if(DB[grp]) { const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput); if(match) userFound = match; } }); if (userFound) { if (userFound.status !== 'active') return alert('الحساب غير نشط'); CURRENT_USER = userFound; localStorage.setItem('Etqan_Session', userFound.id); showApp(); } else { document.getElementById('loginError').innerText = "بيانات غير صحيحة"; document.getElementById('loginError').style.display = 'block'; } }
        function logout() { localStorage.removeItem('Etqan_Session'); location.reload(); }
        function navigate(pageId) { 
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            if (target) target.classList.add('active');
            const activeSection = SECTIONS.find(s => s.id === pageId);
            if(activeSection) document.getElementById('pageTitle').innerText = activeSection.name;
            if(pageId === 'dashboard') renderDashboard();
            if(pageId === 'settings') loadSettings();
            if(pageId === 'visits') renderVisitsTable(); 
            if(pageId === 'performance') renderPerformanceChart();
            if(pageId === 'distinguished') renderDistinguishedTables(); 
            if(pageId === 'qualitative') renderQualitativeTable();
            if(pageId === 'quality-report') { const d = new Date(); document.getElementById('reportMonthSelect').value = String(d.getMonth()+1).padStart(2,'0'); }
        }
        function showApp() { document.getElementById('loginPage').style.display = 'none'; document.getElementById('app').style.display = 'flex'; document.getElementById('headerUserName').innerText = CURRENT_USER.name; document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم'; document.getElementById('sidebarSchoolName').innerText = DB.settings.schoolName || 'وزارة التربية'; navigate('dashboard'); }
        function togglePass(fieldId, icon) { const input = document.getElementById(fieldId); if (input.type === "password") { input.type = "text"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); } else { input.type = "password"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); } }

        // ... (Paste rest of CRUD functions from previous response here for user management, settings, etc.) ...
        // For brevity, I am assuming the previous logic exists. I will focus on the REPORT LOGIC.

        // ============================================
        // STRICT QUALITY REPORT GENERATION (Word Style)
        // ============================================

        function getMonthName(m) {
            const months = {"01":"يناير", "02":"فبراير", "03":"مارس", "04":"أبريل", "05":"مايو", "06":"يونيو", "07":"يوليو", "08":"أغسطس", "09":"سبتمبر", "10":"أكتوبر", "11":"نوفمبر", "12":"ديسمبر"};
            return months[m] || m;
        }

        function generateQualityReport() {
            const month = document.getElementById('reportMonthSelect').value;
            const monthName = getMonthName(month);
            
            // Gather Data
            let seniorVisits = (DB.visits_senior || []).filter(v => v.date.split('-')[1] === month);
            let middleVisits = (DB.visits_middle || []).filter(v => v.date.split('-')[1] === month);
            let allVisits = [...seniorVisits, ...middleVisits];
            
            let distinguished = (DB.distinguished || []).filter(x => x.date && x.date.split('-')[1] === month);
            let care = (DB.care_needed || []).filter(x => x.date && x.date.split('-')[1] === month);
            let qualitative = (DB.qualitative_reports || []).filter(x => x.date && x.date.split('-')[1] === month);
            
            const totalVisits = seniorVisits.length + middleVisits.length;

            // -- HTML Construction --
            let html = `
            <div style="width:100%;">
                
                <table class="word-header-table">
                    <tr>
                        <td width="33%" align="right">
                            ${DB.settings.ministryLogo ? `<img src="${DB.settings.ministryLogo}" style="height:70px;">` : 'وزارة التربية والتعليم'}
                        </td>
                        <td width="34%" align="center">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Emblem_of_Bahrain.svg/1200px-Emblem_of_Bahrain.svg.png" style="height:80px;">
                        </td>
                        <td width="33%" align="left" style="font-size:14pt; font-weight:bold; line-height:1.4;">
                            مملكة البحرين<br>
                            وزارة التربية والتعليم<br>
                            ${DB.settings.schoolName || ''}
                        </td>
                    </tr>
                </table>

                <div class="word-title-box">
                    <h2>تقرير متابعة جودة التعليم والتعلم للقيادة العليا والوسطى</h2>
                </div>

                <div class="word-meta-info">
                    شهر ${monthName}<br>
                    العام الدراسي ${DB.settings.schoolYear}
                </div>

                <div class="word-signatures-top">
                    <div>إعداد المديرة المساعدة<br><span style="font-weight:normal;">${DB.settings.sig_assistant || ''}</span></div>
                    <div>يعتمد، مديرة المدرسة<br><span style="font-weight:normal;">${DB.settings.sig_director || ''}</span></div>
                </div>

                <div class="word-section-title">أولاً: متابعة تسليم القيادة الوسطى (الزيارات/محاضر الاجتماعات /الخطة الأسبوعية) للمواد الدراسية الى المدير/ة المساعد/ة في المدرسة</div>
                
                <table class="word-table">
                    <thead>
                        <tr>
                            <th width="20%">القسم</th>
                            <th width="15%">عدد استمارات الزيارات الصفية</th>
                            <th width="15%">يوجد محضر اجتماع</th>
                            <th width="15%">توجد خطة أسبوعية</th>
                            <th width="35%">أسباب عدم التسليم</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            (DB.departments || []).forEach(d => {
                const count = middleVisits.filter(v => v.dept === d.name).length;
                const hasVisits = count > 0;
                html += `<tr>
                    <td>${d.name}</td>
                    <td>${count}</td>
                    <td>${hasVisits ? 'يوجد' : '-'}</td>
                    <td>${hasVisits ? 'يوجد' : '-'}</td>
                    <td></td>
                </tr>`;
            });
            
            html += `</tbody></table>
            <div style="font-size:11pt; margin-bottom:20px;"><b>ملاحظات عامة:</b> يتم التنسيق مع القيادة الوسطى لتنفيذ الزيارات الصفية بحسب ما يتناسب مع ظروف الجداول والنصاب المسند لهم.</div>

            <div class="word-section-title">ثانياً: عدد الزيارات التي نُفذت خلال شهر ${monthName} من قبل:</div>
            <div class="word-stats-list">
                1- القيادة العليا = <b>${seniorVisits.length}</b> زيارة<br>
                2- القيادة الوسطى = <b>${middleVisits.length}</b> زيارة<br>
                المجموع الكلي = <b>${totalVisits}</b> زيارة
            </div>

            <div class="page-break"></div>

            <div class="word-section-title">ثالثًا: بيان أسماء المعلمين المُزارين من قبل القيادة العليا والوسطى خلال شهر ${monthName}</div>
            <table class="word-table">
                <thead>
                    <tr>
                        <th width="5%">ت</th>
                        <th width="25%">اسم المعلم</th>
                        <th width="15%">القسم</th>
                        <th width="15%">تاريخ الزيارة</th>
                        <th width="20%">تقييم الزيارة</th>
                        <th width="20%">اسم الزائر</th>
                    </tr>
                </thead>
                <tbody>`;

            // Grouping Logic for Section 3
            // Group 1: Director
            // Group 2: Asst Director
            // Group 3+: Middle Leaders
            
            // Helper to render a group rows
            const renderGroup = (visitorName, jobTitle, visits) => {
                let rows = '';
                if(visits.length === 0) return '';
                visits.forEach((v, idx) => {
                    rows += `<tr>
                        <td>${idx + 1}</td>
                        <td>${v.teacher}</td>
                        <td>${v.dept}</td>
                        <td>${v.date}</td>
                        <td>${v.eval}</td>
                        ${idx === 0 ? `<td rowspan="${visits.length + 1}" style="vertical-align:top;"><b>${visitorName}</b><br><small>${jobTitle}</small></td>` : ''}
                    </tr>`;
                });
                rows += `<tr><td colspan="5" style="text-align:left; background:#f9f9f9; font-weight:bold;">مجموع الزيارات = ${visits.length}</td></tr>`;
                return rows;
            };

            // 1. Director
            const directorName = DB.settings.sig_director;
            const dirVisits = seniorVisits.filter(v => v.visitor === directorName);
            html += renderGroup(directorName || 'مديرة المدرسة', 'مديرة المدرسة', dirVisits);

            // 2. Asst Director
            const asstName = DB.settings.sig_assistant;
            const asstVisits = seniorVisits.filter(v => v.visitor === asstName);
            html += renderGroup(asstName || 'المديرة المساعدة', 'المديرة المساعدة', asstVisits);

            // 3. Middle Leaders (Grouped by name)
            const middleVisitors = [...new Set(middleVisits.map(v => v.visitor))];
            middleVisitors.forEach(visName => {
                const visits = middleVisits.filter(v => v.visitor === visName);
                const job = visits[0]?.visitorJob || 'معلم أول/منسق';
                html += renderGroup(visName, job, visits);
            });

            html += `<tr><td colspan="6" style="background:#e6e6e6; font-weight:bold; text-align:center;">مجموع الزيارات الكلية = ${totalVisits} زيارة</td></tr>`;
            html += `</tbody></table>

            <div class="page-break"></div>

            <div class="word-section-title">رابعاً: عدد الزيارات الصفية وتقييم الأداء الصفي</div>
            <table class="word-table">
                <thead>
                    <tr>
                        <th rowspan="2">م</th>
                        <th rowspan="2">الأقسام الأكاديمية</th>
                        <th rowspan="2">المجموع</th>
                        <th colspan="4">مستويات الأداء</th>
                    </tr>
                    <tr>
                        <th>يتجاوز التوقعات بكثير</th>
                        <th>يتجاوز التوقعات</th>
                        <th>يفي بالتوقعات</th>
                        <th>يفي جزئياً</th>
                    </tr>
                </thead>
                <tbody>`;
            
            // Generate Stats Table
            let totalExceedsLot = 0, totalExceeds = 0, totalMeets = 0, totalPartial = 0;
            (DB.departments || []).forEach((d, idx) => {
                const deptVisits = allVisits.filter(v => v.dept === d.name);
                const c1 = deptVisits.filter(v => v.eval.includes('ممتاز') || v.eval.includes('بكثير')).length;
                const c2 = deptVisits.filter(v => v.eval.includes('جيد جدا') || v.eval === 'يتجاوز التوقعات').length;
                const c3 = deptVisits.filter(v => v.eval === 'جيد' || v.eval === 'يفي بالتوقعات').length;
                const c4 = deptVisits.filter(v => v.eval.includes('مقبول') || v.eval.includes('جزئيا') || v.eval.includes('ضعيف')).length;
                
                totalExceedsLot += c1; totalExceeds += c2; totalMeets += c3; totalPartial += c4;

                html += `<tr>
                    <td>${idx + 1}</td>
                    <td>${d.name}</td>
                    <td>${deptVisits.length}</td>
                    <td>${c1 || ''}</td>
                    <td>${c2 || ''}</td>
                    <td>${c3 || ''}</td>
                    <td>${c4 || ''}</td>
                </tr>`;
            });
            html += `<tr style="background:#f2f2f2; font-weight:bold;">
                <td colspan="2">المجموع الكلي</td>
                <td>${totalVisits}</td>
                <td>${totalExceedsLot}</td>
                <td>${totalExceeds}</td>
                <td>${totalMeets}</td>
                <td>${totalPartial}</td>
            </tr></tbody></table>

            <div style="text-align:center; margin:30px 0; border:1px solid #ddd; padding:10px;">
                ${document.getElementById('perfChart') ? `<img src="${document.getElementById('perfChart').toDataURL()}" style="max-width:100%; height:auto;">` : ''}
            </div>

            <div class="page-break"></div>

            <div class="word-section-title">سادساً: حصر أسماء المعلمين المتميزين في الأقسام الأكاديمية</div>
            <table class="word-table">
                <thead><tr><th width="5%">م</th><th width="25%">اسم المعلم</th><th width="15%">التقدير</th><th width="40%">المبررات</th><th width="15%">القسم</th></tr></thead>
                <tbody>`;
            distinguished.forEach((d, i) => {
                html += `<tr><td>${i+1}</td><td>${d.teacher}</td><td>${d.eval}</td><td class="align-right">${d.reason}</td><td>${d.dept}</td></tr>`;
            });
            if(distinguished.length === 0) html += `<tr><td colspan="5">لا يوجد</td></tr>`;
            html += `</tbody></table>

            <div class="word-section-title">حصر أسماء المعلمين الأولى بالرعاية في الأقسام الأكاديمية</div>
            <table class="word-table">
                <thead><tr><th width="5%">م</th><th width="25%">اسم المعلم</th><th width="15%">التقدير</th><th width="40%">المبررات/جوانب القصور</th><th width="15%">القسم</th></tr></thead>
                <tbody>`;
            care.forEach((d, i) => {
                html += `<tr><td>${i+1}</td><td>${d.teacher}</td><td>${d.eval}</td><td class="align-right">${d.reason}</td><td>${d.dept}</td></tr>`;
            });
            if(care.length === 0) html += `<tr><td colspan="5">لا يوجد</td></tr>`;
            html += `</tbody></table>

            <div class="page-break"></div>

            <div class="word-section-title">سابعًا: التقرير النوعي (جوانب القوة والتطوير)</div>
            <table class="word-table">
                <thead><tr><th width="20%">القسم الأكاديمي</th><th width="40%">جوانب القوة</th><th width="40%">جوانب بحاجة إلى تطوير</th></tr></thead>
                <tbody>`;
            qualitative.forEach(q => {
                html += `<tr><td>${q.dept}</td><td class="align-right">${q.strength}</td><td class="align-right">${q.improve}</td></tr>`;
            });
            if(qualitative.length === 0) html += `<tr><td colspan="3">لم يتم إدخال تقارير لهذا الشهر</td></tr>`;
            html += `</tbody></table>

            </div>`; // End wrapper

            document.getElementById('a4-report-content').innerHTML = html;
        }

        // ... (Rest of standard functions: printReport, saveReport, exportToWord, etc.) ...
        function printReport() { window.print(); }
        function saveReport() { 
            const content = document.getElementById('a4-report-content').innerHTML; 
            if(content.includes('يرجى اختيار الشهر')) return alert('يرجى إصدار التقرير أولاً');
            const month = document.getElementById('reportMonthSelect').value;
            const rpt = { id: Date.now(), name: `تقرير جودة التعليم - شهر ${getMonthName(month)}`, date: new Date().toLocaleString('en-GB'), html: content }; 
            if(!DB.saved_reports) DB.saved_reports = []; DB.saved_reports.unshift(rpt); saveDB(); alert('تم الحفظ'); 
        }
        function renderSavedReports() { const div = document.getElementById('savedReportsList'); div.innerHTML = ''; (DB.saved_reports || []).forEach((r, i) => { div.innerHTML += `<div class="saved-report-item"><div class="saved-report-info"><h4>${r.name}</h4><small>${r.date}</small></div><div><button class="btn btn-view" onclick="loadSavedReport(${i})"><i class="fas fa-eye"></i> معاينة</button><button class="btn btn-delete" onclick="deleteSavedReport(${i})"><i class="fas fa-trash"></i></button></div></div>`; }); }
        function loadSavedReport(idx) { document.getElementById('a4-report-content').innerHTML = DB.saved_reports[idx].html; setReportTab('create', document.querySelector('.custom-tab:first-child')); }
        function deleteSavedReport(idx) { if(confirm('حذف؟')) { DB.saved_reports.splice(idx, 1); saveDB(); renderSavedReports(); } }
        function exportToWord() { 
            const htmlContent = document.getElementById('a4-report-content').innerHTML; 
            if(htmlContent.includes('يرجى اختيار')) return alert('يرجى إصدار التقرير');
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title><style>body{font-family:'Tajawal', 'Cairo', sans-serif;} table{border-collapse:collapse; width:100%;} td,th{border:1px solid black; padding:5px;} .word-title-box{background:#f2f2f2; border:1px solid black; text-align:center; padding:10px;}</style></head><body dir='rtl'>"; 
            const footer = "</body></html>"; 
            const sourceHTML = header+htmlContent+footer; 
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML); 
            const fileDownload = document.createElement("a"); document.body.appendChild(fileDownload); fileDownload.href = source; fileDownload.download = 'تقرير_الجودة.doc'; fileDownload.click(); document.body.removeChild(fileDownload); 
        }

        // Initialize
        window.onload = function() { initSystem(); };

    </script>
</body>
</html>
