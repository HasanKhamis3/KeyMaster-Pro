<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* Tables & Tabs */
        .user-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .user-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; }
        .user-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Buttons in Table */
        .action-btn { padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.85rem; margin: 0 2px; transition: 0.2s; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }

        /* Settings */
        .settings-layout { display: flex; gap: 20px; align-items: flex-start; }
        .settings-sidebar { width: 250px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; flex-shrink: 0; }
        .settings-sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--primary); text-align: center; }
        .settings-nav-item { display: block; padding: 12px 20px; color: #666; text-decoration: none; transition: 0.3s; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        .settings-nav-item:hover { background-color: #f8f9fa; color: var(--primary); }
        .settings-nav-item.active { background-color: var(--primary); color: white; border-right: 4px solid #15305b; }
        .settings-content-area { flex-grow: 1; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 30px; min-height: 500px; }
        .setting-tab-pane { display: none; }
        .setting-tab-pane.active { display: block; animation: fadeIn 0.3s; }

        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 40px; }
        .password-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }
        
        .perm-list { border: 1px solid #eee; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .perm-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .image-upload-container { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: 0.3s; }

        .user-view-card { text-align: center; margin-bottom: 20px; }
        .user-view-avatar { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-item label { display: block; color: #777; font-size: 0.85rem; margin-bottom: 5px; }
        .info-item span { font-weight: bold; color: #333; }

        @media print { .sidebar, .login-wrapper { display: none; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <img src="https://www.moe.gov.bh/img/logo.png" width="80" style="margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">تسجيل الدخول</h2>
            <form id="loginForm">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div class="password-wrapper" style="margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" onclick="togglePass('loginPass', this)"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <p id="loginError" style="color:red; font-size:0.9rem; margin-top:10px; display:none; line-height:1.6; font-weight:bold;"></p>
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px;">
                    <button type="button" class="btn" style="background:#6c757d; color:white; font-size:0.7rem; padding:5px 10px;" onclick="resetSystem()">إعادة ضبط المصنع (Reset)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">جودة التعليم</div><small style="color:#888;">وزارة التربية</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير الجودة</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">لوحة التحكم</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active"><h3>لوحة التحكم</h3><p>مرحباً بك في النظام</p></div>
            
            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    
                    <div id="userActionButtons" style="display:flex; gap:10px;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportCSV()"><i class="fas fa-file-export"></i> تصدير CSV</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط - لا توجد صلاحية تعديل)</div>
                </div>

                <div class="user-tabs">
                    <div class="user-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="user-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="user-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="user-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr id="tableHeadRow">
                            </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <div id="visits" class="section-card"><h3>الزيارات الصفية</h3></div>
            <div id="performance" class="section-card"><h3>تقييم الأداء</h3></div>
            <div id="quality-report" class="section-card"><h3>تقرير الجودة</h3></div>
            
            <div id="settings" class="section-card">
                <div class="settings-layout">
                    <div class="settings-sidebar">
                        <div class="settings-sidebar-header">الإعدادات</div>
                        <div class="settings-nav-item active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                        <div class="settings-nav-item" onclick="setSettingTab('rep', this)">إعدادات تقرير الجودة</div>
                        <div class="settings-nav-item" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                        <div class="settings-nav-item" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                        <div class="settings-nav-item" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                        <div class="settings-nav-item" onclick="setSettingTab('log', this)">سجل النظام</div>
                    </div>
                    <div class="settings-content-area">
                        <div id="gen" class="setting-tab-pane active">
                            <h3 style="color:var(--primary); margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">الإعدادات العامة</h3>
                            <div class="form-group"><label>اسم المدرسة</label><input type="text" id="confSchool" class="form-control" value="مدرسة مدينة حمد الابتدائية للبنات"></div>
                            <div class="form-group"><label>العام الدراسي</label><input type="text" id="confYear" class="form-control" value="2025 / 2026م"></div>
                            <button class="btn btn-primary" onclick="alert('تم الحفظ')">حفظ الإعدادات</button>
                        </div>
                        <div id="rep" class="setting-tab-pane"><h3>إعدادات تقرير الجودة</h3></div>
                        <div id="sig" class="setting-tab-pane"><h3>إعدادات التوقيعات</h3></div>
                        <div id="vis" class="setting-tab-pane"><h3>ترتيب الزوار</h3></div>
                        <div id="fot" class="setting-tab-pane"><h3>إعدادات التذييل</h3></div>
                        <div id="log" class="setting-tab-pane"><h3>سجل النظام</h3></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required>
                    
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveNewUser()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="viewUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewUserContent"></div>
            <div class="modal-footer">
                <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="permModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <h4 id="permTargetName" style="margin-top:0; color:var(--primary);"></h4>
                <div class="perm-list" id="permList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // === System Configuration ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'quality-report', name: 'تقرير الجودة'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [],
            teachers: [],
            departments: []
        };

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let EDITING_PERM_ID = null;

        // === Core Functions ===
        function initSystem() {
            const storedDB = localStorage.getItem('QualitySys_DB_V2');
            if (storedDB) {
                DB = JSON.parse(storedDB);
                
                // Ensure departments array exists
                if(!DB.departments) DB.departments = [];

                // Cleanup and ensure permissions
                ['admins', 'senior', 'middle', 'teachers', 'departments'].forEach(grp => {
                    if(DB[grp]) {
                        DB[grp].forEach(u => { 
                            if(grp !== 'departments') { 
                                if(!u.permissions) u.permissions = JSON.parse(JSON.stringify(DEFAULT_PERMS));
                                u.login = String(u.login).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                                u.pass = String(u.pass).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                            }
                            if(!u.status) u.status = 'active'; 
                        });
                    }
                });
                
                // Force Admin Login & Permissions (Restores Admin if deleted or broken)
                if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins));
                const adm = DB.admins.find(u => u.login === 'admin');
                if(adm) { 
                    adm.pass = 'Hasan@12';
                    adm.job = 'مدير النظام';
                    adm.status = 'active'; // Always active
                    SECTIONS.forEach(sec => {
                        if(!adm.permissions[sec.id]) adm.permissions[sec.id] = {};
                        adm.permissions[sec.id].view = true;
                        adm.permissions[sec.id].edit = true;
                    });
                } else { 
                    const newAdmin = JSON.parse(JSON.stringify(INITIAL_DB.admins[0]));
                    SECTIONS.forEach(sec => { newAdmin.permissions[sec.id] = {view: true, edit: true}; });
                    DB.admins.push(newAdmin); 
                }
                saveDB();
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                const adm = DB.admins[0];
                SECTIONS.forEach(sec => { adm.permissions[sec.id] = {view: true, edit: true}; });
                saveDB();
            }

            const sessionID = localStorage.getItem('QualitySys_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    const u = DB[grp].find(x => x.id == sessionID);
                    if(u) found = u;
                });
                
                // Strict Session Check
                if (found && found.status === 'active') {
                    CURRENT_USER = found;
                    showApp();
                } else {
                    document.getElementById('loginPage').style.display = 'flex';
                }
            } else {
                document.getElementById('loginPage').style.display = 'flex';
            }
        }

        function saveDB() { localStorage.setItem('QualitySys_DB_V2', JSON.stringify(DB)); }

        // === STRICT LOGIN LOGIC ===
        function login(e) {
            e.preventDefault();
            const errBox = document.getElementById('loginError');
            errBox.style.display = 'none';
            errBox.innerText = '';

            const uInput = document.getElementById('loginUser').value.trim();
            const pInput = document.getElementById('loginPass').value.trim();
            let userFound = null;

            // Search for user with matching credentials
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput);
                if(match) userFound = match;
            });

            if (userFound) {
                // FOUND MATCH - NOW CHECK STATUS
                if (userFound.status === 'active') {
                    CURRENT_USER = userFound;
                    localStorage.setItem('QualitySys_Session', userFound.id);
                    showApp();
                } else {
                    // FOUND BUT INACTIVE
                    errBox.innerText = "عذراً، لا يمكنك تسجيل الدخول لأن حسابك معطل.\nيرجى التواصل مع المشرف للمساعدة.";
                    errBox.style.display = 'block';
                }
            } else {
                // NOT FOUND OR WRONG PASSWORD
                errBox.innerText = "بيانات غير صحيحة. يرجى التأكد من اسم المستخدم وكلمة المرور.";
                errBox.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('QualitySys_Session');
            location.reload();
        }

        function resetSystem() {
            if(confirm('تحذير: سيتم حذف كافة البيانات. هل أنت متأكد؟')) {
                localStorage.removeItem('QualitySys_DB_V2');
                localStorage.removeItem('QualitySys_Session');
                location.reload();
            }
        }

        // === Permissions System ===
        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) {
                alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة.");
                return;
            }
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');
            if(pageId === 'settings') document.getElementById('settings').style.display = 'block';
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم';
            applySidebarPermissions();
            renderTable();
            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
            });
        }

        // === Tabs & Table ===
        function setTab(tab, el) {
            CURRENT_TAB = tab;
            document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
            renderTable();
        }

        function renderTable() {
            const headRow = document.getElementById('tableHeadRow');
            const tbody = document.getElementById('usersTableBody');
            const addBtn = document.getElementById('addBtnMain');
            
            tbody.innerHTML = '';
            
            // Permission Check
            const userPerms = CURRENT_USER.permissions['user-management'] || {view:true, edit:false};
            const canEdit = userPerms.edit === true;

            const actionButtons = document.getElementById('userActionButtons');
            const noEditMsg = document.getElementById('noEditPermissionMsg');
            
            if(canEdit) {
                actionButtons.style.display = 'flex';
                noEditMsg.style.display = 'none';
            } else {
                actionButtons.style.display = 'none';
                noEditMsg.style.display = 'block';
            }

            // Define Columns based on Tab
            if (CURRENT_TAB === 'departments') {
                headRow.innerHTML = `
                    <th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th>
                    <th width="10%">الترتيب</th>
                    <th width="40%">اسم القسم</th>
                    <th width="15%">الحالة</th>
                    <th width="30%">الإدارة</th>
                `;
                addBtn.innerText = "إضافة قسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()'); 
            } else {
                headRow.innerHTML = `
                    <th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th>
                    <th width="5%">#</th>
                    <th width="25%">الاسم</th>
                    <th width="15%">الوظيفة</th>
                    <th width="15%">الحالة</th>
                    <th width="35%">الإجراءات</th>
                `;
                addBtn.innerText = "إضافة اسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()');
            }

            const list = DB[CURRENT_TAB] || [];
            list.forEach((u, idx) => {
                const isActive = u.status === 'active';
                const statusBadge = isActive 
                    ? `<span class="status-badge status-active">مفعل</span>`
                    : `<span class="status-badge status-inactive">معطل</span>`;

                let row = `<td><input type="checkbox" class="custom-checkbox user-select-cb" value="${u.id}" ${canEdit ? '' : 'disabled'}></td>`;
                row += `<td>${idx+1}</td><td>${u.name}</td>`;
                
                if (CURRENT_TAB !== 'departments') {
                    row += `<td>${u.job || (CURRENT_TAB === 'teachers' ? u.dept : '-')}</td>`;
                }
                
                row += `<td>${statusBadge}</td>`;
                row += `<td><div style="display:flex; justify-content:center; gap:2px;">`;
                
                // Dept Actions
                if (CURRENT_TAB === 'departments') {
                    if(canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                                <button class="action-btn btn-edit" onclick="editUser(${u.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})" title="حذف"><i class="fas fa-trash"></i></button>`;
                    } else {
                        row += `<span style="color:#999; font-size:0.8rem;">لا توجد صلاحية</span>`;
                    }
                } else {
                    // User Actions
                    row += `<button class="action-btn btn-view" onclick="viewUser(${u.id})" title="معاينة"><i class="fas fa-eye"></i></button>`;
                    if (canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                                <button class="action-btn btn-edit" onclick="editUser(${u.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})" title="حذف"><i class="fas fa-trash"></i></button>
                                <button class="action-btn btn-perm" onclick="openPerms(${u.id})" title="الصلاحيات"><i class="fas fa-key"></i></button>`;
                    }
                }
                
                row += `</div></td>`;
                const tr = document.createElement('tr');
                tr.innerHTML = row;
                tbody.appendChild(tr);
            });
        }

        // --- Bulk Actions ---
        function toggleSelectAll(source) {
            document.querySelectorAll('.user-select-cb').forEach(cb => { if(!cb.disabled) cb.checked = source.checked; });
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            if(confirm(`هل أنت متأكد من حذف ${checkboxes.length} عنصر؟`)) {
                const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => !idsToDelete.includes(u.id));
                saveDB();
                renderTable();
                document.getElementById('selectAll').checked = false;
            }
        }

        function toggleStatusSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            const idsToToggle = Array.from(checkboxes).map(cb => parseInt(cb.value));
            DB[CURRENT_TAB].forEach(u => {
                if(idsToToggle.includes(u.id)) u.status = (u.status === 'active') ? 'inactive' : 'active';
            });
            saveDB();
            renderTable();
        }

        function toggleStatus(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            if(u) {
                u.status = (u.status === 'active') ? 'inactive' : 'active';
                saveDB();
                renderTable();
            }
        }

        function exportCSV() {
            const list = DB[CURRENT_TAB] || [];
            if (list.length === 0) { alert("لا يوجد بيانات للتصدير"); return; }
            let csvContent = "";
            if (CURRENT_TAB === 'departments') {
                csvContent = "الترتيب,اسم القسم,الحالة\n";
                list.forEach((row, idx) => {
                    csvContent += `${idx+1},"${row.name}","${row.status}"\n`;
                });
            } else {
                csvContent = "الاسم الكامل,الوظيفة,رقم الهاتف,اسم المستخدم,كلمة المرور,تاريخ الإضافة,الحالة\n";
                list.forEach(row => {
                    csvContent += `"${row.name}","${row.job||row.dept}","${row.phone}","${row.login}","${row.pass}","${row.dateAdded}","${row.status}"\n`;
                });
            }
            const bom = "\uFEFF";
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${CURRENT_TAB}_export.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === Modal Logic ===
        function openAddUserModal() { 
            const isDept = (CURRENT_TAB === 'departments');
            document.getElementById('userFields').style.display = isDept ? 'none' : 'block';
            document.getElementById('addUserModalTitle').innerText = isDept ? 'إضافة قسم جديد' : 'إضافة مستخدم جديد';
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModal').style.display = 'flex'; 
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function saveNewUser() {
            const name = document.getElementById('addName').value.trim();
            if(!name) { alert("يرجى إدخال الاسم"); return; }

            const newItem = {
                id: Date.now(),
                name: name,
                status: 'active'
            };

            if (CURRENT_TAB !== 'departments') {
                newItem.job = document.getElementById('addJob').value.trim();
                newItem.phone = document.getElementById('addPhone').value.trim();
                newItem.login = document.getElementById('addLogin').value.trim();
                newItem.pass = document.getElementById('addPass').value.trim();
                newItem.dateAdded = new Date().toLocaleDateString('en-GB');
                newItem.permissions = JSON.parse(JSON.stringify(DEFAULT_PERMS));
            }

            DB[CURRENT_TAB].push(newItem);
            saveDB();
            renderTable();
            closeModal('addUserModal');
        }

        function deleteUser(id) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => u.id !== id);
                saveDB();
                renderTable();
            }
        }

        function editUser(id) {
            alert("ميزة التعديل السريع قيد التنفيذ، يرجى الحذف والإضافة إذا لزم الأمر حالياً.");
        }

        function viewUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            const content = document.getElementById('viewUserContent');
            // Hide password in view modal
            content.innerHTML = `
                <div class="user-view-card">
                    <div class="user-view-avatar">${u.name.charAt(0)}</div>
                    <h3 style="color:var(--primary); margin:0;">${u.name}</h3>
                </div>
                <div class="info-grid">
                    <div class="info-item"><label>الوظيفة</label><span>${u.job || u.dept || '-'}</span></div>
                    <div class="info-item"><label>رقم الهاتف</label><span>${u.phone || '-'}</span></div>
                    <div class="info-item"><label>الحالة</label><span style="color:${u.status==='active'?'green':'red'}">${u.status==='active'?'مفعل':'معطل'}</span></div>
                    <div class="info-item"><label>اسم الدخول</label><span style="background:#eee; padding:2px 5px; border-radius:4px;">${u.login}</span></div>
                </div>
            `;
            document.getElementById('viewUserModal').style.display = 'flex';
        }

        function openPerms(id) {
            if (CURRENT_TAB === 'departments') return;
            EDITING_PERM_ID = id;
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            document.getElementById('permTargetName').innerText = 'صلاحيات: ' + u.name;
            const container = document.getElementById('permList');
            container.innerHTML = '';
            const userPerms = u.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const p = userPerms[sec.id] || {view: true, edit: false};
                container.innerHTML += `
                <div class="perm-item">
                    <span>${sec.name}</span>
                    <div style="display:flex; gap:15px;">
                        <label><input type="checkbox" id="pv_${sec.id}" ${p.view ? 'checked' : ''}> معاينة</label>
                        <label><input type="checkbox" id="pe_${sec.id}" ${p.edit ? 'checked' : ''}> تعديل</label>
                    </div>
                </div>`;
            });
            document.getElementById('permModal').style.display = 'flex';
        }

        function submitPermissions() {
            const u = DB[CURRENT_TAB].find(x => x.id === EDITING_PERM_ID);
            SECTIONS.forEach(sec => {
                if(!u.permissions[sec.id]) u.permissions[sec.id] = {};
                u.permissions[sec.id].view = document.getElementById(`pv_${sec.id}`).checked;
                u.permissions[sec.id].edit = document.getElementById(`pe_${sec.id}`).checked;
            });
            saveDB();
            if (CURRENT_USER.id === u.id) { 
                CURRENT_USER = u; 
                applySidebarPermissions(); 
                renderTable();
            }
            closeModal('permModal');
        }

        function togglePass(id, icon) {
            const input = document.getElementById(id);
            if(input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); }
            else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
        }

        function setSettingTab(t,el) { 
            document.querySelectorAll('.setting-tab-pane').forEach(p=>p.classList.remove('active')); 
            document.getElementById(t).classList.add('active'); 
            document.querySelectorAll('.settings-nav-item').forEach(i=>i.classList.remove('active')); 
            el.classList.add('active'); 
        }

        document.getElementById('loginForm').addEventListener('submit', login);
        initSystem();
    </script>
</body>
</html>
