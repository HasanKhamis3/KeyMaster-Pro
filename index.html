<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة جودة التعليم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #1e4078; --text: #333; --bg: #f7f9fc; --danger: #da291c; --success: #28a745; --warning: #ffc107; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 10px; align-items: center; }
        .sidebar-header i { font-size: 1.8rem; color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #777; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f4f8; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 10px; width: 25px; text-align: center; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* Login */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), #2b2b2b); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .section-card.active { display: block; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        /* Specific Style for Reason/Text Cell to allow multiline */
        .reason-cell {
            white-space: pre-wrap; /* Allows text to wrap and preserves newlines */
            text-align: right;
            line-height: 1.6;
            min-width: 250px;
        }

        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Filters */
        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 150px; font-weight: bold; color: var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }

        /* --- Settings Specific Styles --- */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Image Upload Box Style */
        .upload-container {
            border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; transition: 0.3s;
        }
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .upload-btn-wrapper { margin-top: 10px; }
        .upload-btn-custom {
            background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px;
        }
        .upload-hint { display: block; margin-top: 5px; color: #888; font-size: 0.8rem; }
        .image-preview-wrapper {
            margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        .remove-img-btn {
            position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Signature Settings Styles --- */
        .signature-grid { display: flex; flex-direction: column; gap: 20px; }
        .signature-card { border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #fcfcfc; text-align: center; width: 100%; }
        .signature-title { color: var(--primary); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        
        /* --- Visitor Order Styles --- */
        .visitor-section { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: white; }
        .visitor-section-title { font-weight: bold; margin-bottom: 15px; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .visitor-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .visitor-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; background: #fff;
            transition: 0.2s;
        }
        .visitor-list-item:hover { background-color: #f9fbff; border-color: #cce5ff; }
        .visitor-name { font-weight: bold; color: #333; }
        .visitor-controls { display: flex; gap: 5px; }
        .empty-list-msg { color: #888; font-style: italic; padding: 15px; text-align: center; border: 1px dashed #ddd; border-radius: 6px; background: #fdfdfd; }
        .btn-add-visitor { background-color: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add-visitor:hover { opacity: 0.9; }

        /* --- System Log Styles --- */
        .log-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .log-details { font-size: 0.85rem; color: #666; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Picker Modal List */
        .picker-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .picker-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .picker-item:hover { background-color: #f0f4f8; }
        .picker-item:last-child { border-bottom: none; }
        .picker-item-name { font-weight: bold; }
        .picker-item-job { font-size: 0.8rem; color: #777; }

        /* Password Wrapper */
        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 40px; }
        .password-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }
        
        /* Permissions List */
        .perm-list { border: 1px solid #eee; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .perm-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .perm-header { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        
        /* User View */
        .user-view-card { text-align: center; margin-bottom: 20px; }
        .user-view-avatar { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-item label { display: block; color: #777; font-size: 0.85rem; margin-bottom: 5px; }
        .info-item span { font-weight: bold; color: #333; }

        /* Distinguished/Qualitative Section Table Title */
        .table-section-title { font-weight: bold; color: #555; margin-bottom: 10px; margin-top: 20px; border-right: 4px solid var(--primary); padding-right: 10px; }

        @media print { .sidebar, .login-wrapper { display: none; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <img src="https://www.moe.gov.bh/img/logo.png" width="80" style="margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">تسجيل الدخول</h2>
            <form id="loginForm">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <div class="password-wrapper" style="margin-bottom:20px;">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" onclick="togglePass('loginPass', this)"></i>
                </div>
                <button type="submit" class="btn btn-primary">دخول</button>
                <p id="loginError" style="color:red; font-size:0.9rem; margin-top:10px; display:none; line-height:1.6; font-weight:bold;"></p>
                <div style="margin-top:30px; border-top:1px solid #eee; padding-top:10px;">
                    <button type="button" class="btn" style="background:#6c757d; color:white; font-size:0.7rem; padding:5px 10px;" onclick="resetSystem()">إعادة ضبط المصنع (Reset)</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <div><div style="font-weight:bold;">جودة التعليم</div><small style="color:#888;">وزارة التربية</small></div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-distinguished"><a onclick="navigate('distinguished')" data-page="distinguished"><i class="fas fa-star"></i> المعلمين المتميزين</a></li>
                <li id="nav-qualitative"><a onclick="navigate('qualitative')" data-page="qualitative"><i class="fas fa-file-alt"></i> التقرير النوعي</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير الجودة</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">لوحة التحكم</h2>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active"><h3>لوحة التحكم</h3><p>مرحباً بك في النظام</p></div>
            
            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportCSV()"><i class="fas fa-file-export"></i> تصدير CSV</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr id="tableHeadRow">
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <div id="distinguished" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">المعلمين المتميزين والأولى بالرعاية</h3>
                
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="distMonthFilter" class="filter-select" onchange="renderDistinguishedTables()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div style="display:flex; gap:15px; margin-bottom:25px;">
                    <button class="btn" style="background:#2c5aa0; color:white;" onclick="openDistinguishedModal('distinguished')">
                        <i class="fas fa-plus-circle"></i> إضافة معلم متميز
                    </button>
                    <button class="btn" style="background:#da291c; color:white;" onclick="openDistinguishedModal('care')">
                        <i class="fas fa-plus-circle"></i> إضافة معلم يحتاج رعاية
                    </button>
                </div>

                <div class="table-section-title">المعلمين المتميزين</div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="20%">اسم المعلم/ة</th>
                            <th width="15%">القسم</th>
                            <th width="10%">التقدير</th>
                            <th width="30%">المبررات</th>
                            <th width="20%">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="distinguishedTableBody">
                    </tbody>
                </table>

                <div class="table-section-title" style="margin-top:40px;">المعلمين الأولى بالرعاية</div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="20%">اسم المعلم/ة</th>
                            <th width="15%">القسم</th>
                            <th width="10%">التقدير</th>
                            <th width="30%">المبررات</th>
                            <th width="20%">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="careTableBody">
                    </tbody>
                </table>
            </div>

            <div id="qualitative" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">التقرير النوعي</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openQualitativeModal()"><i class="fas fa-plus"></i> إضافة تقرير</button>
                </div>

                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="qualMonthFilter" class="filter-select" onchange="renderQualitativeTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="15%">الأقسام الأكاديمية</th>
                            <th width="30%">جوانب القوة</th>
                            <th width="30%">جوانب بحاجة إلى تطوير</th>
                            <th width="20%">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="qualitativeTableBody">
                    </tbody>
                </table>
            </div>

            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                </div>

                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>

                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="15%">التاريخ</th>
                            <th width="15%">القسم</th>
                            <th width="20%">اسم المعلمة</th>
                            <th width="15%">التقييم</th>
                            <th width="20%">الزائر</th>
                            <th width="15%">وظيفة الزائر</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> اختر الشهر:</label>
                    <select id="perfMonthFilter" class="filter-select" onchange="renderPerformanceChart()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>

                <div style="padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <canvas id="perfChart" width="400" height="150"></canvas>
                </div>
            </div>

            <div id="quality-report" class="section-card"><h3>تقرير الجودة</h3></div>
            
            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>

                <div id="gen" class="setting-content-pane active">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">اسم المدرسة</label>
                        <input type="text" id="confSchool" class="form-control" placeholder="أدخل اسم المدرسة">
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">العام الدراسي</label>
                        <input type="text" id="confYear" class="form-control" placeholder="مثال: 2025 / 2026م">
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار الوزارة</label>
                        <input type="file" id="file_ministry" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_ministry', 'ministryLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_ministry">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_ministry')"><i class="fas fa-upload"></i> تحميل شعار الوزارة</button>
                            <span class="upload-hint">الحجم المقترح: 200x80 بكسل</span>
                        </div>
                        <div id="preview_wrap_ministry" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_ministry" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn" onclick="removeImage('preview_ministry', 'ministryLogo', 'file_ministry')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار المدرسة</label>
                        <input type="file" id="file_school" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_school', 'schoolLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_school">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_school')"><i class="fas fa-upload"></i> تحميل شعار المدرسة</button>
                            <span class="upload-hint">الحجم المقترح: 200x200 بكسل</span>
                        </div>
                        <div id="preview_wrap_school" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_school" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn" onclick="removeImage('preview_school', 'schoolLogo', 'file_school')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">ختم المدرسة</label>
                        <input type="file" id="file_stamp" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_stamp', 'schoolStamp')">
                        <div class="upload-btn-wrapper" id="btn_wrap_stamp">
                            <button type="button" class="upload-btn-custom" onclick="triggerFileSelect('file_stamp')"><i class="fas fa-upload"></i> تحميل ختم المدرسة</button>
                            <span class="upload-hint">يستخدم في التقارير الرسمية</span>
                        </div>
                        <div id="preview_wrap_stamp" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_stamp" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn" onclick="removeImage('preview_stamp', 'schoolStamp', 'file_stamp')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div style="text-align: left; border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary" style="width: 200px;" onclick="saveGeneralSettings()">حفظ الإعدادات</button>
                    </div>
                </div>

                <div id="sig" class="setting-content-pane">
                    <p style="margin-bottom:20px; color:#666;">تحديد الأشخاص المسؤولين عن توقيع التقرير من القيادة العليا</p>
                    <div class="signature-grid">
                        <div class="signature-card">
                            <div class="signature-title">مدير/ة المدرسة</div>
                            <div class="form-group">
                                <label style="display:block; text-align:right; margin-bottom:5px; color:#777;">اختر مدير/ة المدرسة</label>
                                <select id="sig_director" class="form-control"><option value="">اختر مدير المدرسة</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary" style="min-width:100px;" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn" style="background:#dc3545; color:white; min-width:100px;" onclick="clearSignature('sig_director')">إزالة</button>
                            </div>
                        </div>
                        <div class="signature-card">
                            <div class="signature-title">المدير/ة المساعد/ة</div>
                            <div class="form-group">
                                <label style="display:block; text-align:right; margin-bottom:5px; color:#777;">اختر المدير/ة المساعد/ة</label>
                                <select id="sig_assistant" class="form-control"><option value="">اختر المدير المساعد</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary" style="min-width:100px;" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn" style="background:#dc3545; color:white; min-width:100px;" onclick="clearSignature('sig_assistant')">إزالة</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fot" class="setting-content-pane">
                    <h3 style="color:var(--primary); margin-bottom:20px; font-weight:bold;">إعدادات تذييل التقرير</h3>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">النص الذي سيظهر في تذييل كل صفحة من التقرير</label>
                        <textarea id="footer_text" class="form-control" rows="5" placeholder="أدخل نص التذييل"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">محاذاة التذييل</label>
                        <select id="footer_align" class="form-control">
                            <option value="center">وسط</option>
                            <option value="right">يمين</option>
                            <option value="left">يسار</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">حجم الخط</label>
                        <select id="footer_fontsize" class="form-control">
                            <option value="10">10 نقطة</option>
                            <option value="12">12 نقطة</option>
                            <option value="14">14 نقطة</option>
                            <option value="16">16 نقطة</option>
                        </select>
                    </div>
                    <div style="text-align:left; margin-top:20px;">
                        <button class="btn" style="background:#28a745; color:white; font-weight:bold;" onclick="saveFooterSettings()">حفظ إعدادات التذييل</button>
                    </div>
                </div>

                <div id="eval" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                        <h3>الزيارة الصفية</h3>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn" style="background:#2c5aa0; color:white;" onclick="openAddEvalModal()"><i class="fas fa-plus"></i> إضافة تقييم</button>
                        </div>
                    </div>
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th width="10%">#</th>
                                <th width="55%">اسم المعيار</th>
                                <th width="10%">الحالة</th>
                                <th width="25%">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="evalTableBody"></tbody>
                    </table>
                </div>

                <div id="vis" class="setting-content-pane">
                    <p style="margin-bottom:20px; color:#666;">حدد ترتيب ظهور أسماء الزوار في تقرير الزيارات الصفية</p>
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة العليا</div>
                        <ul id="list_visitor_senior" class="visitor-list"><li class="empty-list-msg">لم يتم إضافة زوار بعد</li></ul>
                        <button class="btn-add-visitor" onclick="openVisitorPicker('senior')">+ إضافة زائر من القيادة العليا</button>
                    </div>
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة الوسطى</div>
                        <ul id="list_visitor_middle" class="visitor-list"><li class="empty-list-msg">لم يتم إضافة زوار بعد</li></ul>
                        <button class="btn-add-visitor" onclick="openVisitorPicker('middle')">+ إضافة زائر من القيادة الوسطى</button>
                    </div>
                    <div style="text-align: left; margin-top: 20px;">
                        <button class="btn btn-toggle" onclick="saveVisitorOrder()">حفظ الترتيب</button>
                    </div>
                </div>

                <div id="log" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="color:var(--primary); margin:0;">سجل العمليات (Audit Log)</h4>
                        <div>
                            <button class="btn" style="background:#17a2b8; color:white; font-size:0.8rem;" onclick="loadSystemLogs()"><i class="fas fa-sync"></i> تحديث</button>
                            <button class="btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="clearSystemLogs()"><i class="fas fa-trash"></i> مسح السجل</button>
                        </div>
                    </div>
                    <div class="log-table-wrapper">
                        <table class="custom-table" style="font-size:0.9rem;">
                            <thead>
                                <tr>
                                    <th width="20%">التاريخ والوقت</th>
                                    <th width="20%">المستخدم</th>
                                    <th width="20%">الحدث</th>
                                    <th width="40%">التفاصيل</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required>
                    <div id="deptWrapper" class="form-group" style="display:none;">
                        <label>القسم</label>
                        <select id="addDept" class="form-control"></select>
                    </div>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveUserForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="distinguishedModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="distinguishedModalTitle">إضافة</span> <span onclick="closeModal('distinguishedModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="distinguishedForm">
                    <input type="hidden" id="distType">
                    <input type="hidden" id="distEditId">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="distDept" class="form-control" onchange="onDistinguishedDeptChange()">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">اسم المعلم/ة</label>
                        <select id="distTeacher" class="form-control">
                            <option value="">اختر المعلم/ة...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقدير</label>
                        <select id="distEval" class="form-control">
                            <option value="">اختر التقدير...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المبررات / ملاحظات</label>
                        <textarea id="distReason" class="form-control" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveDistinguishedEntry()">حفظ البيانات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('distinguishedModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addQualitativeModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة تقرير نوعي</span> <span onclick="closeModal('addQualitativeModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="qualitativeForm">
                    <input type="hidden" id="qualEditId">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="qualDept" class="form-control">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب القوة</label>
                        <textarea id="qualStrength" class="form-control" rows="4" placeholder="سجل جوانب القوة هنا..."></textarea>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب بحاجة إلى تطوير</label>
                        <textarea id="qualImprove" class="form-control" rows="4" placeholder="سجل جوانب التطوير هنا..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveQualitative()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addQualitativeModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addVisitForm">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="visitDept" class="form-control" onchange="onVisitDeptChange()">
                            <option value="">اختر القسم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المعلم/ة</label>
                        <select id="visitTeacher" class="form-control">
                            <option value="">اختر المعلم/ة...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">تاريخ الزيارة</label>
                        <input type="date" id="visitDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقييم</label>
                        <select id="visitEval" class="form-control">
                            <option value="">اختر التقييم...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveVisit()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addEvalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addEvalForm">
                    <input type="hidden" id="editEvalId">
                    <label>اسم المعيار</label>
                    <input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="viewUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewUserContent"></div>
            <div class="modal-footer">
                <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="viewDetailsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">معاينة التفاصيل <span onclick="closeModal('viewDetailsModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewDetailsContent"></div>
            <div class="modal-footer">
                <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewDetailsModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="permModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <h4 id="permTargetName" style="margin-top:0; color:var(--primary); margin-bottom:15px;"></h4>
                <div class="perm-header">
                    <span>تحديد الكل</span>
                    <div style="display:flex; gap:15px;">
                        <label><input type="checkbox" onchange="toggleAllPerms('view', this)"> الكل معاينة</label>
                        <label><input type="checkbox" onchange="toggleAllPerms('edit', this)"> الكل تعديل</label>
                    </div>
                </div>
                <div class="perm-list" id="permList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="imageViewModal" class="modal-overlay" onclick="closeModal('imageViewModal')">
        <div style="position:relative; max-width:90%; max-height:90%;">
            <span onclick="closeModal('imageViewModal')" style="position:absolute; top:-40px; right:0; color:white; font-size:30px; cursor:pointer;">&times;</span>
            <img id="fullImage" src="" style="max-width:100%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        </div>
    </div>

    <div id="visitorPickerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">اختر اسماً للإضافة <span onclick="closeModal('visitorPickerModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <input type="text" id="visitorSearch" class="form-control" placeholder="بحث عن اسم..." onkeyup="filterPickerList()">
                <div id="pickerList" class="picker-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#ddd;" onclick="closeModal('visitorPickerModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // === System Configuration ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'distinguished', name: 'المعلمين المتميزين'},
            {id: 'qualitative', name: 'التقرير النوعي'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'quality-report', name: 'تقرير الجودة'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01'}],
            middle: [],
            teachers: [],
            departments: [],
            visits_senior: [], 
            visits_middle: [],
            distinguished: [], 
            care_needed: [],   
            qualitative_reports: [], // New Array for Qualitative Reports
            settings: {
                schoolName: 'مدرسة مدينة حمد الابتدائية للبنات',
                schoolYear: '2025 / 2026م',
                ministryLogo: '',
                schoolLogo: '',
                schoolStamp: '',
                signature_director_id: '',
                signature_assistant_id: '',
                visitor_order_senior: [],
                visitor_order_middle: [],
                footer_text: '',
                footer_align: 'center',
                footer_fontsize: '12',
                evaluation_criteria: []
            },
            logs: [] 
        };

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior'; 
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;
        let performanceChartInstance = null; 

        // === Core Functions ===
        function initSystem() {
            const storedDB = localStorage.getItem('QualitySys_DB_V2');
            if (storedDB) {
                DB = JSON.parse(storedDB);
                // Ensure arrays exist for updates
                if(!DB.departments) DB.departments = [];
                if(!DB.distinguished) DB.distinguished = []; 
                if(!DB.care_needed) DB.care_needed = []; 
                if(!DB.qualitative_reports) DB.qualitative_reports = []; // Ensure Qual Report exists
                if(!DB.settings) DB.settings = {};
                DB.settings = {...INITIAL_DB.settings, ...DB.settings};
                if(!DB.settings.evaluation_criteria) DB.settings.evaluation_criteria = [];
                if(!DB.logs) DB.logs = [];
                if(!DB.visits_senior) DB.visits_senior = [];
                if(!DB.visits_middle) DB.visits_middle = [];

                ['admins', 'senior', 'middle', 'teachers', 'departments'].forEach(grp => {
                    if(DB[grp] && Array.isArray(DB[grp])) {
                        DB[grp].forEach(u => { 
                            if(grp !== 'departments') { 
                                if(!u.permissions) u.permissions = JSON.parse(JSON.stringify(DEFAULT_PERMS));
                                u.login = String(u.login).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                                u.pass = String(u.pass).trim().replace(/[\uFEFF\x00-\x1F\s]/g, '');
                            }
                            if(!u.status) u.status = 'active'; 
                        });
                    }
                });
                
                if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins));
                const adm = DB.admins.find(u => u.login === 'admin');
                if(adm) { 
                    adm.pass = 'Hasan@12'; adm.job = 'مدير النظام'; adm.status = 'active'; 
                    SECTIONS.forEach(sec => { if(!adm.permissions[sec.id]) adm.permissions[sec.id] = {}; adm.permissions[sec.id].view = true; adm.permissions[sec.id].edit = true; });
                } else { 
                    const newAdmin = JSON.parse(JSON.stringify(INITIAL_DB.admins[0]));
                    SECTIONS.forEach(sec => { newAdmin.permissions[sec.id] = {view: true, edit: true}; });
                    DB.admins.push(newAdmin); 
                }
                saveDB();
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                const adm = DB.admins[0];
                SECTIONS.forEach(sec => { adm.permissions[sec.id] = {view: true, edit: true}; });
                saveDB();
            }

            const sessionID = localStorage.getItem('QualitySys_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) {
                        const u = DB[grp].find(x => x.id == sessionID);
                        if(u) found = u;
                    }
                });
                if (found && found.status === 'active') { CURRENT_USER = found; showApp(); }
                else { document.getElementById('loginPage').style.display = 'flex'; }
            } else { document.getElementById('loginPage').style.display = 'flex'; }
        }

        function saveDB() { localStorage.setItem('QualitySys_DB_V2', JSON.stringify(DB)); }

        // --- Logger Helper ---
        function addSystemLog(action, details) {
            const logEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('en-GB'),
                user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر',
                action: action,
                details: details
            };
            if(!DB.logs) DB.logs = [];
            DB.logs.unshift(logEntry); // Add to top
            if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500);
            saveDB();
        }

        function login(e) {
            e.preventDefault();
            const errBox = document.getElementById('loginError');
            errBox.style.display = 'none';
            errBox.innerText = '';

            const uInput = document.getElementById('loginUser').value.trim();
            const pInput = document.getElementById('loginPass').value.trim();
            let userFound = null;

            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                if(DB[grp]) {
                    const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput);
                    if(match) userFound = match;
                }
            });

            if (userFound) {
                if (userFound.status === 'active') {
                    CURRENT_USER = userFound;
                    localStorage.setItem('QualitySys_Session', userFound.id);
                    addSystemLog('تسجيل دخول', `المستخدم: ${userFound.name}`);
                    showApp();
                } else {
                    errBox.innerText = "نعتذر منك، الحساب غير نشط حالياً.";
                    errBox.style.display = 'block';
                }
            } else {
                errBox.innerText = "بيانات غير صحيحة.";
                errBox.style.display = 'block';
            }
        }

        function logout() { 
            if(CURRENT_USER) addSystemLog('تسجيل خروج', `المستخدم: ${CURRENT_USER.name}`);
            localStorage.removeItem('QualitySys_Session'); 
            location.reload(); 
        }

        function resetSystem() {
            if(confirm('تحذير: سيتم حذف كافة البيانات. هل أنت متأكد؟')) {
                localStorage.removeItem('QualitySys_DB_V2');
                localStorage.removeItem('QualitySys_Session');
                location.reload();
            }
        }

        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة."); return; }
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');
            
            if(pageId === 'settings') loadSettings();
            if(pageId === 'visits') renderVisitsTable(); 
            if(pageId === 'performance') renderPerformanceChart();
            if(pageId === 'distinguished') renderDistinguishedTables(); 
            if(pageId === 'qualitative') renderQualitativeTable(); // New Call
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم';
            applySidebarPermissions();
            renderTable();
            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
            });
        }

        function setTab(tab, el) {
            CURRENT_TAB = tab;
            document.querySelectorAll('.custom-tab').forEach(t => {
                 if(t.parentElement.previousElementSibling && t.parentElement.previousElementSibling.id === 'userActionButtons') {
                     // pass
                 } else if (el.parentElement === t.parentElement) {
                     t.classList.remove('active');
                 }
            });
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
            renderTable();
        }

        function renderTable() {
            const headRow = document.getElementById('tableHeadRow');
            const tbody = document.getElementById('usersTableBody');
            const addBtn = document.getElementById('addBtnMain');
            const bulkPermBtn = document.getElementById('bulkPermBtn');
            tbody.innerHTML = '';
            
            const userPerms = CURRENT_USER.permissions['user-management'] || {view:true, edit:false};
            const canEdit = userPerms.edit === true;
            const actionButtons = document.getElementById('userActionButtons');
            const noEditMsg = document.getElementById('noEditPermissionMsg');
            
            if(canEdit) { actionButtons.style.display = 'flex'; noEditMsg.style.display = 'none'; } 
            else { actionButtons.style.display = 'none'; noEditMsg.style.display = 'block'; }

            if (CURRENT_TAB === 'departments') {
                headRow.innerHTML = `
                    <th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th>
                    <th width="10%">الترتيب</th>
                    <th width="40%">اسم القسم</th>
                    <th width="15%">الحالة</th>
                    <th width="30%">الإدارة</th>
                `;
                addBtn.innerText = "إضافة قسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()'); 
                if(bulkPermBtn) bulkPermBtn.style.display = 'none'; 
            } else {
                headRow.innerHTML = `
                    <th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)"></th>
                    <th width="5%">#</th>
                    <th width="25%">الاسم</th>
                    <th width="15%">الوظيفة</th>
                    <th width="15%">الحالة</th>
                    <th width="35%">الإجراءات</th>
                `;
                addBtn.innerText = "إضافة اسم جديد";
                addBtn.setAttribute('onclick', 'openAddUserModal()');
                if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex';
            }

            const list = DB[CURRENT_TAB] || [];
            list.forEach((u, idx) => {
                const isActive = u.status === 'active';
                const statusBadge = isActive ? `<span class="status-badge status-active">مفعل</span>` : `<span class="status-badge status-inactive">معطل</span>`;
                let row = `<td><input type="checkbox" class="custom-checkbox user-select-cb" value="${u.id}" ${canEdit ? '' : 'disabled'}></td>`;
                row += `<td>${idx+1}</td><td>${u.name}</td>`;
                if (CURRENT_TAB !== 'departments') row += `<td>${u.job || (CURRENT_TAB === 'teachers' ? u.dept : '-')}</td>`;
                row += `<td>${statusBadge}</td>`;
                row += `<td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">`;
                if(canEdit) {
                    row += `<button class="action-btn btn-move" onclick="moveUser(${u.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button>`;
                    row += `<button class="action-btn btn-move" onclick="moveUser(${u.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button>`;
                }
                if (CURRENT_TAB === 'departments') {
                    if(canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button>
                                <button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button>`;
                    }
                } else {
                    row += `<button class="action-btn btn-view" onclick="viewUser(${u.id})"><i class="fas fa-eye"></i> معاينة</button>`;
                    if (canEdit) {
                        row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button>
                                <button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button>
                                <button class="action-btn btn-perm" onclick="openPerms(${u.id})"><i class="fas fa-key"></i> صلاحيات</button>`;
                    }
                }
                row += `</div></td>`;
                const tr = document.createElement('tr');
                tr.innerHTML = row;
                tbody.appendChild(tr);
            });
        }

        // ... [Include other basic functions like moveUser, toggleSelectAll, deleteSelected, toggleStatusSelected, toggleStatus, exportCSV, openAddUserModal, editUser, closeModal, saveUserForm, deleteUser, viewUser, openBulkPerms, openPerms, toggleAllPerms, submitPermissions, togglePass, setSettingTab, loadSettings, showImagePreview, triggerFileSelect, handleFileUpload, removeImage, saveGeneralSettings, openImageModal, loadSignatureSettings, saveSignatureSettings, clearSignature, loadVisitorSettings, renderVisitorList, openVisitorPicker, filterPickerList, addVisitorToOrder, removeVisitorItem, moveVisitorItem, saveVisitorOrder, loadFooterSettings, saveFooterSettings, loadEvaluationSettings, openAddEvalModal, saveEvalForm, deleteEval, toggleEvalStatus, moveEval, loadSystemLogs, clearSystemLogs, setVisitTab, openAddVisitModal, onVisitDeptChange, saveVisit, getLatestJobTitle, renderVisitsTable, renderPerformanceChart] ...
        // (Due to space, I'm keeping the core structure, assuming previous functions exist)
        
        // Re-declaring key small functions for completeness if copy-pasted:
        function moveUser(id, direction) {
            const list = DB[CURRENT_TAB];
            const index = list.findIndex(u => u.id === id);
            if (index === -1) return;
            if (direction === 'up' && index > 0) { [list[index], list[index - 1]] = [list[index - 1], list[index]]; } 
            else if (direction === 'down' && index < list.length - 1) { [list[index], list[index + 1]] = [list[index + 1], list[index]]; }
            saveDB(); renderTable();
        }
        function toggleSelectAll(source) { document.querySelectorAll('.user-select-cb').forEach(cb => { if(!cb.disabled) cb.checked = source.checked; }); }
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            if(confirm(`هل أنت متأكد من حذف ${checkboxes.length} عنصر؟`)) {
                const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => !idsToDelete.includes(u.id));
                addSystemLog('حذف جماعي', `حذف ${idsToDelete.length} عنصر من ${CURRENT_TAB}`);
                saveDB(); renderTable(); document.getElementById('selectAll').checked = false;
            }
        }
        function toggleStatusSelected() {
            const checkboxes = document.querySelectorAll('.user-select-cb:checked');
            if(checkboxes.length === 0) { alert('لم يتم تحديد أي عنصر.'); return; }
            const idsToToggle = Array.from(checkboxes).map(cb => parseInt(cb.value));
            DB[CURRENT_TAB].forEach(u => { if(idsToToggle.includes(u.id)) u.status = (u.status === 'active') ? 'inactive' : 'active'; });
            addSystemLog('تغيير حالة جماعي', `تعديل ${idsToToggle.length} عنصر في ${CURRENT_TAB}`);
            saveDB(); renderTable();
        }
        function toggleStatus(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            if(u) { u.status = (u.status === 'active') ? 'inactive' : 'active'; addSystemLog('تغيير حالة', `المستخدم/القسم: ${u.name} - الحالة الجديدة: ${u.status}`); saveDB(); renderTable(); }
        }
        function exportCSV() {
            const list = DB[CURRENT_TAB] || [];
            if (list.length === 0) { alert("لا يوجد بيانات للتصدير"); return; }
            let csvContent = (CURRENT_TAB === 'departments') ? "الترتيب,اسم القسم,الحالة\n" : "الاسم الكامل,الوظيفة,رقم الهاتف,اسم المستخدم,كلمة المرور,تاريخ الإضافة,الحالة\n";
            list.forEach((row, idx) => {
                 if(CURRENT_TAB === 'departments') csvContent += `${idx+1},"${row.name}","${row.status}"\n`;
                 else csvContent += `"${row.name}","${row.job||row.dept}","${row.phone}","${row.login}","${row.pass}","${row.dateAdded}","${row.status}"\n`;
            });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${CURRENT_TAB}_export.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            addSystemLog('تصدير بيانات', `تصدير قائمة ${CURRENT_TAB}`);
        }
        function openAddUserModal() { 
            document.getElementById('editUserId').value = ''; document.getElementById('addUserForm').reset(); document.getElementById('addUserModal').style.display = 'flex'; 
            const isDept = (CURRENT_TAB === 'departments'); const isTeacher = (CURRENT_TAB === 'teachers');
            if (isDept) { document.getElementById('addUserModalTitle').innerText = 'إضافة قسم جديد'; document.getElementById('userFields').style.display = 'none'; document.getElementById('deptWrapper').style.display = 'none'; } 
            else if (isTeacher) { document.getElementById('addUserModalTitle').innerText = 'إضافة معلمة جديدة'; document.getElementById('userFields').style.display = 'none'; document.getElementById('deptWrapper').style.display = 'block'; const sel = document.getElementById('addDept'); sel.innerHTML = '<option value="">اختر القسم...</option>'; if(DB.departments) DB.departments.forEach(d => {sel.innerHTML += `<option value="${d.name}">${d.name}</option>`}); } 
            else { document.getElementById('addUserModalTitle').innerText = 'إضافة مستخدم جديد'; document.getElementById('userFields').style.display = 'block'; document.getElementById('deptWrapper').style.display = 'none'; }
        }
        function editUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id); if(!u) return;
            document.getElementById('editUserId').value = u.id; document.getElementById('addName').value = u.name;
            const isDept = (CURRENT_TAB === 'departments'); const isTeacher = (CURRENT_TAB === 'teachers');
            if (isDept) { document.getElementById('userFields').style.display = 'none'; document.getElementById('deptWrapper').style.display = 'none'; } 
            else if (isTeacher) { document.getElementById('userFields').style.display = 'none'; document.getElementById('deptWrapper').style.display = 'block'; const sel = document.getElementById('addDept'); sel.innerHTML = '<option value="">اختر القسم...</option>'; if(DB.departments) DB.departments.forEach(d => {const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name; if(u.dept===d.name) opt.selected=true; sel.appendChild(opt);}); } 
            else { document.getElementById('userFields').style.display = 'block'; document.getElementById('deptWrapper').style.display = 'none'; document.getElementById('addJob').value = u.job||u.dept||''; document.getElementById('addPhone').value = u.phone||''; document.getElementById('addLogin').value = u.login||''; document.getElementById('addPass').value = u.pass||''; }
            document.getElementById('addUserModalTitle').innerText = 'تعديل البيانات'; document.getElementById('addUserModal').style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function saveUserForm() {
            const name = document.getElementById('addName').value.trim(); if(!name) { alert("يرجى إدخال الاسم"); return; }
            const editId = document.getElementById('editUserId').value; const isEdit = editId !== '';
            let targetUser; if (isEdit) { targetUser = DB[CURRENT_TAB].find(u => u.id == editId); targetUser.name = name; addSystemLog('تعديل مستخدم', `تعديل: ${name}`); } 
            else { targetUser = { id: Date.now(), name: name, status: 'active' }; if(CURRENT_TAB!=='departments') {targetUser.dateAdded = new Date().toLocaleDateString('en-GB'); targetUser.permissions=JSON.parse(JSON.stringify(DEFAULT_PERMS));} addSystemLog('إضافة مستخدم', `إضافة: ${name}`); }
            if (CURRENT_TAB === 'teachers') { targetUser.dept = document.getElementById('addDept').value; if(!targetUser.dept){alert("اختر القسم");return;} } 
            else if (CURRENT_TAB !== 'departments') { targetUser.job = document.getElementById('addJob').value; targetUser.phone = document.getElementById('addPhone').value; targetUser.login = document.getElementById('addLogin').value; targetUser.pass = document.getElementById('addPass').value; }
            if (!isEdit) DB[CURRENT_TAB].push(targetUser); saveDB(); renderTable(); closeModal('addUserModal');
        }
        function deleteUser(id) { if(confirm('هل أنت متأكد من الحذف؟')) { const u = DB[CURRENT_TAB].find(x => x.id === id); addSystemLog('حذف مستخدم', `حذف: ${u ? u.name : id}`); DB[CURRENT_TAB] = DB[CURRENT_TAB].filter(u => u.id !== id); saveDB(); renderTable(); } }
        function viewUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            document.getElementById('viewUserContent').innerHTML = `<div class="user-view-card"><div class="user-view-avatar">${u.name.charAt(0)}</div><h3 style="color:var(--primary); margin:0;">${u.name}</h3></div><div class="info-grid"><div class="info-item"><label>الوظيفة</label><span>${u.job || u.dept || '-'}</span></div><div class="info-item"><label>رقم الهاتف</label><span>${u.phone || '-'}</span></div><div class="info-item"><label>الحالة</label><span style="color:${u.status==='active'?'green':'red'}">${u.status==='active'?'مفعل':'معطل'}</span></div><div class="info-item"><label>اسم الدخول</label><span style="background:#eee; padding:2px 5px; border-radius:4px;">${u.login || '-'}</span></div></div>`;
            document.getElementById('viewUserModal').style.display = 'flex';
        }
        function openBulkPerms() { const chk = document.querySelectorAll('.user-select-cb:checked'); if(chk.length===0){alert('حدد مستخدمين');return;} IS_BULK_PERM_MODE = true; document.getElementById('permTargetName').innerText = `تعديل (${chk.length})`; document.getElementById('permList').innerHTML = ''; SECTIONS.forEach(s => document.getElementById('permList').innerHTML += `<div class="perm-item"><span>${s.name}</span><div><input type="checkbox" id="pv_${s.id}"> معاينة <input type="checkbox" id="pe_${s.id}"> تعديل</div></div>`); document.getElementById('permModal').style.display = 'flex'; }
        function openPerms(id) { if(CURRENT_TAB==='departments')return; IS_BULK_PERM_MODE=false; EDITING_PERM_ID=id; const u=DB[CURRENT_TAB].find(x=>x.id===id); document.getElementById('permTargetName').innerText=u.name; document.getElementById('permList').innerHTML=''; const p=u.permissions||DEFAULT_PERMS; SECTIONS.forEach(s=>{const up=p[s.id]||{view:true,edit:false}; document.getElementById('permList').innerHTML+=`<div class="perm-item"><span>${s.name}</span><div><input type="checkbox" id="pv_${s.id}" ${up.view?'checked':''}> معاينة <input type="checkbox" id="pe_${s.id}" ${up.edit?'checked':''}> تعديل</div></div>`}); document.getElementById('permModal').style.display='flex'; }
        function toggleAllPerms(t,s){ document.querySelectorAll(t==='view'?'[id^="pv_"]':'[id^="pe_"]').forEach(c=>c.checked=s.checked); }
        function submitPermissions() {
            const newP = {}; SECTIONS.forEach(s => newP[s.id] = {view:document.getElementById(`pv_${s.id}`).checked, edit:document.getElementById(`pe_${s.id}`).checked});
            if(IS_BULK_PERM_MODE) { const ids = Array.from(document.querySelectorAll('.user-select-cb:checked')).map(c=>parseInt(c.value)); DB[CURRENT_TAB].forEach(u=>{if(ids.includes(u.id)) u.permissions=JSON.parse(JSON.stringify(newP));}); } 
            else { const u=DB[CURRENT_TAB].find(x=>x.id===EDITING_PERM_ID); u.permissions=newP; if(CURRENT_USER.id===u.id){CURRENT_USER=u; applySidebarPermissions(); renderTable();} }
            saveDB(); closeModal('permModal'); alert('تم التحديث');
        }
        function togglePass(id,icon) { const i=document.getElementById(id); i.type=i.type==='password'?'text':'password'; icon.className=i.type==='password'?'fas fa-eye password-icon':'fas fa-eye-slash password-icon'; }
        function setSettingTab(t,el){ document.querySelectorAll('.setting-content-pane').forEach(p=>p.classList.remove('active')); document.getElementById(t).classList.add('active'); el.parentElement.querySelectorAll('.custom-tab').forEach(c=>c.classList.remove('active')); el.classList.add('active'); if(t==='sig')loadSignatureSettings(); if(t==='vis')loadVisitorSettings(); if(t==='fot')loadFooterSettings(); if(t==='log')loadSystemLogs(); if(t==='eval')loadEvaluationSettings(); }
        function loadSettings(){ const s=DB.settings; document.getElementById('confSchool').value=s.schoolName||''; document.getElementById('confYear').value=s.schoolYear||''; showImagePreview('preview_ministry','preview_wrap_ministry','btn_wrap_ministry',s.ministryLogo); showImagePreview('preview_school','preview_wrap_school','btn_wrap_school',s.schoolLogo); showImagePreview('preview_stamp','preview_wrap_stamp','btn_wrap_stamp',s.schoolStamp); }
        function showImagePreview(i,w,b,s){ const img=document.getElementById(i); if(s){img.src=s; document.getElementById(w).style.display='inline-block'; document.getElementById(b).style.display='none';} else {document.getElementById(w).style.display='none'; document.getElementById(b).style.display='block';} }
        function triggerFileSelect(id){ document.getElementById(id).click(); }
        function handleFileUpload(inp,pId,k){ if(inp.files&&inp.files[0]){const r=new FileReader(); r.onload=function(e){const d=e.target.result; document.getElementById(pId).src=d; document.getElementById(pId.replace('preview_','preview_wrap_')).style.display='inline-block'; document.getElementById(pId.replace('preview_','btn_wrap_')).style.display='none';}; r.readAsDataURL(inp.files[0]);} }
        function removeImage(pId,k,inpId){ if(confirm('حذف؟')){document.getElementById(pId).src=''; document.getElementById(inpId).value=''; document.getElementById(pId.replace('preview_','preview_wrap_')).style.display='none'; document.getElementById(pId.replace('preview_','btn_wrap_')).style.display='block';} }
        function saveGeneralSettings(){ DB.settings.schoolName=document.getElementById('confSchool').value; DB.settings.schoolYear=document.getElementById('confYear').value; const m=document.getElementById('preview_ministry').src; const s=document.getElementById('preview_school').src; const st=document.getElementById('preview_stamp').src; DB.settings.ministryLogo=(m.startsWith('data:'))?m:''; DB.settings.schoolLogo=(s.startsWith('data:'))?s:''; DB.settings.schoolStamp=(st.startsWith('data:'))?st:''; saveDB(); alert('تم الحفظ'); }
        function openImageModal(s){ if(!s)return; document.getElementById('fullImage').src=s; document.getElementById('imageViewModal').style.display='flex'; }
        function loadSignatureSettings(){ const sel=[document.getElementById('sig_director'), document.getElementById('sig_assistant')]; sel.forEach(s=>{s.innerHTML='<option value="">اختر...</option>'; (DB.senior||[]).forEach(u=>{s.innerHTML+=`<option value="${u.id}">${u.name}</option>`})}); document.getElementById('sig_director').value=DB.settings.signature_director_id; document.getElementById('sig_assistant').value=DB.settings.signature_assistant_id; }
        function saveSignatureSettings(){ DB.settings.signature_director_id=document.getElementById('sig_director').value; DB.settings.signature_assistant_id=document.getElementById('sig_assistant').value; saveDB(); alert('تم الحفظ'); }
        function clearSignature(id){ document.getElementById(id).value=''; saveSignatureSettings(); }
        function loadVisitorSettings(){ renderVisitorList('senior'); renderVisitorList('middle'); }
        function renderVisitorList(t){ const l=document.getElementById(`list_visitor_${t}`); const o=t==='senior'?DB.settings.visitor_order_senior:DB.settings.visitor_order_middle; const src=t==='senior'?DB.senior:DB.middle; l.innerHTML=''; if(!o||o.length===0){l.innerHTML='<li class="empty-list-msg">فارغ</li>';return;} o.forEach((id,i)=>{const u=src.find(x=>x.id==id); if(u) l.innerHTML+=`<li class="visitor-list-item"><span class="visitor-name">${u.name}</span><div class="visitor-controls"><button class="action-btn btn-move" onclick="moveVisitorItem('${t}',${i},'up')"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveVisitorItem('${t}',${i},'down')"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-delete" onclick="removeVisitorItem('${t}',${i})"><i class="fas fa-trash"></i></button></div></li>`;}); }
        function openVisitorPicker(t){ CURRENT_PICKER_TYPE=t; document.getElementById('visitorSearch').value=''; filterPickerList(); document.getElementById('visitorPickerModal').style.display='flex'; }
        function filterPickerList(){ const q=document.getElementById('visitorSearch').value.toLowerCase(); const l=document.getElementById('pickerList'); l.innerHTML=''; const src=CURRENT_PICKER_TYPE==='senior'?DB.senior:DB.middle; const o=CURRENT_PICKER_TYPE==='senior'?DB.settings.visitor_order_senior:DB.settings.visitor_order_middle; src.filter(u=>!o.includes(u.id)).forEach(u=>{if(u.name.toLowerCase().includes(q)) l.innerHTML+=`<div class="picker-item" onclick="addVisitorToOrder(${u.id})"><div><div class="picker-item-name">${u.name}</div></div><i class="fas fa-plus-circle" style="color:var(--success);"></i></div>`;}); }
        function addVisitorToOrder(id){ const k=CURRENT_PICKER_TYPE==='senior'?'visitor_order_senior':'visitor_order_middle'; if(!DB.settings[k])DB.settings[k]=[]; DB.settings[k].push(id); closeModal('visitorPickerModal'); renderVisitorList(CURRENT_PICKER_TYPE); }
        function removeVisitorItem(t,i){ const k=t==='senior'?'visitor_order_senior':'visitor_order_middle'; DB.settings[k].splice(i,1); renderVisitorList(t); }
        function moveVisitorItem(t,i,d){ const k=t==='senior'?'visitor_order_senior':'visitor_order_middle'; const a=DB.settings[k]; if(d==='up'&&i>0)[a[i],a[i-1]]=[a[i-1],a[i]]; if(d==='down'&&i<a.length-1)[a[i],a[i+1]]=[a[i+1],a[i]]; renderVisitorList(t); }
        function saveVisitorOrder(){ saveDB(); alert('تم الحفظ'); }
        function loadFooterSettings(){ document.getElementById('footer_text').value=DB.settings.footer_text||''; document.getElementById('footer_align').value=DB.settings.footer_align||'center'; document.getElementById('footer_fontsize').value=DB.settings.footer_fontsize||'12'; }
        function saveFooterSettings(){ DB.settings.footer_text=document.getElementById('footer_text').value; DB.settings.footer_align=document.getElementById('footer_align').value; DB.settings.footer_fontsize=document.getElementById('footer_fontsize').value; saveDB(); alert('تم الحفظ'); }
        function loadEvaluationSettings(){ const b=document.getElementById('evalTableBody'); b.innerHTML=''; (DB.settings.evaluation_criteria||[]).forEach((e,i)=>{b.innerHTML+=`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.status}</td><td><button class="action-btn btn-move" onclick="moveEval(${e.id},'up')"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveEval(${e.id},'down')"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-toggle" onclick="toggleEvalStatus(${e.id})"><i class="fas fa-power-off"></i></button><button class="action-btn btn-edit" onclick="openAddEvalModal(${e.id})"><i class="fas fa-edit"></i></button><button class="action-btn btn-delete" onclick="deleteEval(${e.id})"><i class="fas fa-trash"></i></button></td></tr>`;}); }
        function openAddEvalModal(id){ document.getElementById('addEvalForm').reset(); document.getElementById('editEvalId').value=''; if(id){const e=DB.settings.evaluation_criteria.find(x=>x.id===id); document.getElementById('editEvalId').value=e.id; document.getElementById('evalName').value=e.name;} document.getElementById('addEvalModal').style.display='flex'; }
        function saveEvalForm(){ const n=document.getElementById('evalName').value; const id=document.getElementById('editEvalId').value; if(!n)return; if(id){const e=DB.settings.evaluation_criteria.find(x=>x.id==id); e.name=n;} else {DB.settings.evaluation_criteria.push({id:Date.now(), name:n, status:'active'});} saveDB(); loadEvaluationSettings(); closeModal('addEvalModal'); }
        function deleteEval(id){ if(confirm('حذف؟')){DB.settings.evaluation_criteria=DB.settings.evaluation_criteria.filter(x=>x.id!==id); saveDB(); loadEvaluationSettings();} }
        function toggleEvalStatus(id){ const e=DB.settings.evaluation_criteria.find(x=>x.id===id); e.status=e.status==='active'?'inactive':'active'; saveDB(); loadEvaluationSettings(); }
        function moveEval(id,d){ const l=DB.settings.evaluation_criteria; const i=l.findIndex(x=>x.id===id); if(d==='up'&&i>0)[l[i],l[i-1]]=[l[i-1],l[i]]; if(d==='down'&&i<l.length-1)[l[i],l[i+1]]=[l[i+1],l[i]]; saveDB(); loadEvaluationSettings(); }
        function loadSystemLogs(){ const b=document.getElementById('logTableBody'); b.innerHTML=''; (DB.logs||[]).forEach(l=>{b.innerHTML+=`<tr><td>${l.date}</td><td>${l.user}</td><td>${l.action}</td><td>${l.details}</td></tr>`;}); }
        function clearSystemLogs(){ if(confirm('مسح؟')){DB.logs=[]; saveDB(); loadSystemLogs();} }
        function setVisitTab(t,el){ CURRENT_VISIT_TAB=t; el.parentElement.querySelectorAll('.custom-tab').forEach(c=>c.classList.remove('active')); el.classList.add('active'); renderVisitsTable(); }
        function openAddVisitModal(){ document.getElementById('addVisitForm').reset(); const d=document.getElementById('visitDept'); d.innerHTML='<option value="">اختر...</option>'; (DB.departments||[]).forEach(x=>d.innerHTML+=`<option value="${x.name}">${x.name}</option>`); const e=document.getElementById('visitEval'); e.innerHTML='<option value="">اختر...</option>'; (DB.settings.evaluation_criteria||[]).filter(x=>x.status==='active').forEach(x=>e.innerHTML+=`<option value="${x.name}">${x.name}</option>`); document.getElementById('visitTeacher').innerHTML='<option value="">اختر...</option>'; document.getElementById('addVisitModal').style.display='flex'; }
        function onVisitDeptChange(){ const d=document.getElementById('visitDept').value; const t=document.getElementById('visitTeacher'); t.innerHTML='<option value="">اختر...</option>'; (DB.teachers||[]).filter(x=>x.dept===d&&x.status==='active').forEach(x=>t.innerHTML+=`<option value="${x.name}">${x.name}</option>`); }
        function saveVisit(){ const d=document.getElementById('visitDept').value; const t=document.getElementById('visitTeacher').value; const date=document.getElementById('visitDate').value; const ev=document.getElementById('visitEval').value; if(!d||!t||!date||!ev)return alert('اكمل البيانات'); const v={id:Date.now(), dept:d, teacher:t, date:date, eval:ev, visitorName:CURRENT_USER.name, visitorId:CURRENT_USER.id}; if(DB.middle.some(u=>u.id===CURRENT_USER.id)) { if(!DB.visits_middle)DB.visits_middle=[]; DB.visits_middle.push(v); } else { if(!DB.visits_senior)DB.visits_senior=[]; DB.visits_senior.push(v); } saveDB(); renderVisitsTable(); closeModal('addVisitModal'); alert('تم'); }
        function getLatestJobTitle(uid){ for(let g of ['admins','senior','middle','teachers']) if(DB[g]){const f=DB[g].find(x=>x.id==uid); if(f)return f.job||f.dept||'-';} return '-'; }
        function renderVisitsTable(){ const b=document.getElementById('visitsTableBody'); b.innerHTML=''; const f=document.getElementById('visitMonthFilter').value; let l=CURRENT_VISIT_TAB==='senior'?(DB.visits_senior||[]):(DB.visits_middle||[]); if(f!=='all') l=l.filter(v=>v.date.split('-')[1]===f); if(l.length===0){b.innerHTML='<tr><td colspan="6">لا يوجد</td></tr>';return;} l.sort((x,y)=>y.id-x.id); l.forEach(v=>{b.innerHTML+=`<tr><td>${v.date}</td><td>${v.dept}</td><td>${v.teacher}</td><td>${v.eval}</td><td>${v.visitorName}</td><td>${getLatestJobTitle(v.visitorId)}</td></tr>`;}); }
        function renderPerformanceChart(){ const f=document.getElementById('perfMonthFilter').value; const ctx=document.getElementById('perfChart').getContext('2d'); let l=[...(DB.visits_senior||[]), ...(DB.visits_middle||[])]; if(f!=='all') l=l.filter(v=>v.date.split('-')[1]===f); const depts=[...new Set(l.map(x=>x.dept))]; let crits=(DB.settings.evaluation_criteria||[]).filter(x=>x.status==='active').map(x=>x.name); l.forEach(v=>{if(!crits.includes(v.eval))crits.push(v.eval)}); const ds=crits.map((c,i)=>({label:c, data:depts.map(d=>l.filter(x=>x.dept===d&&x.eval===c).length), backgroundColor:['#28a745','#17a2b8','#ffc107','#dc3545'][i%4]})); if(performanceChartInstance)performanceChartInstance.destroy(); performanceChartInstance=new Chart(ctx,{type:'bar',data:{labels:depts.length?depts:['no data'], datasets:ds}}); }

        // ============================================
        // === Distinguished & Care Needed Teachers ===
        // ============================================

        function renderDistinguishedTables() {
            const filterMonth = document.getElementById('distMonthFilter').value;
            
            const renderTableBody = (list, elementId, type) => {
                const body = document.getElementById(elementId);
                body.innerHTML = '';
                
                let filteredList = list;
                if(filterMonth !== 'all') {
                    filteredList = list.filter(i => {
                        if(!i.date) return false; 
                        const m = i.date.split('-')[1]; 
                        return m === filterMonth;
                    });
                }

                if(filteredList.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" style="padding:20px; color:#888;">لا يوجد بيانات مدخلة لهذا الشهر</td></tr>';
                } else {
                    filteredList.forEach((item, idx) => {
                        const statusClass = type === 'distinguished' ? 'status-active' : 'status-inactive';
                        body.innerHTML += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${item.teacherName}</td>
                                <td>${item.dept}</td>
                                <td><span class="status-badge ${statusClass}">${item.eval}</span></td>
                                <td class="reason-cell">${item.reason}</td>
                                <td>
                                    <div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">
                                        <button class="action-btn btn-view" onclick="viewDistinguished('${type}', ${item.id})" title="معاينة"><i class="fas fa-eye"></i></button>
                                        <button class="action-btn btn-edit" onclick="editDistinguished('${type}', ${item.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn btn-delete" onclick="deleteDistinguished('${type}', ${item.id})" title="حذف"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
            };

            renderTableBody(DB.distinguished || [], 'distinguishedTableBody', 'distinguished');
            renderTableBody(DB.care_needed || [], 'careTableBody', 'care');
        }

        function openDistinguishedModal(type) {
            document.getElementById('distinguishedForm').reset();
            document.getElementById('distEditId').value = ''; 
            document.getElementById('distType').value = type;
            document.getElementById('distinguishedModalTitle').innerText = (type === 'distinguished') ? 'إضافة معلم متميز' : 'إضافة معلم يحتاج رعاية';
            
            const deptSel = document.getElementById('distDept');
            deptSel.innerHTML = '<option value="">اختر القسم...</option>';
            if(DB.departments && DB.departments.length > 0) {
                DB.departments.forEach(d => {
                    const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name; deptSel.appendChild(opt);
                });
            } else { deptSel.innerHTML = '<option value="">لا توجد أقسام</option>'; }

            document.getElementById('distTeacher').innerHTML = '<option value="">اختر القسم أولاً</option>';

            const evalSel = document.getElementById('distEval');
            evalSel.innerHTML = '<option value="">اختر التقدير...</option>';
            if(DB.settings.evaluation_criteria) {
                DB.settings.evaluation_criteria.forEach(e => {
                    if(e.status === 'active') {
                        const opt = document.createElement('option'); opt.value = e.name; opt.innerText = e.name; evalSel.appendChild(opt);
                    }
                });
            }
            document.getElementById('distinguishedModal').style.display = 'flex';
        }

        function editDistinguished(type, id) {
            const list = type === 'distinguished' ? DB.distinguished : DB.care_needed;
            const item = list.find(x => x.id === id);
            if(!item) return;

            openDistinguishedModal(type);
            document.getElementById('distinguishedModalTitle').innerText = 'تعديل البيانات';
            document.getElementById('distEditId').value = item.id;
            
            const deptSel = document.getElementById('distDept');
            deptSel.value = item.dept;
            onDistinguishedDeptChange(); 
            document.getElementById('distTeacher').value = item.teacherName;
            document.getElementById('distEval').value = item.eval;
            document.getElementById('distReason').value = item.reason;
        }

        function viewDistinguished(type, id) {
            const list = type === 'distinguished' ? DB.distinguished : DB.care_needed;
            const item = list.find(x => x.id === id);
            if(!item) return;

            const content = document.getElementById('viewDetailsContent');
            content.innerHTML = `
                <div style="text-align:right;">
                    <div style="margin-bottom:10px;"><strong style="color:var(--primary);">الاسم:</strong> ${item.teacherName}</div>
                    <div style="margin-bottom:10px;"><strong style="color:var(--primary);">القسم:</strong> ${item.dept}</div>
                    <div style="margin-bottom:10px;"><strong style="color:var(--primary);">التقدير:</strong> <span class="status-badge status-active">${item.eval}</span></div>
                    <div style="margin-bottom:5px;"><strong style="color:var(--primary);">المبررات:</strong></div>
                    <div style="background:#f9f9f9; padding:15px; border-radius:5px; border:1px solid #eee; white-space:pre-wrap; line-height:1.6;">${item.reason}</div>
                    <div style="margin-top:10px; font-size:0.8rem; color:#888;">تاريخ الإضافة: ${item.date || '-'}</div>
                </div>
            `;
            document.getElementById('viewDetailsModal').style.display = 'flex';
        }

        function onDistinguishedDeptChange() {
            const selectedDept = document.getElementById('distDept').value;
            const teacherSel = document.getElementById('distTeacher');
            teacherSel.innerHTML = '<option value="">اختر المعلم/ة...</option>';

            if(selectedDept && DB.teachers) {
                const teachers = DB.teachers.filter(t => t.dept === selectedDept && t.status === 'active');
                if(teachers.length > 0) {
                    teachers.forEach(t => {
                        const opt = document.createElement('option'); opt.value = t.name; opt.innerText = t.name; teacherSel.appendChild(opt);
                    });
                } else { teacherSel.innerHTML = '<option value="">لا يوجد معلمات</option>'; }
            }
        }

        function saveDistinguishedEntry() {
            const type = document.getElementById('distType').value;
            const editId = document.getElementById('distEditId').value;
            const dept = document.getElementById('distDept').value;
            const teacher = document.getElementById('distTeacher').value;
            const eval = document.getElementById('distEval').value;
            const reason = document.getElementById('distReason').value;

            if(!dept || !teacher || !eval) { alert('يرجى تعبئة كافة الحقول الأساسية'); return; }

            let targetList = (type === 'distinguished') ? DB.distinguished : DB.care_needed;
            if(!targetList) {
                if(type === 'distinguished') { DB.distinguished = []; targetList = DB.distinguished; }
                else { DB.care_needed = []; targetList = DB.care_needed; }
            }

            if (editId) {
                const item = targetList.find(x => x.id == editId);
                if(item) {
                    item.dept = dept; item.teacherName = teacher; item.eval = eval; item.reason = reason;
                    addSystemLog((type === 'distinguished' ? 'المعلمين المتميزين' : 'الأولى بالرعاية'), `تعديل بيانات: ${teacher}`);
                }
            } else {
                const entry = { id: Date.now(), date: new Date().toISOString().split('T')[0], dept: dept, teacherName: teacher, eval: eval, reason: reason };
                targetList.push(entry);
                addSystemLog((type === 'distinguished' ? 'المعلمين المتميزين' : 'الأولى بالرعاية'), `إضافة جديد: ${teacher}`);
            }
            saveDB(); renderDistinguishedTables(); closeModal('distinguishedModal');
        }

        function deleteDistinguished(type, id) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                if(type === 'distinguished') { DB.distinguished = DB.distinguished.filter(i => i.id !== id); } 
                else { DB.care_needed = DB.care_needed.filter(i => i.id !== id); }
                saveDB(); renderDistinguishedTables();
            }
        }

        // ============================================
        // === Qualitative Report Logic (التقرير النوعي) ===
        // ============================================

        function renderQualitativeTable() {
            const tbody = document.getElementById('qualitativeTableBody');
            const monthFilter = document.getElementById('qualMonthFilter').value;
            tbody.innerHTML = '';
            
            let list = DB.qualitative_reports || [];

            // Filter
            if (monthFilter !== 'all') {
                list = list.filter(i => {
                    if (!i.date) return false;
                    const m = i.date.split('-')[1];
                    return m === monthFilter;
                });
            }

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; color:#888;">لا توجد تقارير لهذا الشهر</td></tr>';
            } else {
                list.forEach((item, idx) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${item.dept}</td>
                            <td class="reason-cell">${item.strengths}</td>
                            <td class="reason-cell">${item.improvements}</td>
                            <td>
                                <div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">
                                    <button class="action-btn btn-view" onclick="viewQualitative(${item.id})" title="معاينة"><i class="fas fa-eye"></i></button>
                                    <button class="action-btn btn-edit" onclick="editQualitative(${item.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn btn-delete" onclick="deleteQualitative(${item.id})" title="حذف"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        function openQualitativeModal() {
            document.getElementById('qualitativeForm').reset();
            document.getElementById('qualEditId').value = '';
            
            // Populate Department
            const deptSel = document.getElementById('qualDept');
            deptSel.innerHTML = '<option value="">اختر القسم...</option>';
            if (DB.departments && DB.departments.length > 0) {
                DB.departments.forEach(d => {
                    const opt = document.createElement('option'); opt.value = d.name; opt.innerText = d.name; deptSel.appendChild(opt);
                });
            }
            document.getElementById('addQualitativeModal').style.display = 'flex';
        }

        function editQualitative(id) {
            const item = DB.qualitative_reports.find(i => i.id === id);
            if (!item) return;
            openQualitativeModal();
            document.getElementById('qualEditId').value = item.id;
            document.getElementById('qualDept').value = item.dept;
            document.getElementById('qualStrength').value = item.strengths;
            document.getElementById('qualImprove').value = item.improvements;
        }

        function viewQualitative(id) {
            const item = DB.qualitative_reports.find(i => i.id === id);
            if (!item) return;
            const content = document.getElementById('viewDetailsContent');
            content.innerHTML = `
                <div style="text-align:right;">
                    <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <strong style="color:var(--primary); font-size:1.1rem;">${item.dept}</strong>
                        <div style="font-size:0.85rem; color:#777; margin-top:5px;">تاريخ التقرير: ${item.date}</div>
                    </div>
                    <div style="margin-bottom:5px;"><strong style="color:var(--success);">جوانب القوة:</strong></div>
                    <div style="background:#f1fff4; padding:15px; border-radius:5px; border:1px solid #c3e6cb; white-space:pre-wrap; line-height:1.6; margin-bottom:15px;">${item.strengths}</div>
                    
                    <div style="margin-bottom:5px;"><strong style="color:var(--danger);">جوانب بحاجة إلى تطوير:</strong></div>
                    <div style="background:#fff5f5; padding:15px; border-radius:5px; border:1px solid #f5c6cb; white-space:pre-wrap; line-height:1.6;">${item.improvements}</div>
                </div>
            `;
            document.getElementById('viewDetailsModal').style.display = 'flex';
        }

        function saveQualitative() {
            const editId = document.getElementById('qualEditId').value;
            const dept = document.getElementById('qualDept').value;
            const strengths = document.getElementById('qualStrength').value;
            const improvements = document.getElementById('qualImprove').value;

            if (!dept) { alert('يرجى اختيار القسم'); return; }

            if (editId) {
                const item = DB.qualitative_reports.find(i => i.id == editId);
                if (item) {
                    item.dept = dept;
                    item.strengths = strengths;
                    item.improvements = improvements;
                    addSystemLog('التقرير النوعي', `تعديل تقرير: ${dept}`);
                }
            } else {
                const report = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    dept: dept,
                    strengths: strengths,
                    improvements: improvements
                };
                if (!DB.qualitative_reports) DB.qualitative_reports = [];
                DB.qualitative_reports.push(report);
                addSystemLog('التقرير النوعي', `إضافة تقرير جديد: ${dept}`);
            }
            saveDB();
            renderQualitativeTable();
            closeModal('addQualitativeModal');
        }

        function deleteQualitative(id) {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                DB.qualitative_reports = DB.qualitative_reports.filter(i => i.id !== id);
                saveDB();
                renderQualitativeTable();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', login);
        initSystem();
    </script>
</body>
</html>
