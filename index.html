<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام جودة التعليم المتطور | الإصدار 2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #10b981;
            --accent: #f59e0b;
            --bg-light: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        
        body { background-color: var(--bg-light); color: var(--text-main); line-height: 1.6; }

        /* --- التحسينات الجمالية العامة --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 20px; }
        
        /* Header */
        header {
            background: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid #e5e7eb;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; color: var(--primary); }
        .logo i { font-size: 2rem; }
        .logo h1 { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); }
        
        .user-profile { display: flex; align-items: center; gap: 12px; background: var(--bg-light); padding: 5px 15px; border-radius: 50px; }
        .avatar { width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Navigation */
        nav { background: white; padding: 10px 0; margin-bottom: 20px; box-shadow: var(--shadow-sm); overflow-x: auto; }
        .nav-tabs { display: flex; list-style: none; gap: 5px; min-width: max-content; }
        .nav-tabs a {
            padding: 10px 20px; text-decoration: none; color: var(--text-light);
            border-radius: var(--radius); font-weight: 600; transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-tabs a:hover { background-color: var(--bg-light); color: var(--primary); }
        .nav-tabs a.active { background-color: var(--primary); color: white; box-shadow: var(--shadow-md); }

        /* Cards & Sections */
        .section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-sm); padding: 20px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: space-between;
            transition: transform 0.3s; border-right: 4px solid var(--primary);
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-info h3 { font-size: 2rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 5px; }
        .stat-info p { color: var(--text-light); font-size: 0.9rem; }
        .stat-icon { width: 50px; height: 50px; background: #eff6ff; color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: var(--radius); box-shadow: var(--shadow-sm); background: white; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background-color: #f8fafc; color: var(--text-main); font-weight: 700; padding: 15px; text-align: right; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; color: var(--text-light); }
        tr:hover { background-color: #f8fafc; }
        
        /* Search Bar */
        .search-box { position: relative; margin-bottom: 15px; max-width: 400px; }
        .search-box input { width: 100%; padding: 10px 40px 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; }
        .search-box i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; }

        /* Buttons */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; transition: border-color 0.2s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }

        /* Login */
        .login-wrapper {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%; max-width: 420px; text-align: center;
        }

        /* الطباعة A4 */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            header, nav, .btn, .search-box, .no-print { display: none !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            .a4-page {
                width: 21cm; height: 29.7cm; margin: 0 auto; padding: 1.5cm;
                border: none; box-shadow: none; page-break-after: always;
            }
            /* تحسين الجدول للطباعة */
            table { font-size: 12pt; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; color: black; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }

        /* تحسينات A4 في العرض */
        .a4-preview-container { background: #525659; padding: 40px; overflow-x: auto; text-align: center; border-radius: var(--radius); }
        .a4-page {
            background: white; width: 21cm; min-height: 29.7cm; margin: 0 auto 30px auto;
            padding: 2cm; text-align: right; box-shadow: 0 0 15px rgba(0,0,0,0.2); position: relative;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 90%; max-width: 600px; padding: 25px;
            border-radius: 16px; box-shadow: var(--shadow-lg); animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-card">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="margin-bottom: 10px; color: var(--primary-dark);">مرحباً بك مجدداً</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">نظام متابعة جودة التعليم والتعلم</p>
            <form id="loginForm">
                <div class="form-group" style="text-align: right;">
                    <label>اسم المستخدم</label>
                    <input type="text" id="username" class="form-control" placeholder="admin" required>
                </div>
                <div class="form-group" style="text-align: right;">
                    <label>كلمة المرور</label>
                    <input type="password" id="password" class="form-control" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <div id="app" style="display: none;">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-layer-group"></i>
                    <div>
                        <h1 id="headerSchoolName">نظام الجودة</h1>
                        <small style="color: var(--text-light); font-weight: 600;">العام الدراسي 2025 / 2026</small>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="avatar" id="userAvatar">م</div>
                    <div>
                        <div id="userName" style="font-weight: 700; font-size: 0.9rem;">مستخدم</div>
                        <div style="font-size: 0.75rem; color: var(--text-light); cursor: pointer;" id="logoutBtn">تسجيل خروج</div>
                    </div>
                </div>
            </div>
        </header>

        <nav>
            <div class="container">
                <ul class="nav-tabs">
                    <li><a href="#" data-target="dashboard" class="active"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                    <li><a href="#" data-target="visits"><i class="fas fa-eye"></i> الزيارات الصفية</a></li>
                    <li><a href="#" data-target="performance"><i class="fas fa-chart-bar"></i> تقييم الأداء</a></li>
                    <li><a href="#" data-target="teachers"><i class="fas fa-chalkboard-teacher"></i> المعلمين</a></li>
                    <li><a href="#" data-target="quality"><i class="fas fa-file-contract"></i> التقارير</a></li>
                    <li><a href="#" data-target="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </div>
        </nav>

        <main class="container">
            
            <section id="dashboard" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="text-2xl font-bold">نظرة عامة</h2>
                    <select class="form-control" style="width: auto;" id="dashboardFilter">
                        <option value="all">جميع الأشهر</option>
                        <option value="سبتمبر">سبتمبر</option>
                        <option value="أكتوبر">أكتوبر</option>
                        </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 id="totalVisits">0</h3>
                            <p>إجمالي الزيارات</p>
                        </div>
                        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                    </div>
                    <div class="stat-card" style="border-color: var(--secondary);">
                        <div class="stat-info">
                            <h3 id="distinguishedCount" style="color: var(--secondary);">0</h3>
                            <p>معلم متميز</p>
                        </div>
                        <div class="stat-icon" style="color: var(--secondary); background: #ecfdf5;"><i class="fas fa-star"></i></div>
                    </div>
                    <div class="stat-card" style="border-color: var(--accent);">
                        <div class="stat-info">
                            <h3 id="needsCareCount" style="color: var(--accent);">0</h3>
                            <p>أولى بالرعاية</p>
                        </div>
                        <div class="stat-icon" style="color: var(--accent); background: #fffbeb;"><i class="fas fa-hand-holding-heart"></i></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">الأداء حسب القسم</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">تطور الأداء الشهري</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="visits" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <h2>سجل الزيارات الصفية</h2>
                        <button class="btn btn-primary" onclick="openModal('visitModal')"><i class="fas fa-plus"></i> زيارة جديدة</button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" onkeyup="searchTable(this, 'visitsTable')" placeholder="بحث باسم المعلم أو الزائر...">
                        <i class="fas fa-search"></i>
                    </div>

                    <div class="table-container">
                        <table id="visitsTable">
                            <thead>
                                <tr>
                                    <th>المعلم</th>
                                    <th>القسم</th>
                                    <th>التاريخ</th>
                                    <th>التقييم</th>
                                    <th>الزائر</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="visitsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="performance" class="section">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <h2>إدخال بيانات الأداء للأقسام</h2>
                        <button class="btn btn-success" onclick="savePerformanceData()"><i class="fas fa-save"></i> حفظ البيانات</button>
                    </div>
                    <div class="table-container">
                        <table id="inputPerformanceTable">
                            <thead>
                                <tr>
                                    <th>القسم</th>
                                    <th>الزيارات</th>
                                    <th>يفوق التوقعات</th>
                                    <th>يفي بالتوقعات</th>
                                    <th>يفي جزئياً</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="teachers" class="section">
                <div class="card">
                    <h2>قوائم المعلمين (المتميزين / رعاية)</h2>
                    <div style="margin: 20px 0; display: flex; gap: 10px;">
                        <button class="btn btn-secondary active" onclick="switchTeacherView('distinguished')">المتميزين</button>
                        <button class="btn btn-secondary" onclick="switchTeacherView('care')">الأولى بالرعاية</button>
                    </div>
                    <div class="table-container">
                        <table id="teachersTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>القسم</th>
                                    <th>التقدير</th>
                                    <th>المبررات</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="quality" class="section">
                <div class="card no-print" style="margin-bottom: 20px;">
                    <h2>إصدار التقارير</h2>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> طباعة التقرير (A4)</button>
                        <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    </div>
                </div>

                <div class="a4-preview-container">
                    <div class="a4-page">
                        <div style="text-align: center; margin-top: 50px;">
                            <h2 style="margin-bottom: 40px;">وزارة التربية والتعليم</h2>
                            <div style="border: 2px solid #000; padding: 40px; margin: 50px; border-radius: 15px;">
                                <h1 style="font-size: 24pt; margin-bottom: 20px;">تقرير متابعة جودة التعليم والتعلم</h1>
                                <h2 id="reportSchoolTitle">لمدرسة ...</h2>
                                <h3 id="reportMonthTitle">شهر ...</h3>
                                <h3>العام الدراسي 2025 / 2026</h3>
                            </div>
                            <div style="margin-top: 100px; display: flex; justify-content: space-around;">
                                <div>
                                    <p>إعداد المدير المساعد</p>
                                    <p style="margin-top: 30px;">.......................</p>
                                </div>
                                <div>
                                    <p>يعتمد، مدير المدرسة</p>
                                    <p style="margin-top: 30px;">.......................</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="a4-page">
                        <h3 style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">رابعاً: نسب نتائج الزيارات الصفية للأقسام</h3>
                        <table id="printPerformanceTable">
                            </table>
                    </div>
                </div>
            </section>

            <section id="settings" class="section">
                <div class="card">
                    <h2>إعدادات النظام</h2>
                    <div class="form-group">
                        <label>اسم المدرسة</label>
                        <input type="text" id="schoolNameInput" class="form-control" placeholder="أدخل اسم المدرسة">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
                    <hr style="margin: 20px 0;">
                    <button class="btn btn-danger" onclick="clearAllData()">حذف جميع البيانات (تهيئة)</button>
                </div>
            </section>

        </main>
    </div>

    <div id="visitModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">إضافة زيارة صفية</h3>
            <form id="visitForm">
                <div class="form-group">
                    <label>اسم المعلم</label>
                    <input type="text" name="teacher" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>القسم</label>
                    <select name="department" class="form-control">
                        <option>اللغة العربية</option>
                        <option>الرياضيات</option>
                        <option>العلوم</option>
                        <option>اللغة الإنجليزية</option>
                        <option>التربية الإسلامية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>تاريخ الزيارة</label>
                    <input type="date" name="date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>التقييم</label>
                    <select name="evaluation" class="form-control">
                        <option>ممتاز</option>
                        <option>جيد جداً</option>
                        <option>جيد</option>
                        <option>مقبول</option>
                        <option>ضعيف</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>الزائر</label>
                    <input type="text" name="visitor" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('visitModal')">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- تهيئة البيانات ---
        const initialData = {
            schoolName: "مدرسة المستقبل",
            visits: [],
            performance: [
                { dept: 'اللغة العربية', visits: 0, exc: 0, good: 0, part: 0 },
                { dept: 'الرياضيات', visits: 0, exc: 0, good: 0, part: 0 },
                { dept: 'العلوم', visits: 0, exc: 0, good: 0, part: 0 }
            ],
            teachers: [] // {name, dept, type: 'distinguished'|'care', rating, reasons}
        };

        let appData = JSON.parse(localStorage.getItem('eduSystemData')) || initialData;

        // --- Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            // التحقق من تسجيل الدخول (محاكاة بسيطة)
            if(sessionStorage.getItem('isLoggedIn')) {
                showApp();
            }

            // تفعيل التبويبات
            document.querySelectorAll('.nav-tabs a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-tabs a').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    
                    e.target.closest('a').classList.add('active');
                    const target = e.target.closest('a').dataset.target;
                    document.getElementById(target).classList.add('active');
                    
                    if(target === 'performance') renderPerformanceInputs();
                    if(target === 'quality') prepareReport();
                });
            });

            // تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if(u === 'admin' && p === 'admin123') {
                    sessionStorage.setItem('isLoggedIn', true);
                    Swal.fire({
                        icon: 'success',
                        title: 'تم تسجيل الدخول',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => showApp());
                } else {
                    Swal.fire('خطأ', 'بيانات الدخول غير صحيحة', 'error');
                }
            });

            // تسجيل الخروج
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.removeItem('isLoggedIn');
                location.reload();
            });

            // إضافة زيارة
            document.getElementById('visitForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const visit = Object.fromEntries(formData.entries());
                
                appData.visits.push(visit);
                saveData();
                renderVisitsTable();
                updateDashboard();
                closeModal('visitModal');
                e.target.reset();
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم إضافة الزيارة بنجاح',
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                });
            });

            // تحميل البيانات الأولية
            updateDashboard();
            renderVisitsTable();
            document.getElementById('schoolNameInput').value = appData.schoolName;
            document.getElementById('headerSchoolName').innerText = appData.schoolName;
        });

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            updateDashboard();
        }

        function saveData() {
            localStorage.setItem('eduSystemData', JSON.stringify(appData));
        }

        // --- Dashboard Logic ---
        let perfChartInstance = null;
        let trendChartInstance = null;

        function updateDashboard() {
            document.getElementById('totalVisits').innerText = appData.visits.length;
            // يمكن إضافة منطق لحساب المتميزين والأولى بالرعاية بناء على التقييمات
            
            // Chart 1: Performance (Sample Data Logic)
            const ctx1 = document.getElementById('performanceChart').getContext('2d');
            if(perfChartInstance) perfChartInstance.destroy();
            
            perfChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: appData.performance.map(p => p.dept),
                    datasets: [{
                        label: 'عدد الزيارات',
                        data: appData.performance.map(p => p.visits),
                        backgroundColor: '#1e40af',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true }
            });

            // Chart 2: Trends (Mock Data for Demo)
            const ctx2 = document.getElementById('trendChart').getContext('2d');
            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                    datasets: [{
                        label: 'مؤشر الأداء',
                        data: [65, 70, 75, 80],
                        borderColor: '#10b981',
                        tension: 0.3
                    }]
                }
            });
        }

        // --- Visits Logic ---
        function renderVisitsTable() {
            const tbody = document.getElementById('visitsTableBody');
            tbody.innerHTML = '';
            appData.visits.forEach((v, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.teacher}</td>
                    <td>${v.department}</td>
                    <td>${v.date}</td>
                    <td><span class="status-badge">${v.evaluation}</span></td>
                    <td>${v.visitor}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteVisit(${index})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteVisit(index) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "لن تتمكن من استعادة هذا السجل!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم، احذفه!'
            }).then((result) => {
                if (result.isConfirmed) {
                    appData.visits.splice(index, 1);
                    saveData();
                    renderVisitsTable();
                    updateDashboard();
                    Swal.fire('تم الحذف!', 'تم حذف الزيارة.', 'success');
                }
            })
        }

        // --- Performance Logic ---
        function renderPerformanceInputs() {
            const tbody = document.getElementById('inputPerformanceTable').querySelector('tbody');
            tbody.innerHTML = '';
            appData.performance.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.dept}</td>
                        <td><input type="number" class="form-control" value="${item.visits}" onchange="updatePerfData(${idx}, 'visits', this.value)"></td>
                        <td><input type="number" class="form-control" value="${item.exc}" onchange="updatePerfData(${idx}, 'exc', this.value)"></td>
                        <td><input type="number" class="form-control" value="${item.good}" onchange="updatePerfData(${idx}, 'good', this.value)"></td>
                        <td><input type="number" class="form-control" value="${item.part}" onchange="updatePerfData(${idx}, 'part', this.value)"></td>
                    </tr>
                `;
            });
        }

        function updatePerfData(idx, key, val) {
            appData.performance[idx][key] = parseInt(val);
        }

        function savePerformanceData() {
            saveData();
            Swal.fire('تم الحفظ', 'تم تحديث بيانات الأداء بنجاح', 'success');
            updateDashboard();
        }

        // --- Reports Logic ---
        function prepareReport() {
            document.getElementById('reportSchoolTitle').innerText = 'لمدرسة ' + appData.schoolName;
            // نسخ جدول الأداء للعرض في التقرير
            const printTable = document.getElementById('printPerformanceTable');
            printTable.innerHTML = `
                <thead>
                    <tr><th>القسم</th><th>العدد</th><th>ممتاز</th><th>جيد</th><th>مقبول</th></tr>
                </thead>
                <tbody>
                    ${appData.performance.map(p => `
                        <tr><td>${p.dept}</td><td>${p.visits}</td><td>${p.exc}</td><td>${p.good}</td><td>${p.part}</td></tr>
                    `).join('')}
                </tbody>
            `;
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // تحويل بيانات الزيارات
            const ws_visits = XLSX.utils.json_to_sheet(appData.visits);
            XLSX.utils.book_append_sheet(wb, ws_visits, "الزيارات");
            
            // تحويل بيانات الأداء
            const ws_perf = XLSX.utils.json_to_sheet(appData.performance);
            XLSX.utils.book_append_sheet(wb, ws_perf, "الأداء");

            XLSX.writeFile(wb, "تقرير_الجودة.xlsx");
        }

        // --- Utilities ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function searchTable(input, tableId) {
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        function saveSettings() {
            appData.schoolName = document.getElementById('schoolNameInput').value;
            saveData();
            document.getElementById('headerSchoolName').innerText = appData.schoolName;
            Swal.fire('تم', 'تم حفظ الإعدادات', 'success');
        }

        function clearAllData() {
            Swal.fire({
                title: 'تحذير شديد!',
                text: "سيتم مسح كافة البيانات والعودة للوضع الافتراضي.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'نعم، فورمات!'
            }).then((result) => {
                if(result.isConfirmed) {
                    localStorage.removeItem('eduSystemData');
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>
